'use strict';function ownKeys(object, enumerableOnly) {var keys = Object.keys(object);if (Object.getOwnPropertySymbols) {var symbols = Object.getOwnPropertySymbols(object);if (enumerableOnly) symbols = symbols.filter(function (sym) {return Object.getOwnPropertyDescriptor(object, sym).enumerable;});keys.push.apply(keys, symbols);}return keys;}function _objectSpread(target) {for (var i = 1; i < arguments.length; i++) {var source = arguments[i] != null ? arguments[i] : {};if (i % 2) {ownKeys(Object(source), true).forEach(function (key) {_defineProperty(target, key, source[key]);});} else if (Object.getOwnPropertyDescriptors) {Object.defineProperties(target, Object.getOwnPropertyDescriptors(source));} else {ownKeys(Object(source)).forEach(function (key) {Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key));});}}return target;}function _defineProperty(obj, key, value) {if (key in obj) {Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true });} else {obj[key] = value;}return obj;}

const WS = require('ws');
const _last = require('lodash/last');
const Bluebird = require('bluebird');
const kraken = require('node-kraken-api');
const debug = require('debug')('bfx:hf:server:exchange-clients:kraken');

const chanDataToKey = require('../../util/chan_data_to_key');
const nonce = require('../../util/nonce');

const bookTransformer = require('./transformers/book');
const candleTransformer = require('./transformers/candle');
const tickerTransformer = require('./transformers/ticker');
const tradeTransformer = require('./transformers/trade');
const chanDataToSubscription = require('./chan_data_to_subscription');
const intervalToMinutes = require('./interval_to_minutes');
const isWSChannel = require('./is_ws_channel');
const recvMessage = require('./recv/message');

const KRAKEN_WS_URL = 'wss://ws.kraken.com';
const REST_UPDATE_INTERVAL_MS = 5 * 1000;

class KrakenExchangeConnection {
  constructor() {
    this.d = debug;
    this.ws = null;
    this.subs = {};
    this.pendingSubs = {};
    this.rest = kraken();
    this.dataListeners = [];
    this.preOpenBuffer = [];
    this.channelMap = {};
    this.restSyncs = {};
    this.restSyncIntervals = {};
    this.restLastData = {};
    this.wsOpen = false;
  }

  onData(cb) {
    this.dataListeners.push(cb);
  }

  openWS(args = {}) {
    this.ws = new WS(KRAKEN_WS_URL);

    this.ws.on('open', this.onWSOpen.bind(this));
    this.ws.on('message', msgJSON => recvMessage(this, msgJSON));
    this.ws.on('error', this.onWSError.bind(this));
  }

  close() {
    if (this.ws) {
      this.ws.close();
      this.wsOpen = false;
      this.pendingSubs = {};
      this.channelMap = {};
    } else {
      debug('ws not initialized, cannot close sockets');
    }

    Object.values(this.restSyncIntervals).forEach(syncInterval => {
      clearInterval(syncInterval);
    });

    Object.values(this.restSyncs).forEach(sync => {
      sync.close();
    });

    this.restSycs = {};
    this.restSyncIntervals = {};
  }

  onWSOpen() {
    this.wsOpen = true;

    this.preOpenBuffer.forEach(msg => {
      this.ws.send(JSON.stringify(msg));
    });

    this.preOpenBuffer = [];
  }

  send(msg) {
    if (this.wsOpen) {
      this.ws.send(JSON.stringify(msg));
    } else {
      this.preOpenBuffer.push(msg);
    }
  }

  onWSError(err) {
    debug('error: %s', err.message);
  }

  async subscribeREST(channelData) {
    const cdKey = chanDataToKey(channelData);

    if (this.subs[cdKey]) {
      return this.subs[cdKey]; // return existing chanId
    }

    const [type] = channelData;
    const channelID = nonce();
    const subscription = { channelID };
    const subscriptionPayload = {};

    switch (type) {
      case 'candles':{
          subscription.name = 'OHLC';
          subscriptionPayload.pair = channelData[2].r;
          subscriptionPayload.interval = intervalToMinutes(channelData[1]);
          break;
        }

      case 'ticker':{
          subscription.name = 'Ticker';
          subscriptionPayload.pair = channelData[1].r;
          break;
        }

      case 'book':{
          subscription.name = 'Depth';
          subscriptionPayload.pair = channelData[1].r;
          subscriptionPayload.count = 25;
          break;
        }

      case 'trades':{
          subscription.name = 'Trades';
          subscriptionPayload.pair = channelData[1].r;
          break;
        }

      default:{
          debug('recv subscription req for unknown channel type: %j', channelData);
          return channelID;
        }}


    Object.assign(subscription, subscriptionPayload);

    debug('subscribing to rest channel %j', subscription);

    const syncObject = this.rest.sync(subscription.name, subscriptionPayload);

    this.subs[cdKey] = channelID;
    this.channelMap[`${channelID}`] = _objectSpread({ channelID }, subscription);
    this.restLastData[`${channelID}`] = 0;
    this.restSyncs[`${channelID}`] = syncObject;
    this.restSyncIntervals[`${channelID}`] = setInterval(() => {
      this.handleRESTUpdate(channelID, syncObject.data);
    }, REST_UPDATE_INTERVAL_MS);

    return channelID;
  }

  handleRESTUpdate(channelID, res) {
    const channel = this.channelMap[`${channelID}`];

    if (!channel) {
      return debug('recv REST data for unknown channel: %s', channelID);
    }

    const { name } = channel;
    const data = Object.values(res)[0];

    if (!data) {// could be too early for the sync worker
      return;
    }

    const payloads = [];

    switch (name) {
      case 'OHLC':{
          payloads.push(candleTransformer(data[data.length - 2], true));
          payloads.push(candleTransformer(data[data.length - 1], true));
          break;
        }

      case 'Trades':{
          let trade;
          let last;

          const trades = data.map(tradeTransformer);

          for (let i = 0; i < trades.length; i += 1) {
            trade = trades[i];
            last = this.restLastData[`${channelID}`];

            if (trade.mts >= last) {
              payloads.push(trade);
              this.restLastData[`${channelID}`] = trade.mts;
            }
          }

          break;
        }

      case 'Depth':{
          payloads.push(['full', bookTransformer(data)]);
          break;
        }

      case 'Ticker':{
          payloads.push(tickerTransformer(data));
          break;
        }

      default:{
          console.log({ channel, data });
          break;
        }}


    if (payloads.length > 0) {
      this.dataListeners.forEach(l => {
        payloads.forEach(payload => {
          l(channelID, payload);
        });
      });
    }
  }

  async subscribe(channelData) {
    if (!isWSChannel(channelData) || channelData[0] === 'book') {
      return this.subscribeREST(channelData);
    }

    const cdKey = chanDataToKey(channelData);

    if (this.subs[cdKey]) {
      return this.subs[cdKey]; // return existing chanId
    }

    const [type] = channelData;
    const subscription = chanDataToSubscription(channelData);

    if (subscription === null) {
      throw new Error(`unknown channel type: ${type}`);
    }

    const packet = {
      event: 'subscribe',
      pair: [_last(channelData).w],
      subscription };


    debug('subscribing to ws channel %j', channelData);

    this.send(packet);

    return new Bluebird(resolve => {
      this.pendingSubs[cdKey] = resolve;
    });
  }

  unsubscribe(channelData) {
    const cdKey = chanDataToKey(channelData);
    const chanID = this.subs[cdKey];

    if (!chanID) {
      throw new Error('tried to unsub from unknown channel');
    }

    debug('unsubscribing from channel %s', chanID);

    const [type] = channelData;
    const subscription = chanDataToSubscription(channelData);

    if (subscription === null) {
      throw new Error(`unknown channel type: ${type}`);
    }

    const packet = {
      event: 'unsubscribe',
      pair: [_last(channelData).w],
      subscription };


    this.send(packet);

    return chanID;
  }

  isSubscribed(channelData) {
    return !!this.getChannelID(channelData);
  }

  getChannelID(channelData) {
    const cdKey = chanDataToKey(channelData);
    return this.subs[cdKey];
  }

  getMarkets() {
    return this.rest.call('AssetPairs').then(res => {
      return Object.values(res).map(pair => ({
        u: pair.wsname || `${pair.base}/${pair.quote}`,
        r: pair.altname,
        w: pair.wsname,
        b: pair.base,
        q: pair.quote,
        c: pair.altname.match(/\.d/) ? ['d'] : ['e'] }));

    });
  }

  static getCandleTimeFrames() {
    return [
    '1m', '5m', '15m', '30m', '1h', '4h', '1d', '7d', '15d'];

  }}


KrakenExchangeConnection.id = 'kraken';

module.exports = KrakenExchangeConnection;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9leGNoYW5nZV9jbGllbnRzL2tyYWtlbi9pbmRleC5qcyJdLCJuYW1lcyI6WyJXUyIsInJlcXVpcmUiLCJfbGFzdCIsIkJsdWViaXJkIiwia3Jha2VuIiwiZGVidWciLCJjaGFuRGF0YVRvS2V5Iiwibm9uY2UiLCJib29rVHJhbnNmb3JtZXIiLCJjYW5kbGVUcmFuc2Zvcm1lciIsInRpY2tlclRyYW5zZm9ybWVyIiwidHJhZGVUcmFuc2Zvcm1lciIsImNoYW5EYXRhVG9TdWJzY3JpcHRpb24iLCJpbnRlcnZhbFRvTWludXRlcyIsImlzV1NDaGFubmVsIiwicmVjdk1lc3NhZ2UiLCJLUkFLRU5fV1NfVVJMIiwiUkVTVF9VUERBVEVfSU5URVJWQUxfTVMiLCJLcmFrZW5FeGNoYW5nZUNvbm5lY3Rpb24iLCJjb25zdHJ1Y3RvciIsImQiLCJ3cyIsInN1YnMiLCJwZW5kaW5nU3VicyIsInJlc3QiLCJkYXRhTGlzdGVuZXJzIiwicHJlT3BlbkJ1ZmZlciIsImNoYW5uZWxNYXAiLCJyZXN0U3luY3MiLCJyZXN0U3luY0ludGVydmFscyIsInJlc3RMYXN0RGF0YSIsIndzT3BlbiIsIm9uRGF0YSIsImNiIiwicHVzaCIsIm9wZW5XUyIsImFyZ3MiLCJvbiIsIm9uV1NPcGVuIiwiYmluZCIsIm1zZ0pTT04iLCJvbldTRXJyb3IiLCJjbG9zZSIsIk9iamVjdCIsInZhbHVlcyIsImZvckVhY2giLCJzeW5jSW50ZXJ2YWwiLCJjbGVhckludGVydmFsIiwic3luYyIsInJlc3RTeWNzIiwibXNnIiwic2VuZCIsIkpTT04iLCJzdHJpbmdpZnkiLCJlcnIiLCJtZXNzYWdlIiwic3Vic2NyaWJlUkVTVCIsImNoYW5uZWxEYXRhIiwiY2RLZXkiLCJ0eXBlIiwiY2hhbm5lbElEIiwic3Vic2NyaXB0aW9uIiwic3Vic2NyaXB0aW9uUGF5bG9hZCIsIm5hbWUiLCJwYWlyIiwiciIsImludGVydmFsIiwiY291bnQiLCJhc3NpZ24iLCJzeW5jT2JqZWN0Iiwic2V0SW50ZXJ2YWwiLCJoYW5kbGVSRVNUVXBkYXRlIiwiZGF0YSIsInJlcyIsImNoYW5uZWwiLCJwYXlsb2FkcyIsImxlbmd0aCIsInRyYWRlIiwibGFzdCIsInRyYWRlcyIsIm1hcCIsImkiLCJtdHMiLCJjb25zb2xlIiwibG9nIiwibCIsInBheWxvYWQiLCJzdWJzY3JpYmUiLCJFcnJvciIsInBhY2tldCIsImV2ZW50IiwidyIsInJlc29sdmUiLCJ1bnN1YnNjcmliZSIsImNoYW5JRCIsImlzU3Vic2NyaWJlZCIsImdldENoYW5uZWxJRCIsImdldE1hcmtldHMiLCJjYWxsIiwidGhlbiIsInUiLCJ3c25hbWUiLCJiYXNlIiwicXVvdGUiLCJhbHRuYW1lIiwiYiIsInEiLCJjIiwibWF0Y2giLCJnZXRDYW5kbGVUaW1lRnJhbWVzIiwiaWQiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFBQSxhOztBQUVBLE1BQU1BLEVBQUUsR0FBR0MsT0FBTyxDQUFDLElBQUQsQ0FBbEI7QUFDQSxNQUFNQyxLQUFLLEdBQUdELE9BQU8sQ0FBQyxhQUFELENBQXJCO0FBQ0EsTUFBTUUsUUFBUSxHQUFHRixPQUFPLENBQUMsVUFBRCxDQUF4QjtBQUNBLE1BQU1HLE1BQU0sR0FBR0gsT0FBTyxDQUFDLGlCQUFELENBQXRCO0FBQ0EsTUFBTUksS0FBSyxHQUFHSixPQUFPLENBQUMsT0FBRCxDQUFQLENBQWlCLHVDQUFqQixDQUFkOztBQUVBLE1BQU1LLGFBQWEsR0FBR0wsT0FBTyxDQUFDLDZCQUFELENBQTdCO0FBQ0EsTUFBTU0sS0FBSyxHQUFHTixPQUFPLENBQUMsa0JBQUQsQ0FBckI7O0FBRUEsTUFBTU8sZUFBZSxHQUFHUCxPQUFPLENBQUMscUJBQUQsQ0FBL0I7QUFDQSxNQUFNUSxpQkFBaUIsR0FBR1IsT0FBTyxDQUFDLHVCQUFELENBQWpDO0FBQ0EsTUFBTVMsaUJBQWlCLEdBQUdULE9BQU8sQ0FBQyx1QkFBRCxDQUFqQztBQUNBLE1BQU1VLGdCQUFnQixHQUFHVixPQUFPLENBQUMsc0JBQUQsQ0FB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LGFBQU85QixNQUFNLENBQUNDLE1BQVAsQ0FBYzZCLEdBQWQsRUFBbUJPLEdBQW5CLENBQXVCaEIsSUFBSSxLQUFLO0FBQ3JDb0MsUUFBQUEsQ0FBQyxFQUFFcEMsSUFBSSxDQUFDcUMsTUFBTCxJQUFnQixHQUFFckMsSUFBSSxDQUFDc0MsSUFBSyxJQUFHdEMsSUFBSSxDQUFDdUMsS0FBTSxFQURSO0FBRXJDdEMsUUFBQUEsQ0FBQyxFQUFFRCxJQUFJLENBQUN3QyxPQUY2QjtBQUdyQ2IsUUFBQUEsQ0FBQyxFQUFFM0IsSUFBSSxDQUFDcUMsTUFINkI7QUFJckNJLFFBQUFBLENBQUMsRUFBRXpDLElBQUksQ0FBQ3NDLElBSjZCO0FBS3JDSSxRQUFBQSxDQUFDLEVBQUUxQyxJQUFJLENBQUN1QyxLQUw2QjtBQU1yQ0ksUUFBQUEsQ0FBQyxFQUFFM0MsSUFBSSxDQUFDd0MsT0FBTCxDQUFhSSxLQUFiLENBQW1CLEtBQW5CLElBQTRCLENBQUMsR0FBRCxDQUE1QixHQUFvQyxDQUFDLEdBQUQsQ0FORixFQUFMLENBQTNCLENBQVA7O0FBUUQsS0FUTSxDQUFQO0FBVUQ7O0FBRUQsU0FBT0MsbUJBQVAsR0FBOEI7QUFDNUIsV0FBTztBQUNMLFFBREssRUFDQyxJQURELEVBQ08sS0FEUCxFQUNjLEtBRGQsRUFDcUIsSUFEckIsRUFDMkIsSUFEM0IsRUFDaUMsSUFEakMsRUFDdUMsSUFEdkMsRUFDNkMsS0FEN0MsQ0FBUDs7QUFHRCxHQWhTNEI7OztBQW1TL0IzRix3QkFBd0IsQ0FBQzRGLEVBQXpCLEdBQThCLFFBQTlCOztBQUVBQyxNQUFNLENBQUNDLE9BQVAsR0FBaUI5Rix3QkFBakIiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCdcblxuY29uc3QgV1MgPSByZXF1aXJlKCd3cycpXG5jb25zdCBfbGFzdCA9IHJlcXVpcmUoJ2xvZGFzaC9sYXN0JylcbmNvbnN0IEJsdWViaXJkID0gcmVxdWlyZSgnYmx1ZWJpcmQnKVxuY29uc3Qga3Jha2VuID0gcmVxdWlyZSgnbm9kZS1rcmFrZW4tYXBpJylcbmNvbnN0IGRlYnVnID0gcmVxdWlyZSgnZGVidWcnKSgnYmZ4OmhmOnNlcnZlcjpleGNoYW5nZS1jbGllbnRzOmtyYWtlbicpXG5cbmNvbnN0IGNoYW5EYXRhVG9LZXkgPSByZXF1aXJlKCcuLi8uLi91dGlsL2NoYW5fZGF0YV90b19rZXknKVxuY29uc3Qgbm9uY2UgPSByZXF1aXJlKCcuLi8uLi91dGlsL25vbmNlJylcblxuY29uc3QgYm9va1RyYW5zZm9ybWVyID0gcmVxdWlyZSgnLi90cmFuc2Zvcm1lcnMvYm9vaycpXG5jb25zdCBjYW5kbGVUcmFuc2Zvcm1lciA9IHJlcXVpcmUoJy4vdHJhbnNmb3JtZXJzL2NhbmRsZScpXG5jb25zdCB0aWNrZXJUcmFuc2Zvcm1lciA9IHJlcXVpcmUoJy4vdHJhbnNmb3JtZXJzL3RpY2tlcicpXG5jb25zdCB0cmFkZVRyYW5zZm9ybWVyID0gcmVxdWlyZSgnLi90cmFuc2Zvcm1lcnMvdHJhZGUnKVxuY29uc3QgY2hhbkRhdGFUb1N1YnNjcmlwdGlvbiA9IHJlcXVpcmUoJy4vY2hhbl9kYXRhX3RvX3N1YnNjcmlwdGlvbicpXG5jb25zdCBpbnRlcnZhbFRvTWludXRlcyA9IHJlcXVpcmUoJy4vaW50ZXJ2YWxfdG9fbWludXRlcycpXG5jb25zdCBpc1dTQ2hhbm5lbCA9IHJlcXVpcmUoJy4vaXNfd3NfY2hhbm5lbCcpXG5jb25zdCByZWN2TWVzc2FnZSA9IHJlcXVpcmUoJy4vcmVjdi9tZXNzYWdlJylcblxuY29uc3QgS1JBS0VOX1dTX1VSTCA9ICd3c3M6Ly93cy5rcmFrZW4uY29tJ1xuY29uc3QgUkVTVF9VUERBVEVfSU5URVJWQUxfTVMgPSA1ICogMTAwMFxuXG5jbGFzcyBLcmFrZW5FeGNoYW5nZUNvbm5lY3Rpb24ge1xuICBjb25zdHJ1Y3RvciAoKSB7XG4gICAgdGhpcy5kID0gZGVidWdcbiAgICB0aGlzLndzID0gbnVsbFxuICAgIHRoaXMuc3VicyA9IHt9XG4gICAgdGhpcy5wZW5kaW5nU3VicyA9IHt9XG4gICAgdGhpcy5yZXN0ID0ga3Jha2VuKClcbiAgICB0aGlzLmRhdGFMaXN0ZW5lcnMgPSBbXVxuICAgIHRoaXMucHJlT3BlbkJ1ZmZlciA9IFtdXG4gICAgdGhpcy5jaGFubmVsTWFwID0ge31cbiAgICB0aGlzLnJlc3RTeW5jcyA9IHt9XG4gICAgdGhpcy5yZXN0U3luY0ludGVydmFscyA9IHt9XG4gICAgdGhpcy5yZXN0TGFzdERhdGEgPSB7fVxuICAgIHRoaXMud3NPcGVuID0gZmFsc2VcbiAgfVxuXG4gIG9uRGF0YSAoY2IpIHtcbiAgICB0aGlzLmRhdGFMaXN0ZW5lcnMucHVzaChjYilcbiAgfVxuXG4gIG9wZW5XUyAoYXJncyA9IHt9KSB7XG4gICAgdGhpcy53cyA9IG5ldyBXUyhLUkFLRU5fV1NfVVJMKVxuXG4gICAgdGhpcy53cy5vbignb3BlbicsIHRoaXMub25XU09wZW4uYmluZCh0aGlzKSlcbiAgICB0aGlzLndzLm9uKCdtZXNzYWdlJywgKG1zZ0pTT04pID0+IHJlY3ZNZXNzYWdlKHRoaXMsIG1zZ0pTT04pKVxuICAgIHRoaXMud3Mub24oJ2Vycm9yJywgdGhpcy5vbldTRXJyb3IuYmluZCh0aGlzKSlcbiAgfVxuXG4gIGNsb3NlICgpIHtcbiAgICBpZiAodGhpcy53cykge1xuICAgICAgdGhpcy53cy5jbG9zZSgpXG4gICAgICB0aGlzLndzT3BlbiA9IGZhbHNlXG4gICAgICB0aGlzLnBlbmRpbmdTdWJzID0ge31cbiAgICAgIHRoaXMuY2hhbm5lbE1hcCA9IHt9XG4gICAgfSBlbHNlIHtcbiAgICAgIGRlYnVnKCd3cyBub3QgaW5pdGlhbGl6ZWQsIGNhbm5vdCBjbG9zZSBzb2NrZXRzJylcbiAgICB9XG5cbiAgICBPYmplY3QudmFsdWVzKHRoaXMucmVzdFN5bmNJbnRlcnZhbHMpLmZvckVhY2goKHN5bmNJbnRlcnZhbCkgPT4ge1xuICAgICAgY2xlYXJJbnRlcnZhbChzeW5jSW50ZXJ2YWwpXG4gICAgfSlcblxuICAgIE9iamVjdC52YWx1ZXModGhpcy5yZXN0U3luY3MpLmZvckVhY2goKHN5bmMpID0+IHtcbiAgICAgIHN5bmMuY2xvc2UoKVxuICAgIH0pXG5cbiAgICB0aGlzLnJlc3RTeWNzID0ge31cbiAgICB0aGlzLnJlc3RTeW5jSW50ZXJ2YWxzID0ge31cbiAgfVxuXG4gIG9uV1NPcGVuICgpIHtcbiAgICB0aGlzLndzT3BlbiA9IHRydWVcblxuICAgIHRoaXMucHJlT3BlbkJ1ZmZlci5mb3JFYWNoKG1zZyA9PiB7XG4gICAgICB0aGlzLndzLnNlbmQoSlNPTi5zdHJpbmdpZnkobXNnKSlcbiAgICB9KVxuXG4gICAgdGhpcy5wcmVPcGVuQnVmZmVyID0gW11cbiAgfVxuXG4gIHNlbmQgKG1zZykge1xuICAgIGlmICh0aGlzLndzT3Blbikge1xuICAgICAgdGhpcy53cy5zZW5kKEpTT04uc3RyaW5naWZ5KG1zZykpXG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMucHJlT3BlbkJ1ZmZlci5wdXNoKG1zZylcbiAgICB9XG4gIH1cblxuICBvbldTRXJyb3IgKGVycikge1xuICAgIGRlYnVnKCdlcnJvcjogJXMnLCBlcnIubWVzc2FnZSlcbiAgfVxuXG4gIGFzeW5jIHN1YnNjcmliZVJFU1QgKGNoYW5uZWxEYXRhKSB7XG4gICAgY29uc3QgY2RLZXkgPSBjaGFuRGF0YVRvS2V5KGNoYW5uZWxEYXRhKVxuXG4gICAgaWYgKHRoaXMuc3Vic1tjZEtleV0pIHtcbiAgICAgIHJldHVybiB0aGlzLnN1YnNbY2RLZXldIC8vIHJldHVybiBleGlzdGluZyBjaGFuSWRcbiAgICB9XG5cbiAgICBjb25zdCBbdHlwZV0gPSBjaGFubmVsRGF0YVxuICAgIGNvbnN0IGNoYW5uZWxJRCA9IG5vbmNlKClcbiAgICBjb25zdCBzdWJzY3JpcHRpb24gPSB7IGNoYW5uZWxJRCB9XG4gICAgY29uc3Qgc3Vic2NyaXB0aW9uUGF5bG9hZCA9IHt9XG5cbiAgICBzd2l0Y2ggKHR5cGUpIHtcbiAgICAgIGNhc2UgJ2NhbmRsZXMnOiB7XG4gICAgICAgIHN1YnNjcmlwdGlvbi5uYW1lID0gJ09ITEMnXG4gICAgICAgIHN1YnNjcmlwdGlvblBheWxvYWQucGFpciA9IGNoYW5uZWxEYXRhWzJdLnJcbiAgICAgICAgc3Vic2NyaXB0aW9uUGF5bG9hZC5pbnRlcnZhbCA9IGludGVydmFsVG9NaW51dGVzKGNoYW5uZWxEYXRhWzFdKVxuICAgICAgICBicmVha1xuICAgICAgfVxuXG4gICAgICBjYXNlICd0aWNrZXInOiB7XG4gICAgICAgIHN1YnNjcmlwdGlvbi5uYW1lID0gJ1RpY2tlcidcbiAgICAgICAgc3Vic2NyaXB0aW9uUGF5bG9hZC5wYWlyID0gY2hhbm5lbERhdGFbMV0uclxuICAgICAgICBicmVha1xuICAgICAgfVxuXG4gICAgICBjYXNlICdib29rJzoge1xuICAgICAgICBzdWJzY3JpcHRpb24ubmFtZSA9ICdEZXB0aCdcbiAgICAgICAgc3Vic2NyaXB0aW9uUGF5bG9hZC5wYWlyID0gY2hhbm5lbERhdGFbMV0uclxuICAgICAgICBzdWJzY3JpcHRpb25QYXlsb2FkLmNvdW50ID0gMjVcbiAgICAgICAgYnJlYWtcbiAgICAgIH1cblxuICAgICAgY2FzZSAndHJhZGVzJzoge1xuICAgICAgICBzdWJzY3JpcHRpb24ubmFtZSA9ICdUcmFkZXMnXG4gICAgICAgIHN1YnNjcmlwdGlvblBheWxvYWQucGFpciA9IGNoYW5uZWxEYXRhWzFdLnJcbiAgICAgICAgYnJlYWtcbiAgICAgIH1cblxuICAgICAgZGVmYXVsdDoge1xuICAgICAgICBkZWJ1ZygncmVjdiBzdWJzY3JpcHRpb24gcmVxIGZvciB1bmtub3duIGNoYW5uZWwgdHlwZTogJWonLCBjaGFubmVsRGF0YSlcbiAgICAgICAgcmV0dXJuIGNoYW5uZWxJRFxuICAgICAgfVxuICAgIH1cblxuICAgIE9iamVjdC5hc3NpZ24oc3Vic2NyaXB0aW9uLCBzdWJzY3JpcHRpb25QYXlsb2FkKVxuXG4gICAgZGVidWcoJ3N1YnNjcmliaW5nIHRvIHJlc3QgY2hhbm5lbCAlaicsIHN1YnNjcmlwdGlvbilcblxuICAgIGNvbnN0IHN5bmNPYmplY3QgPSB0aGlzLnJlc3Quc3luYyhzdWJzY3JpcHRpb24ubmFtZSwgc3Vic2NyaXB0aW9uUGF5bG9hZClcblxuICAgIHRoaXMuc3Vic1tjZEtleV0gPSBjaGFubmVsSURcbiAgICB0aGlzLmNoYW5uZWxNYXBbYCR7Y2hhbm5lbElEfWBdID0geyBjaGFubmVsSUQsIC4uLnN1YnNjcmlwdGlvbiB9XG4gICAgdGhpcy5yZXN0TGFzdERhdGFbYCR7Y2hhbm5lbElEfWBdID0gMFxuICAgIHRoaXMucmVzdFN5bmNzW2Ake2NoYW5uZWxJRH1gXSA9IHN5bmNPYmplY3RcbiAgICB0aGlzLnJlc3RTeW5jSW50ZXJ2YWxzW2Ake2NoYW5uZWxJRH1gXSA9IHNldEludGVydmFsKCgpID0+IHtcbiAgICAgIHRoaXMuaGFuZGxlUkVTVFVwZGF0ZShjaGFubmVsSUQsIHN5bmNPYmplY3QuZGF0YSlcbiAgICB9LCBSRVNUX1VQREFURV9JTlRFUlZBTF9NUylcblxuICAgIHJldHVybiBjaGFubmVsSURcbiAgfVxuXG4gIGhhbmRsZVJFU1RVcGRhdGUgKGNoYW5uZWxJRCwgcmVzKSB7XG4gICAgY29uc3QgY2hhbm5lbCA9IHRoaXMuY2hhbm5lbE1hcFtgJHtjaGFubmVsSUR9YF1cblxuICAgIGlmICghY2hhbm5lbCkge1xuICAgICAgcmV0dXJuIGRlYnVnKCdyZWN2IFJFU1QgZGF0YSBmb3IgdW5rbm93biBjaGFubmVsOiAlcycsIGNoYW5uZWxJRClcbiAgICB9XG5cbiAgICBjb25zdCB7IG5hbWUgfSA9IGNoYW5uZWxcbiAgICBjb25zdCBkYXRhID0gT2JqZWN0LnZhbHVlcyhyZXMpWzBdXG5cbiAgICBpZiAoIWRhdGEpIHsgLy8gY291bGQgYmUgdG9vIGVhcmx5IGZvciB0aGUgc3luYyB3b3JrZXJcbiAgICAgIHJldHVyblxuICAgIH1cblxuICAgIGNvbnN0IHBheWxvYWRzID0gW11cblxuICAgIHN3aXRjaCAobmFtZSkge1xuICAgICAgY2FzZSAnT0hMQyc6IHtcbiAgICAgICAgcGF5bG9hZHMucHVzaChjYW5kbGVUcmFuc2Zvcm1lcihkYXRhW2RhdGEubGVuZ3RoIC0gMl0sIHRydWUpKVxuICAgICAgICBwYXlsb2Fkcy5wdXNoKGNhbmRsZVRyYW5zZm9ybWVyKGRhdGFbZGF0YS5sZW5ndGggLSAxXSwgdHJ1ZSkpXG4gICAgICAgIGJyZWFrXG4gICAgICB9XG5cbiAgICAgIGNhc2UgJ1RyYWRlcyc6IHtcbiAgICAgICAgbGV0IHRyYWRlXG4gICAgICAgIGxldCBsYXN0XG5cbiAgICAgICAgY29uc3QgdHJhZGVzID0gZGF0YS5tYXAodHJhZGVUcmFuc2Zvcm1lcilcblxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRyYWRlcy5sZW5ndGg7IGkgKz0gMSkge1xuICAgICAgICAgIHRyYWRlID0gdHJhZGVzW2ldXG4gICAgICAgICAgbGFzdCA9IHRoaXMucmVzdExhc3REYXRhW2Ake2NoYW5uZWxJRH1gXVxuXG4gICAgICAgICAgaWYgKHRyYWRlLm10cyA+PSBsYXN0KSB7XG4gICAgICAgICAgICBwYXlsb2Fkcy5wdXNoKHRyYWRlKVxuICAgICAgICAgICAgdGhpcy5yZXN0TGFzdERhdGFbYCR7Y2hhbm5lbElEfWBdID0gdHJhZGUubXRzXG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgYnJlYWtcbiAgICAgIH1cblxuICAgICAgY2FzZSAnRGVwdGgnOiB7XG4gICAgICAgIHBheWxvYWRzLnB1c2goWydmdWxsJywgYm9va1RyYW5zZm9ybWVyKGRhdGEpXSlcbiAgICAgICAgYnJlYWtcbiAgICAgIH1cblxuICAgICAgY2FzZSAnVGlja2VyJzoge1xuICAgICAgICBwYXlsb2Fkcy5wdXNoKHRpY2tlclRyYW5zZm9ybWVyKGRhdGEpKVxuICAgICAgICBicmVha1xuICAgICAgfVxuXG4gICAgICBkZWZhdWx0OiB7XG4gICAgICAgIGNvbnNvbGUubG9nKHsgY2hhbm5lbCwgZGF0YSB9KVxuICAgICAgICBicmVha1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChwYXlsb2Fkcy5sZW5ndGggPiAwKSB7XG4gICAgICB0aGlzLmRhdGFMaXN0ZW5lcnMuZm9yRWFjaCgobCkgPT4ge1xuICAgICAgICBwYXlsb2Fkcy5mb3JFYWNoKChwYXlsb2FkKSA9PiB7XG4gICAgICAgICAgbChjaGFubmVsSUQsIHBheWxvYWQpXG4gICAgICAgIH0pXG4gICAgICB9KVxuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHN1YnNjcmliZSAoY2hhbm5lbERhdGEpIHtcbiAgICBpZiAoIWlzV1NDaGFubmVsKGNoYW5uZWxEYXRhKSB8fCBjaGFubmVsRGF0YVswXSA9PT0gJ2Jvb2snKSB7XG4gICAgICByZXR1cm4gdGhpcy5zdWJzY3JpYmVSRVNUKGNoYW5uZWxEYXRhKVxuICAgIH1cblxuICAgIGNvbnN0IGNkS2V5ID0gY2hhbkRhdGFUb0tleShjaGFubmVsRGF0YSlcblxuICAgIGlmICh0aGlzLnN1YnNbY2RLZXldKSB7XG4gICAgICByZXR1cm4gdGhpcy5zdWJzW2NkS2V5XSAvLyByZXR1cm4gZXhpc3RpbmcgY2hhbklkXG4gICAgfVxuXG4gICAgY29uc3QgW3R5cGVdID0gY2hhbm5lbERhdGFcbiAgICBjb25zdCBzdWJzY3JpcHRpb24gPSBjaGFuRGF0YVRvU3Vic2NyaXB0aW9uKGNoYW5uZWxEYXRhKVxuXG4gICAgaWYgKHN1YnNjcmlwdGlvbiA9PT0gbnVsbCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGB1bmtub3duIGNoYW5uZWwgdHlwZTogJHt0eXBlfWApXG4gICAgfVxuXG4gICAgY29uc3QgcGFja2V0ID0ge1xuICAgICAgZXZlbnQ6ICdzdWJzY3JpYmUnLFxuICAgICAgcGFpcjogW19sYXN0KGNoYW5uZWxEYXRhKS53XSxcbiAgICAgIHN1YnNjcmlwdGlvblxuICAgIH1cblxuICAgIGRlYnVnKCdzdWJzY3JpYmluZyB0byB3cyBjaGFubmVsICVqJywgY2hhbm5lbERhdGEpXG5cbiAgICB0aGlzLnNlbmQocGFja2V0KVxuXG4gICAgcmV0dXJuIG5ldyBCbHVlYmlyZCgocmVzb2x2ZSkgPT4ge1xuICAgICAgdGhpcy5wZW5kaW5nU3Vic1tjZEtleV0gPSByZXNvbHZlXG4gICAgfSlcbiAgfVxuXG4gIHVuc3Vic2NyaWJlIChjaGFubmVsRGF0YSkge1xuICAgIGNvbnN0IGNkS2V5ID0gY2hhbkRhdGFUb0tleShjaGFubmVsRGF0YSlcbiAgICBjb25zdCBjaGFuSUQgPSB0aGlzLnN1YnNbY2RLZXldXG5cbiAgICBpZiAoIWNoYW5JRCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCd0cmllZCB0byB1bnN1YiBmcm9tIHVua25vd24gY2hhbm5lbCcpXG4gICAgfVxuXG4gICAgZGVidWcoJ3Vuc3Vic2NyaWJpbmcgZnJvbSBjaGFubmVsICVzJywgY2hhbklEKVxuXG4gICAgY29uc3QgW3R5cGVdID0gY2hhbm5lbERhdGFcbiAgICBjb25zdCBzdWJzY3JpcHRpb24gPSBjaGFuRGF0YVRvU3Vic2NyaXB0aW9uKGNoYW5uZWxEYXRhKVxuXG4gICAgaWYgKHN1YnNjcmlwdGlvbiA9PT0gbnVsbCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGB1bmtub3duIGNoYW5uZWwgdHlwZTogJHt0eXBlfWApXG4gICAgfVxuXG4gICAgY29uc3QgcGFja2V0ID0ge1xuICAgICAgZXZlbnQ6ICd1bnN1YnNjcmliZScsXG4gICAgICBwYWlyOiBbX2xhc3QoY2hhbm5lbERhdGEpLnddLFxuICAgICAgc3Vic2NyaXB0aW9uXG4gICAgfVxuXG4gICAgdGhpcy5zZW5kKHBhY2tldClcblxuICAgIHJldHVybiBjaGFuSURcbiAgfVxuXG4gIGlzU3Vic2NyaWJlZCAoY2hhbm5lbERhdGEpIHtcbiAgICByZXR1cm4gISF0aGlzLmdldENoYW5uZWxJRChjaGFubmVsRGF0YSlcbiAgfVxuXG4gIGdldENoYW5uZWxJRCAoY2hhbm5lbERhdGEpIHtcbiAgICBjb25zdCBjZEtleSA9IGNoYW5EYXRhVG9LZXkoY2hhbm5lbERhdGEpXG4gICAgcmV0dXJuIHRoaXMuc3Vic1tjZEtleV1cbiAgfVxuXG4gIGdldE1hcmtldHMgKCkge1xuICAgIHJldHVybiB0aGlzLnJlc3QuY2FsbCgnQXNzZXRQYWlycycpLnRoZW4ocmVzID0+IHtcbiAgICAgIHJldHVybiBPYmplY3QudmFsdWVzKHJlcykubWFwKHBhaXIgPT4gKHtcbiAgICAgICAgdTogcGFpci53c25hbWUgfHwgYCR7cGFpci5iYXNlfS8ke3BhaXIucXVvdGV9YCxcbiAgICAgICAgcjogcGFpci5hbHRuYW1lLFxuICAgICAgICB3OiBwYWlyLndzbmFtZSxcbiAgICAgICAgYjogcGFpci5iYXNlLFxuICAgICAgICBxOiBwYWlyLnF1b3RlLFxuICAgICAgICBjOiBwYWlyLmFsdG5hbWUubWF0Y2goL1xcLmQvKSA/IFsnZCddIDogWydlJ11cbiAgICAgIH0pKVxuICAgIH0pXG4gIH1cblxuICBzdGF0aWMgZ2V0Q2FuZGxlVGltZUZyYW1lcyAoKSB7XG4gICAgcmV0dXJuIFtcbiAgICAgICcxbScsICc1bScsICcxNW0nLCAnMzBtJywgJzFoJywgJzRoJywgJzFkJywgJzdkJywgJzE1ZCdcbiAgICBdXG4gIH1cbn1cblxuS3Jha2VuRXhjaGFuZ2VDb25uZWN0aW9uLmlkID0gJ2tyYWtlbidcblxubW9kdWxlLmV4cG9ydHMgPSBLcmFrZW5FeGNoYW5nZUNvbm5lY3Rpb25cbiJdfQ==