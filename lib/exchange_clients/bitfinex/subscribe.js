'use strict';

const Bluebird = require('bluebird');
const _last = require('lodash/last');
const chanDataToKey = require('../../util/chan_data_to_key');
const chanDataToSubscribePacket = require('./util/chan_data_to_subscribe_packet');

module.exports = async (exa, channelData) => {
  const { d, subs, ws, pendingSubs } = exa;
  const cdKey = chanDataToKey(channelData);

  if (subs[cdKey]) {
    return subs[cdKey]; // return existing chanId
  }

  const [type] = channelData;
  const filter = chanDataToSubscribePacket(channelData);

  if (filter === null) {
    throw new Error(`unknown channel type: ${type}`);
  }

  d('subscribing to channel %j', channelData);

  const p = new Bluebird(resolve => {
    pendingSubs[cdKey] = [_last(channelData), resolve];
  });

  switch (type) {
    case 'candles':{
        ws.subscribeCandles(filter);
        break;
      }

    case 'ticker':{
        ws.subscribeTicker(filter);
        break;
      }

    case 'trades':{
        ws.subscribeTrades(filter);
        break;
      }

    case 'book':{
        ws.subscribeOrderBook(...filter);
        break;
      }

    default:{
        break;
      }}


  return p;
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9leGNoYW5nZV9jbGllbnRzL2JpdGZpbmV4L3N1YnNjcmliZS5qcyJdLCJuYW1lcyI6WyJCbHVlYmlyZCIsInJlcXVpcmUiLCJfbGFzdCIsImNoYW5EYXRhVG9LZXkiLCJjaGFuRGF0YVRvU3Vic2NyaWJlUGFja2V0IiwibW9kdWxlIiwiZXhwb3J0cyIsImV4YSIsImNoYW5uZWxEYXRhIiwiZCIsInN1YnMiLCJ3cyIsInBlbmRpbmdTdWJzIiwiY2RLZXkiLCJ0eXBlIiwiZmlsdGVyIiwiRXJyb3IiLCJwIiwicmVzb2x2ZSIsInN1YnNjcmliZUNhbmRsZXMiLCJzdWJzY3JpYmVUaWNrZXIiLCJzdWJzY3JpYmVUcmFkZXMiLCJzdWJzY3JpYmVPcmRlckJvb2siXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBLE1BQU1BLFFBQVEsR0FBR0MsT0FBTyxDQUFDLFVBQUQsQ0FBeEI7QUFDQSxNQUFNQyxLQUFLLEdBQUdELE9BQU8sQ0FBQyxhQUFELENBQXJCO0FBQ0EsTUFBTUUsYUFBYSxHQUFHRixPQUFPLENBQUMsNkJBQUQsQ0FBN0I7QUFDQSxNQUFNRyx5QkFBeUIsR0FBR0gsT0FBTyxDQUFDLHNDQUFELENBQXpDOztBQUVBSSxNQUFNLENBQUNDLE9BQVAsR0FBaUIsT0FBT0MsR0FBUCxFQUFZQyxXQUFaLEtBQTRCO0FBQzNDLFFBQU0sRUFBRUMsQ0FBRixFQUFLQyxJQUFMLEVBQVdDLEVBQVgsRUFBZUMsV0FBZixLQUErQkwsR0FBckM7QUFDQSxRQUFNTSxLQUFLLEdBQUdWLGFBQWEsQ0FBQ0ssV0FBRCxDQUEzQjs7QUFFQSxNQUFJRSxJQUFJLENBQUNHLEtBQUQsQ0FBUixFQUFpQjtBQUNmLFdBQU9ILElBQUksQ0FBQ0csS0FBRCxDQUFYLENBRGUsQ0FDSTtBQUNwQjs7QUFFRCxRQUFNLENBQUNDLElBQUQsSUFBU04sV0FBZjtBQUNBLFFBQU1PLE1BQU0sR0FBR1gseUJBQXlCLENBQUNJLFdBQUQsQ0FBeEM7O0FBRUEsTUFBSU8sTUFBTSxLQUFLLElBQWYsRUFBcUI7QUFDbkIsVUFBTSxJQUFJQyxLQUFKLENBQVcseUJBQXdCRixJQUFLLEVBQXhDLENBQU47QUFDRDs7QUFFREwsRUFBQUEsQ0FBQyxDQUFDLDJCQUFELEVBQThCRCxXQUE5QixDQUFEOztBQUVBLFFBQU1TLENBQUMsR0FBRyxJQUFJakIsUUFBSixDQUFja0IsT0FBRCxJQUFhO0FBQ2xDTixJQUFBQSxXQUFXLENBQUNDLEtBQUQsQ0FBWCxHQUFxQixDQUFDWCxLQUFLLENBQUNNLFdBQUQsQ0FBTixFQUFxQlUsT0FBckIsQ0FBckI7QUFDRCxHQUZTLENBQVY7O0FBSUEsVUFBUUosSUFBUjtBQUNFLFNBQUssU0FBTCxDQUFnQjtBQUNkSCxRQUFBQSxFQUFFLENBQUNRLGdCQUFILENBQW9CSixNQUFwQjtBQUNBO0FBQ0Q7O0FBRUQsU0FBSyxRQUFMLENBQWU7QUFDYkosUUFBQUEsRUFBRSxDQUFDUyxlQUFILENBQW1CTCxNQUFuQjtBQUNBO0FBQ0Q7O0FBRUQsU0FBSyxRQUFMLENBQWU7QUFDYkosUUFBQUEsRUFBRSxDQUFDVSxlQUFILENBQW1CTixNQUFuQjtBQUNBO0FBQ0Q7O0FBRUQsU0FBSyxNQUFMLENBQWE7QUFDWEosUUFBQUEsRUFBRSxDQUFDVyxrQkFBSCxDQUFzQixHQUFHUCxNQUF6QjtBQUNBO0FBQ0Q7O0FBRUQsWUFBUztBQUNQO0FBQ0QsT0F2Qkg7OztBQTBCQSxTQUFPRSxDQUFQO0FBQ0QsQ0FoREQiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCdcblxuY29uc3QgQmx1ZWJpcmQgPSByZXF1aXJlKCdibHVlYmlyZCcpXG5jb25zdCBfbGFzdCA9IHJlcXVpcmUoJ2xvZGFzaC9sYXN0JylcbmNvbnN0IGNoYW5EYXRhVG9LZXkgPSByZXF1aXJlKCcuLi8uLi91dGlsL2NoYW5fZGF0YV90b19rZXknKVxuY29uc3QgY2hhbkRhdGFUb1N1YnNjcmliZVBhY2tldCA9IHJlcXVpcmUoJy4vdXRpbC9jaGFuX2RhdGFfdG9fc3Vic2NyaWJlX3BhY2tldCcpXG5cbm1vZHVsZS5leHBvcnRzID0gYXN5bmMgKGV4YSwgY2hhbm5lbERhdGEpID0+IHtcbiAgY29uc3QgeyBkLCBzdWJzLCB3cywgcGVuZGluZ1N1YnMgfSA9IGV4YVxuICBjb25zdCBjZEtleSA9IGNoYW5EYXRhVG9LZXkoY2hhbm5lbERhdGEpXG5cbiAgaWYgKHN1YnNbY2RLZXldKSB7XG4gICAgcmV0dXJuIHN1YnNbY2RLZXldIC8vIHJldHVybiBleGlzdGluZyBjaGFuSWRcbiAgfVxuXG4gIGNvbnN0IFt0eXBlXSA9IGNoYW5uZWxEYXRhXG4gIGNvbnN0IGZpbHRlciA9IGNoYW5EYXRhVG9TdWJzY3JpYmVQYWNrZXQoY2hhbm5lbERhdGEpXG5cbiAgaWYgKGZpbHRlciA9PT0gbnVsbCkge1xuICAgIHRocm93IG5ldyBFcnJvcihgdW5rbm93biBjaGFubmVsIHR5cGU6ICR7dHlwZX1gKVxuICB9XG5cbiAgZCgnc3Vic2NyaWJpbmcgdG8gY2hhbm5lbCAlaicsIGNoYW5uZWxEYXRhKVxuXG4gIGNvbnN0IHAgPSBuZXcgQmx1ZWJpcmQoKHJlc29sdmUpID0+IHtcbiAgICBwZW5kaW5nU3Vic1tjZEtleV0gPSBbX2xhc3QoY2hhbm5lbERhdGEpLCByZXNvbHZlXVxuICB9KVxuXG4gIHN3aXRjaCAodHlwZSkge1xuICAgIGNhc2UgJ2NhbmRsZXMnOiB7XG4gICAgICB3cy5zdWJzY3JpYmVDYW5kbGVzKGZpbHRlcilcbiAgICAgIGJyZWFrXG4gICAgfVxuXG4gICAgY2FzZSAndGlja2VyJzoge1xuICAgICAgd3Muc3Vic2NyaWJlVGlja2VyKGZpbHRlcilcbiAgICAgIGJyZWFrXG4gICAgfVxuXG4gICAgY2FzZSAndHJhZGVzJzoge1xuICAgICAgd3Muc3Vic2NyaWJlVHJhZGVzKGZpbHRlcilcbiAgICAgIGJyZWFrXG4gICAgfVxuXG4gICAgY2FzZSAnYm9vayc6IHtcbiAgICAgIHdzLnN1YnNjcmliZU9yZGVyQm9vayguLi5maWx0ZXIpXG4gICAgICBicmVha1xuICAgIH1cblxuICAgIGRlZmF1bHQ6IHtcbiAgICAgIGJyZWFrXG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHBcbn1cbiJdfQ==