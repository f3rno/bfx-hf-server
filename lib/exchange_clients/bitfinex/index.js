'use strict';function ownKeys(object, enumerableOnly) {var keys = Object.keys(object);if (Object.getOwnPropertySymbols) {var symbols = Object.getOwnPropertySymbols(object);if (enumerableOnly) symbols = symbols.filter(function (sym) {return Object.getOwnPropertyDescriptor(object, sym).enumerable;});keys.push.apply(keys, symbols);}return keys;}function _objectSpread(target) {for (var i = 1; i < arguments.length; i++) {var source = arguments[i] != null ? arguments[i] : {};if (i % 2) {ownKeys(Object(source), true).forEach(function (key) {_defineProperty(target, key, source[key]);});} else if (Object.getOwnPropertyDescriptors) {Object.defineProperties(target, Object.getOwnPropertyDescriptors(source));} else {ownKeys(Object(source)).forEach(function (key) {Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key));});}}return target;}function _defineProperty(obj, key, value) {if (key in obj) {Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true });} else {obj[key] = value;}return obj;}

const Bluebird = require('bluebird');
const _isFunction = require('lodash/isFunction');
const PromiseThrottle = require('promise-throttle');
const { WS2Manager } = require('bitfinex-api-node');
const { RESTv2 } = require('bfx-api-node-rest');
const debug = require('debug')('bfx:hf:server:exchange-clients:bitfinex');

const chanDataToKey = require('../../util/chan_data_to_key');

const orderTransformer = require('./transformers/order');
const balanceTransformer = require('./transformers/balance');
const candleTransformer = require('./transformers/candle');

const recvMessage = require('./recv/message');
const getMarkets = require('./get_markets');
const unsubscribe = require('./unsubscribe');
const subscribe = require('./subscribe');

class BitfinexEchangeConnection {
  constructor() {
    this.d = debug;
    this.ws = null;
    this.rest = new RESTv2();
    this.channelMap = {};
    this.subs = {}; // { [cdKey]: chanId }
    this.pendingSubs = {}; //
    this.dataListeners = [];
    this.books = {};
    this.lastBookPacketSent = {};
    this.authArgs = {};
  }

  setDMS(dms) {
    this.setAuthArgs({
      dms: dms ? 4 : 0 });

  }

  setAuthArgs(args) {
    this.authArgs = _objectSpread({},
    this.authArgs, {},
    args);


    if (this.ws) {
      this.ws.setAuthArgs(this.authArgs);
    }
  }

  reconnect() {
    this.ws.reconnect();
  }

  openWS(args = {}) {
    this.ws = new WS2Manager(_objectSpread({
      autoReconnect: true,
      reconnectDelay: 10 * 1000 },
    args),
    this.authArgs);

    this.ws.on('message', msg => recvMessage(this, msg));
    this.ws.on('error', this.onWSError.bind(this));
    this.ws.on('auth', this.onWSAuth.bind(this));
  }

  onWSAuth() {
    this.channelMap['0'] = { channel: 'auth' };
  }

  openSocket() {
    if (this.ws) {
      this.ws.openSocket();
    } else {
      debug('ws not initialized, cannot open socket');
    }
  }

  close() {
    if (this.ws) {
      this.ws.close();
    } else {
      debug('ws not initialized, cannot close sockets');
    }
  }

  on(event, handler) {
    if (this.ws) {
      this.ws.on(event, handler);
    } else {
      debug('ws not initialized, cannot assign event handler');
    }
  }

  onData(cb) {
    this.dataListeners.push(cb);
  }

  async submitOrder(packet) {
    const socket = this.ws.getAuthenticatedSocket();
    return socket.ws.submitOrder(packet);
  }

  async cancelOrder(id) {
    const socket = this.ws.getAuthenticatedSocket();
    return socket.ws.cancelOrder(id);
  }

  onWSError(err) {
    debug('error: %s', err.message);
  }

  async subscribe(channelData) {
    return subscribe(this, channelData);
  }

  unsubscribe(channelData) {
    return unsubscribe(this, channelData);
  }

  isSubscribed(channelData) {
    return !!this.getChannelID(channelData);
  }

  getChannelID(channelData) {
    const cdKey = chanDataToKey(channelData);
    return this.subs[cdKey];
  }

  getChannelData(chanID) {
    return this.channelMap[`${chanID}`];
  }

  getMarkets() {
    return getMarkets();
  }

  static getCandleTimeFrames() {
    return [
    '1m', '5m', '15m', '30m', '1h', '3h', '6h', '12h', '1D', '7D', '14D', '1M'];

  }

  static transformCandle(candle) {
    return candleTransformer(candle);
  }

  static transformBalance(balance) {
    return balanceTransformer(balance);
  }

  static transformBalances(balances) {
    return balances.map(balanceTransformer);
  }

  static transformOrder(order) {
    return orderTransformer(order);
  }

  static transformOrders(orders) {
    return orders.map(orderTransformer);
  }

  static getWSThrottler() {
    return new PromiseThrottle({
      requestsPerSecond: 100 / 60.0,
      promiseImplementation: Bluebird });

  }

  static async registerUIDefs(algoOrders, rest) {
    const timeframes = BitfinexEchangeConnection.getCandleTimeFrames();
    const aoUIDefs = algoOrders.filter(ao => {
      const { meta = {} } = ao;
      const { getUIDef } = meta;

      return _isFunction(getUIDef);
    }).map(ao => {
      const { meta = {} } = ao;
      const { getUIDef } = meta;
      const { id } = ao;

      return {
        id,
        uiDef: getUIDef({ timeframes }) };

    });

    const AO_SETTINGS_KEY = 'api:bitfinex_algorithmic_orders';

    debug(
    'overwriting algo order UI definition user settings (key %s)',
    AO_SETTINGS_KEY);


    const res = await rest.getSettings([AO_SETTINGS_KEY]);
    const [keyResult = []] = res;
    const [, aoSettings = {}] = keyResult;

    aoUIDefs.forEach(({ id, uiDef }) => {
      debug('setting UI def for %s', id);
      aoSettings[id] = uiDef;
    });

    await rest.updateSettings({ [AO_SETTINGS_KEY]: aoSettings });

    debug('all UIs registered!');
  }}


BitfinexEchangeConnection.id = 'bitfinex';

module.exports = BitfinexEchangeConnection;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9leGNoYW5nZV9jbGllbnRzL2JpdGZpbmV4L2luZGV4LmpzIl0sIm5hbWVzIjpbIkJsdWViaXJkIiwicmVxdWlyZSIsIl9pc0Z1bmN0aW9uIiwiUHJvbWlzZVRocm90dGxlIiwiV1MyTWFuYWdlciIsIlJFU1R2MiIsImRlYnVnIiwiY2hhbkRhdGFUb0tleSIsIm9yZGVyVHJhbnNmb3JtZXIiLCJiYWxhbmNlVHJhbnNmb3JtZXIiLCJjYW5kbGVUcmFuc2Zvcm1lciIsInJlY3ZNZXNzYWdlIiwiZ2V0TWFya2V0cyIsInVuc3Vic2NyaWJlIiwic3Vic2NyaWJlIiwiQml0ZmluZXhFY2hhbmdlQ29ubmVjdGlvbiIsImNvbnN0cnVjdG9yIiwiZCIsIndzIiwicmVzdCIsImNoYW5uZWxNYXAiLCJzdWJzIiwicGVuZGluZ1N1YnMiLCJkYXRhTGlzdGVuZXJzIiwiYm9va3MiLCJsYXN0Qm9va1BhY2tldFNlbnQiLCJhdXRoQXJncyIsInNldERNUyIsImRtcyIsInNldEF1dGhBcmdzIiwiYXJncyIsInJlY29ubmVjdCIsIm9wZW5XUyIsImF1dG9SZWNvbm5lY3QiLCJyZWNvbm5lY3REZWxheSIsIm9uIiwibXNnIiwib25XU0Vycm9yIiwiYmluZCIsIm9uV1NBdXRoIiwiY2hhbm5lbCIsIm9wZW5Tb2NrZXQiLCJjbG9zZSIsImV2ZW50IiwiaGFuZGxlciIsIm9uRGF0YSIsImNiIiwicHVzaCIsInN1Ym1pdE9yZGVyIiwicGFja2V0Iiwic29ja2V0IiwiZ2V0QXV0aGVudGljYXRlZFNvY2tldCIsImNhbmNlbE9yZGVyIiwiaWQiLCJlcnIiLCJtZXNzYWdlIiwiY2hhbm5lbERhdGEiLCJpc1N1YnNjcmliZWQiLCJnZXRDaGFubmVsSUQiLCJjZEtleSIsImdldENoYW5uZWxEYXRhIiwiY2hhbklEIiwiZ2V0Q2FuZGxlVGltZUZyYW1lcyIsInRyYW5zZm9ybUNhbmRsZSIsImNhbmRsZSIsInRyYW5zZm9ybUJhbGFuY2UiLCJiYWxhbmNlIiwidHJhbnNmb3JtQmFsYW5jZXMiLCJiYWxhbmNlcyIsIm1hcCIsInRyYW5zZm9ybU9yZGVyIiwib3JkZXIiLCJ0cmFuc2Zvcm1PcmRlcnMiLCJvcmRlcnMiLCJnZXRXU1Rocm90dGxlciIsInJlcXVlc3RzUGVyU2Vjb25kIiwicHJvbWlzZUltcGxlbWVudGF0aW9uIiwicmVnaXN0ZXJVSURlZnMiLCJhbGdvT3JkZXJzIiwidGltZWZyYW1lcyIsImFvVUlEZWZzIiwiZmlsdGVyIiwiYW8iLCJtZXRhIiwiZ2V0VUlEZWYiLCJ1aURlZiIsIkFPX1NFVFRJTkdTX0tFWSIsInJlcyIsImdldFNldHRpbmdzIiwia2V5UmVzdWx0IiwiYW9TZXR0aW5ncyIsImZvckVhY2giLCJ1cGRhdGVTZXR0aW5ncyIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBLGE7O0FBRUEsTUFBTUEsUUFBUSxHQUFHQyxPQUFPLENBQUMsVUFBRCxDQUF4QjtBQUNBLE1BQU1DLFdBQVcsR0FBR0QsT0FBTyxDQUFDLG1CQUFELENBQTNCO0FBQ0EsTUFBTUUsZUFBZSxHQUFHRixPQUFPLENBQUMsa0JBQUQsQ0FBL0I7QUFDQSxNQUFNLEVBQUVHLFVBQUYsS0FBaUJILE9BQU8sQ0FBQyxtQkFBRCxDQUE5QjtBQUNBLE1BQU0sRUFBRUksTUFBRixLQUFhSixPQUFPLENBQUMsbUJBQUQsQ0FBMUI7QUFDQSxNQUFNSyxLQUFLLEdBQUdMLE9BQU8sQ0FBQyxPQUFELENBQVAsQ0FBaUIseUNBQWpCLENBQWQ7O0FBRUEsTUFBTU0sYUFBYSxHQUFHTixPQUFPLENBQUMsNkJBQUQsQ0FBN0I7O0FBRUEsTUFBTU8sZ0JBQWdCLEdBQUdQLE9BQU8sQ0FBQyxzQkFBRCxDQUFoQztBQUNBLE1BQU1RLGtCQUFrQixHQUFHUixPQUFPLENBQUMsd0JBQUQsQ0FBbEM7QUFDQSxNQUFNUyxpQkFBaUIsR0FBR1QsT0FBTyxDQUFDLHVCQUFELENBQWpDOztBQUVBLE1BQU1VLFdBQVcsR0FBR1YsT0FBTyxDQUFDLGdCQUFELENBQTNCO0FBQ0EsTUFBTVcsVUFB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akI7QUFDRCxLQUhEOztBQUtBLFVBQU1sRSxJQUFJLENBQUN5RSxjQUFMLENBQW9CLEVBQUUsQ0FBQ04sZUFBRCxHQUFtQkksVUFBckIsRUFBcEIsQ0FBTjs7QUFFQXBGLElBQUFBLEtBQUssQ0FBQyxxQkFBRCxDQUFMO0FBQ0QsR0E1TDZCOzs7QUErTGhDUyx5QkFBeUIsQ0FBQ3NDLEVBQTFCLEdBQStCLFVBQS9COztBQUVBd0MsTUFBTSxDQUFDQyxPQUFQLEdBQWlCL0UseUJBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnXG5cbmNvbnN0IEJsdWViaXJkID0gcmVxdWlyZSgnYmx1ZWJpcmQnKVxuY29uc3QgX2lzRnVuY3Rpb24gPSByZXF1aXJlKCdsb2Rhc2gvaXNGdW5jdGlvbicpXG5jb25zdCBQcm9taXNlVGhyb3R0bGUgPSByZXF1aXJlKCdwcm9taXNlLXRocm90dGxlJylcbmNvbnN0IHsgV1MyTWFuYWdlciB9ID0gcmVxdWlyZSgnYml0ZmluZXgtYXBpLW5vZGUnKVxuY29uc3QgeyBSRVNUdjIgfSA9IHJlcXVpcmUoJ2JmeC1hcGktbm9kZS1yZXN0JylcbmNvbnN0IGRlYnVnID0gcmVxdWlyZSgnZGVidWcnKSgnYmZ4OmhmOnNlcnZlcjpleGNoYW5nZS1jbGllbnRzOmJpdGZpbmV4JylcblxuY29uc3QgY2hhbkRhdGFUb0tleSA9IHJlcXVpcmUoJy4uLy4uL3V0aWwvY2hhbl9kYXRhX3RvX2tleScpXG5cbmNvbnN0IG9yZGVyVHJhbnNmb3JtZXIgPSByZXF1aXJlKCcuL3RyYW5zZm9ybWVycy9vcmRlcicpXG5jb25zdCBiYWxhbmNlVHJhbnNmb3JtZXIgPSByZXF1aXJlKCcuL3RyYW5zZm9ybWVycy9iYWxhbmNlJylcbmNvbnN0IGNhbmRsZVRyYW5zZm9ybWVyID0gcmVxdWlyZSgnLi90cmFuc2Zvcm1lcnMvY2FuZGxlJylcblxuY29uc3QgcmVjdk1lc3NhZ2UgPSByZXF1aXJlKCcuL3JlY3YvbWVzc2FnZScpXG5jb25zdCBnZXRNYXJrZXRzID0gcmVxdWlyZSgnLi9nZXRfbWFya2V0cycpXG5jb25zdCB1bnN1YnNjcmliZSA9IHJlcXVpcmUoJy4vdW5zdWJzY3JpYmUnKVxuY29uc3Qgc3Vic2NyaWJlID0gcmVxdWlyZSgnLi9zdWJzY3JpYmUnKVxuXG5jbGFzcyBCaXRmaW5leEVjaGFuZ2VDb25uZWN0aW9uIHtcbiAgY29uc3RydWN0b3IgKCkge1xuICAgIHRoaXMuZCA9IGRlYnVnXG4gICAgdGhpcy53cyA9IG51bGxcbiAgICB0aGlzLnJlc3QgPSBuZXcgUkVTVHYyKClcbiAgICB0aGlzLmNoYW5uZWxNYXAgPSB7fVxuICAgIHRoaXMuc3VicyA9IHt9IC8vIHsgW2NkS2V5XTogY2hhbklkIH1cbiAgICB0aGlzLnBlbmRpbmdTdWJzID0ge30gLy9cbiAgICB0aGlzLmRhdGFMaXN0ZW5lcnMgPSBbXVxuICAgIHRoaXMuYm9va3MgPSB7fVxuICAgIHRoaXMubGFzdEJvb2tQYWNrZXRTZW50ID0ge31cbiAgICB0aGlzLmF1dGhBcmdzID0ge31cbiAgfVxuXG4gIHNldERNUyAoZG1zKSB7XG4gICAgdGhpcy5zZXRBdXRoQXJncyh7XG4gICAgICBkbXM6IGRtcyA/IDQgOiAwXG4gICAgfSlcbiAgfVxuXG4gIHNldEF1dGhBcmdzIChhcmdzKSB7XG4gICAgdGhpcy5hdXRoQXJncyA9IHtcbiAgICAgIC4uLnRoaXMuYXV0aEFyZ3MsXG4gICAgICAuLi5hcmdzXG4gICAgfVxuXG4gICAgaWYgKHRoaXMud3MpIHtcbiAgICAgIHRoaXMud3Muc2V0QXV0aEFyZ3ModGhpcy5hdXRoQXJncylcbiAgICB9XG4gIH1cblxuICByZWNvbm5lY3QgKCkge1xuICAgIHRoaXMud3MucmVjb25uZWN0KClcbiAgfVxuXG4gIG9wZW5XUyAoYXJncyA9IHt9KSB7XG4gICAgdGhpcy53cyA9IG5ldyBXUzJNYW5hZ2VyKHtcbiAgICAgIGF1dG9SZWNvbm5lY3Q6IHRydWUsXG4gICAgICByZWNvbm5lY3REZWxheTogMTAgKiAxMDAwLFxuICAgICAgLi4uYXJnc1xuICAgIH0sIHRoaXMuYXV0aEFyZ3MpXG5cbiAgICB0aGlzLndzLm9uKCdtZXNzYWdlJywgKG1zZykgPT4gcmVjdk1lc3NhZ2UodGhpcywgbXNnKSlcbiAgICB0aGlzLndzLm9uKCdlcnJvcicsIHRoaXMub25XU0Vycm9yLmJpbmQodGhpcykpXG4gICAgdGhpcy53cy5vbignYXV0aCcsIHRoaXMub25XU0F1dGguYmluZCh0aGlzKSlcbiAgfVxuXG4gIG9uV1NBdXRoICgpIHtcbiAgICB0aGlzLmNoYW5uZWxNYXBbJzAnXSA9IHsgY2hhbm5lbDogJ2F1dGgnIH1cbiAgfVxuXG4gIG9wZW5Tb2NrZXQgKCkge1xuICAgIGlmICh0aGlzLndzKSB7XG4gICAgICB0aGlzLndzLm9wZW5Tb2NrZXQoKVxuICAgIH0gZWxzZSB7XG4gICAgICBkZWJ1Zygnd3Mgbm90IGluaXRpYWxpemVkLCBjYW5ub3Qgb3BlbiBzb2NrZXQnKVxuICAgIH1cbiAgfVxuXG4gIGNsb3NlICgpIHtcbiAgICBpZiAodGhpcy53cykge1xuICAgICAgdGhpcy53cy5jbG9zZSgpXG4gICAgfSBlbHNlIHtcbiAgICAgIGRlYnVnKCd3cyBub3QgaW5pdGlhbGl6ZWQsIGNhbm5vdCBjbG9zZSBzb2NrZXRzJylcbiAgICB9XG4gIH1cblxuICBvbiAoZXZlbnQsIGhhbmRsZXIpIHtcbiAgICBpZiAodGhpcy53cykge1xuICAgICAgdGhpcy53cy5vbihldmVudCwgaGFuZGxlcilcbiAgICB9IGVsc2Uge1xuICAgICAgZGVidWcoJ3dzIG5vdCBpbml0aWFsaXplZCwgY2Fubm90IGFzc2lnbiBldmVudCBoYW5kbGVyJylcbiAgICB9XG4gIH1cblxuICBvbkRhdGEgKGNiKSB7XG4gICAgdGhpcy5kYXRhTGlzdGVuZXJzLnB1c2goY2IpXG4gIH1cblxuICBhc3luYyBzdWJtaXRPcmRlciAocGFja2V0KSB7XG4gICAgY29uc3Qgc29ja2V0ID0gdGhpcy53cy5nZXRBdXRoZW50aWNhdGVkU29ja2V0KClcbiAgICByZXR1cm4gc29ja2V0LndzLnN1Ym1pdE9yZGVyKHBhY2tldClcbiAgfVxuXG4gIGFzeW5jIGNhbmNlbE9yZGVyIChpZCkge1xuICAgIGNvbnN0IHNvY2tldCA9IHRoaXMud3MuZ2V0QXV0aGVudGljYXRlZFNvY2tldCgpXG4gICAgcmV0dXJuIHNvY2tldC53cy5jYW5jZWxPcmRlcihpZClcbiAgfVxuXG4gIG9uV1NFcnJvciAoZXJyKSB7XG4gICAgZGVidWcoJ2Vycm9yOiAlcycsIGVyci5tZXNzYWdlKVxuICB9XG5cbiAgYXN5bmMgc3Vic2NyaWJlIChjaGFubmVsRGF0YSkge1xuICAgIHJldHVybiBzdWJzY3JpYmUodGhpcywgY2hhbm5lbERhdGEpXG4gIH1cblxuICB1bnN1YnNjcmliZSAoY2hhbm5lbERhdGEpIHtcbiAgICByZXR1cm4gdW5zdWJzY3JpYmUodGhpcywgY2hhbm5lbERhdGEpXG4gIH1cblxuICBpc1N1YnNjcmliZWQgKGNoYW5uZWxEYXRhKSB7XG4gICAgcmV0dXJuICEhdGhpcy5nZXRDaGFubmVsSUQoY2hhbm5lbERhdGEpXG4gIH1cblxuICBnZXRDaGFubmVsSUQgKGNoYW5uZWxEYXRhKSB7XG4gICAgY29uc3QgY2RLZXkgPSBjaGFuRGF0YVRvS2V5KGNoYW5uZWxEYXRhKVxuICAgIHJldHVybiB0aGlzLnN1YnNbY2RLZXldXG4gIH1cblxuICBnZXRDaGFubmVsRGF0YSAoY2hhbklEKSB7XG4gICAgcmV0dXJuIHRoaXMuY2hhbm5lbE1hcFtgJHtjaGFuSUR9YF1cbiAgfVxuXG4gIGdldE1hcmtldHMgKCkge1xuICAgIHJldHVybiBnZXRNYXJrZXRzKClcbiAgfVxuXG4gIHN0YXRpYyBnZXRDYW5kbGVUaW1lRnJhbWVzICgpIHtcbiAgICByZXR1cm4gW1xuICAgICAgJzFtJywgJzVtJywgJzE1bScsICczMG0nLCAnMWgnLCAnM2gnLCAnNmgnLCAnMTJoJywgJzFEJywgJzdEJywgJzE0RCcsICcxTSdcbiAgICBdXG4gIH1cblxuICBzdGF0aWMgdHJhbnNmb3JtQ2FuZGxlIChjYW5kbGUpIHtcbiAgICByZXR1cm4gY2FuZGxlVHJhbnNmb3JtZXIoY2FuZGxlKVxuICB9XG5cbiAgc3RhdGljIHRyYW5zZm9ybUJhbGFuY2UgKGJhbGFuY2UpIHtcbiAgICByZXR1cm4gYmFsYW5jZVRyYW5zZm9ybWVyKGJhbGFuY2UpXG4gIH1cblxuICBzdGF0aWMgdHJhbnNmb3JtQmFsYW5jZXMgKGJhbGFuY2VzKSB7XG4gICAgcmV0dXJuIGJhbGFuY2VzLm1hcChiYWxhbmNlVHJhbnNmb3JtZXIpXG4gIH1cblxuICBzdGF0aWMgdHJhbnNmb3JtT3JkZXIgKG9yZGVyKSB7XG4gICAgcmV0dXJuIG9yZGVyVHJhbnNmb3JtZXIob3JkZXIpXG4gIH1cblxuICBzdGF0aWMgdHJhbnNmb3JtT3JkZXJzIChvcmRlcnMpIHtcbiAgICByZXR1cm4gb3JkZXJzLm1hcChvcmRlclRyYW5zZm9ybWVyKVxuICB9XG5cbiAgc3RhdGljIGdldFdTVGhyb3R0bGVyICgpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2VUaHJvdHRsZSh7XG4gICAgICByZXF1ZXN0c1BlclNlY29uZDogMTAwIC8gNjAuMCxcbiAgICAgIHByb21pc2VJbXBsZW1lbnRhdGlvbjogQmx1ZWJpcmRcbiAgICB9KVxuICB9XG5cbiAgc3RhdGljIGFzeW5jIHJlZ2lzdGVyVUlEZWZzIChhbGdvT3JkZXJzLCByZXN0KSB7XG4gICAgY29uc3QgdGltZWZyYW1lcyA9IEJpdGZpbmV4RWNoYW5nZUNvbm5lY3Rpb24uZ2V0Q2FuZGxlVGltZUZyYW1lcygpXG4gICAgY29uc3QgYW9VSURlZnMgPSBhbGdvT3JkZXJzLmZpbHRlcigoYW8pID0+IHtcbiAgICAgIGNvbnN0IHsgbWV0YSA9IHt9IH0gPSBhb1xuICAgICAgY29uc3QgeyBnZXRVSURlZiB9ID0gbWV0YVxuXG4gICAgICByZXR1cm4gX2lzRnVuY3Rpb24oZ2V0VUlEZWYpXG4gICAgfSkubWFwKChhbykgPT4ge1xuICAgICAgY29uc3QgeyBtZXRhID0ge30gfSA9IGFvXG4gICAgICBjb25zdCB7IGdldFVJRGVmIH0gPSBtZXRhXG4gICAgICBjb25zdCB7IGlkIH0gPSBhb1xuXG4gICAgICByZXR1cm4ge1xuICAgICAgICBpZCxcbiAgICAgICAgdWlEZWY6IGdldFVJRGVmKHsgdGltZWZyYW1lcyB9KVxuICAgICAgfVxuICAgIH0pXG5cbiAgICBjb25zdCBBT19TRVRUSU5HU19LRVkgPSAnYXBpOmJpdGZpbmV4X2FsZ29yaXRobWljX29yZGVycydcblxuICAgIGRlYnVnKFxuICAgICAgJ292ZXJ3cml0aW5nIGFsZ28gb3JkZXIgVUkgZGVmaW5pdGlvbiB1c2VyIHNldHRpbmdzIChrZXkgJXMpJyxcbiAgICAgIEFPX1NFVFRJTkdTX0tFWVxuICAgIClcblxuICAgIGNvbnN0IHJlcyA9IGF3YWl0IHJlc3QuZ2V0U2V0dGluZ3MoW0FPX1NFVFRJTkdTX0tFWV0pXG4gICAgY29uc3QgW2tleVJlc3VsdCA9IFtdXSA9IHJlc1xuICAgIGNvbnN0IFssIGFvU2V0dGluZ3MgPSB7fV0gPSBrZXlSZXN1bHRcblxuICAgIGFvVUlEZWZzLmZvckVhY2goKHsgaWQsIHVpRGVmIH0pID0+IHtcbiAgICAgIGRlYnVnKCdzZXR0aW5nIFVJIGRlZiBmb3IgJXMnLCBpZClcbiAgICAgIGFvU2V0dGluZ3NbaWRdID0gdWlEZWZcbiAgICB9KVxuXG4gICAgYXdhaXQgcmVzdC51cGRhdGVTZXR0aW5ncyh7IFtBT19TRVRUSU5HU19LRVldOiBhb1NldHRpbmdzIH0pXG5cbiAgICBkZWJ1ZygnYWxsIFVJcyByZWdpc3RlcmVkIScpXG4gIH1cbn1cblxuQml0ZmluZXhFY2hhbmdlQ29ubmVjdGlvbi5pZCA9ICdiaXRmaW5leCdcblxubW9kdWxlLmV4cG9ydHMgPSBCaXRmaW5leEVjaGFuZ2VDb25uZWN0aW9uXG4iXX0=