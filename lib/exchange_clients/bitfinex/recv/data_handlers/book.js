'use strict';

const _last = require('lodash/last');
const _isArray = require('lodash/isArray');
const { OrderBook } = require('bfx-api-node-models');
const bookTransformer = require('../../transformers/book');

const BOOK_PACKET_SEND_INTERVAL_MS = 1000;

module.exports = (exa, msg, channel) => {
  const { books, lastBookPacketSent } = exa;

  if (_isArray(_last(msg)[0])) {
    books[channel.symbol] = _last(msg);
  } else {
    OrderBook.updateArrayOBWith(books[channel.symbol], _last(msg));
  }

  const lastSend = lastBookPacketSent[channel.symbol];

  if (!lastSend || Date.now() > lastSend + BOOK_PACKET_SEND_INTERVAL_MS) {
    lastBookPacketSent[channel.symbol] = Date.now();

    return [['full', bookTransformer(books[channel.symbol])]];
  }

  return [];
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9leGNoYW5nZV9jbGllbnRzL2JpdGZpbmV4L3JlY3YvZGF0YV9oYW5kbGVycy9ib29rLmpzIl0sIm5hbWVzIjpbIl9sYXN0IiwicmVxdWlyZSIsIl9pc0FycmF5IiwiT3JkZXJCb29rIiwiYm9va1RyYW5zZm9ybWVyIiwiQk9PS19QQUNLRVRfU0VORF9JTlRFUlZBTF9NUyIsIm1vZHVsZSIsImV4cG9ydHMiLCJleGEiLCJtc2ciLCJjaGFubmVsIiwiYm9va3MiLCJsYXN0Qm9va1BhY2tldFNlbnQiLCJzeW1ib2wiLCJ1cGRhdGVBcnJheU9CV2l0aCIsImxhc3RTZW5kIiwiRGF0ZSIsIm5vdyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUEsTUFBTUEsS0FBSyxHQUFHQyxPQUFPLENBQUMsYUFBRCxDQUFyQjtBQUNBLE1BQU1DLFFBQVEsR0FBR0QsT0FBTyxDQUFDLGdCQUFELENBQXhCO0FBQ0EsTUFBTSxFQUFFRSxTQUFGLEtBQWdCRixPQUFPLENBQUMscUJBQUQsQ0FBN0I7QUFDQSxNQUFNRyxlQUFlLEdBQUdILE9BQU8sQ0FBQyx5QkFBRCxDQUEvQjs7QUFFQSxNQUFNSSw0QkFBNEIsR0FBRyxJQUFyQzs7QUFFQUMsTUFBTSxDQUFDQyxPQUFQLEdBQWlCLENBQUNDLEdBQUQsRUFBTUMsR0FBTixFQUFXQyxPQUFYLEtBQXVCO0FBQ3RDLFFBQU0sRUFBRUMsS0FBRixFQUFTQyxrQkFBVCxLQUFnQ0osR0FBdEM7O0FBRUEsTUFBSU4sUUFBUSxDQUFDRixLQUFLLENBQUNTLEdBQUQsQ0FBTCxDQUFXLENBQVgsQ0FBRCxDQUFaLEVBQTZCO0FBQzNCRSxJQUFBQSxLQUFLLENBQUNELE9BQU8sQ0FBQ0csTUFBVCxDQUFMLEdBQXdCYixLQUFLLENBQUNTLEdBQUQsQ0FBN0I7QUFDRCxHQUZELE1BRU87QUFDTE4sSUFBQUEsU0FBUyxDQUFDVyxpQkFBVixDQUE0QkgsS0FBSyxDQUFDRCxPQUFPLENBQUNHLE1BQVQsQ0FBakMsRUFBbURiLEtBQUssQ0FBQ1MsR0FBRCxDQUF4RDtBQUNEOztBQUVELFFBQU1NLFFBQVEsR0FBR0gsa0JBQWtCLENBQUNGLE9BQU8sQ0FBQ0csTUFBVCxDQUFuQzs7QUFFQSxNQUFJLENBQUNFLFFBQUQsSUFBYUMsSUFBSSxDQUFDQyxHQUFMLEtBQWFGLFFBQVEsR0FBR1YsNEJBQXpDLEVBQXVFO0FBQ3JFTyxJQUFBQSxrQkFBa0IsQ0FBQ0YsT0FBTyxDQUFDRyxNQUFULENBQWxCLEdBQXFDRyxJQUFJLENBQUNDLEdBQUwsRUFBckM7O0FBRUEsV0FBTyxDQUFDLENBQUMsTUFBRCxFQUFTYixlQUFlLENBQUNPLEtBQUssQ0FBQ0QsT0FBTyxDQUFDRyxNQUFULENBQU4sQ0FBeEIsQ0FBRCxDQUFQO0FBQ0Q7O0FBRUQsU0FBTyxFQUFQO0FBQ0QsQ0FsQkQiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCdcblxuY29uc3QgX2xhc3QgPSByZXF1aXJlKCdsb2Rhc2gvbGFzdCcpXG5jb25zdCBfaXNBcnJheSA9IHJlcXVpcmUoJ2xvZGFzaC9pc0FycmF5JylcbmNvbnN0IHsgT3JkZXJCb29rIH0gPSByZXF1aXJlKCdiZngtYXBpLW5vZGUtbW9kZWxzJylcbmNvbnN0IGJvb2tUcmFuc2Zvcm1lciA9IHJlcXVpcmUoJy4uLy4uL3RyYW5zZm9ybWVycy9ib29rJylcblxuY29uc3QgQk9PS19QQUNLRVRfU0VORF9JTlRFUlZBTF9NUyA9IDEwMDBcblxubW9kdWxlLmV4cG9ydHMgPSAoZXhhLCBtc2csIGNoYW5uZWwpID0+IHtcbiAgY29uc3QgeyBib29rcywgbGFzdEJvb2tQYWNrZXRTZW50IH0gPSBleGFcblxuICBpZiAoX2lzQXJyYXkoX2xhc3QobXNnKVswXSkpIHtcbiAgICBib29rc1tjaGFubmVsLnN5bWJvbF0gPSBfbGFzdChtc2cpXG4gIH0gZWxzZSB7XG4gICAgT3JkZXJCb29rLnVwZGF0ZUFycmF5T0JXaXRoKGJvb2tzW2NoYW5uZWwuc3ltYm9sXSwgX2xhc3QobXNnKSlcbiAgfVxuXG4gIGNvbnN0IGxhc3RTZW5kID0gbGFzdEJvb2tQYWNrZXRTZW50W2NoYW5uZWwuc3ltYm9sXVxuXG4gIGlmICghbGFzdFNlbmQgfHwgRGF0ZS5ub3coKSA+IGxhc3RTZW5kICsgQk9PS19QQUNLRVRfU0VORF9JTlRFUlZBTF9NUykge1xuICAgIGxhc3RCb29rUGFja2V0U2VudFtjaGFubmVsLnN5bWJvbF0gPSBEYXRlLm5vdygpXG5cbiAgICByZXR1cm4gW1snZnVsbCcsIGJvb2tUcmFuc2Zvcm1lcihib29rc1tjaGFubmVsLnN5bWJvbF0pXV1cbiAgfVxuXG4gIHJldHVybiBbXVxufVxuIl19