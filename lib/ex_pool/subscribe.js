'use strict';

const hasClient = require('./has_client');
const addClient = require('./add_client');
const getClient = require('./get_client');
const getSubscriptionRefCount = require('./get_sub_ref_count');
const incrementSubscriptionRefCount = require('./increment_sub_ref_count');
const chanDataToKey = require('../util/chan_data_to_key');

module.exports = async ({ pool, exID, channel }) => {
  if (!hasClient(pool, exID)) {
    addClient(pool, exID);
  }

  const ex = getClient(pool, exID);
  const chanKey = chanDataToKey(channel);
  const ref = getSubscriptionRefCount(pool, exID, chanKey);

  if (!ex.isSubscribed(channel) && ref === 0) {
    await ex.subscribe(channel);
  }

  incrementSubscriptionRefCount(pool, exID, chanKey);

  return ex.getChannelID(channel);
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9leF9wb29sL3N1YnNjcmliZS5qcyJdLCJuYW1lcyI6WyJoYXNDbGllbnQiLCJyZXF1aXJlIiwiYWRkQ2xpZW50IiwiZ2V0Q2xpZW50IiwiZ2V0U3Vic2NyaXB0aW9uUmVmQ291bnQiLCJpbmNyZW1lbnRTdWJzY3JpcHRpb25SZWZDb3VudCIsImNoYW5EYXRhVG9LZXkiLCJtb2R1bGUiLCJleHBvcnRzIiwicG9vbCIsImV4SUQiLCJjaGFubmVsIiwiZXgiLCJjaGFuS2V5IiwicmVmIiwiaXNTdWJzY3JpYmVkIiwic3Vic2NyaWJlIiwiZ2V0Q2hhbm5lbElEIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQSxNQUFNQSxTQUFTLEdBQUdDLE9BQU8sQ0FBQyxjQUFELENBQXpCO0FBQ0EsTUFBTUMsU0FBUyxHQUFHRCxPQUFPLENBQUMsY0FBRCxDQUF6QjtBQUNBLE1BQU1FLFNBQVMsR0FBR0YsT0FBTyxDQUFDLGNBQUQsQ0FBekI7QUFDQSxNQUFNRyx1QkFBdUIsR0FBR0gsT0FBTyxDQUFDLHFCQUFELENBQXZDO0FBQ0EsTUFBTUksNkJBQTZCLEdBQUdKLE9BQU8sQ0FBQywyQkFBRCxDQUE3QztBQUNBLE1BQU1LLGFBQWEsR0FBR0wsT0FBTyxDQUFDLDBCQUFELENBQTdCOztBQUVBTSxNQUFNLENBQUNDLE9BQVAsR0FBaUIsT0FBTyxFQUFFQyxJQUFGLEVBQVFDLElBQVIsRUFBY0MsT0FBZCxFQUFQLEtBQW1DO0FBQ2xELE1BQUksQ0FBQ1gsU0FBUyxDQUFDUyxJQUFELEVBQU9DLElBQVAsQ0FBZCxFQUE0QjtBQUMxQlIsSUFBQUEsU0FBUyxDQUFDTyxJQUFELEVBQU9DLElBQVAsQ0FBVDtBQUNEOztBQUVELFFBQU1FLEVBQUUsR0FBR1QsU0FBUyxDQUFDTSxJQUFELEVBQU9DLElBQVAsQ0FBcEI7QUFDQSxRQUFNRyxPQUFPLEdBQUdQLGFBQWEsQ0FBQ0ssT0FBRCxDQUE3QjtBQUNBLFFBQU1HLEdBQUcsR0FBR1YsdUJBQXVCLENBQUNLLElBQUQsRUFBT0MsSUFBUCxFQUFhRyxPQUFiLENBQW5DOztBQUVBLE1BQUksQ0FBQ0QsRUFBRSxDQUFDRyxZQUFILENBQWdCSixPQUFoQixDQUFELElBQTZCRyxHQUFHLEtBQUssQ0FBekMsRUFBNEM7QUFDMUMsVUFBTUYsRUFBRSxDQUFDSSxTQUFILENBQWFMLE9BQWIsQ0FBTjtBQUNEOztBQUVETixFQUFBQSw2QkFBNkIsQ0FBQ0ksSUFBRCxFQUFPQyxJQUFQLEVBQWFHLE9BQWIsQ0FBN0I7O0FBRUEsU0FBT0QsRUFBRSxDQUFDSyxZQUFILENBQWdCTixPQUFoQixDQUFQO0FBQ0QsQ0FoQkQiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCdcblxuY29uc3QgaGFzQ2xpZW50ID0gcmVxdWlyZSgnLi9oYXNfY2xpZW50JylcbmNvbnN0IGFkZENsaWVudCA9IHJlcXVpcmUoJy4vYWRkX2NsaWVudCcpXG5jb25zdCBnZXRDbGllbnQgPSByZXF1aXJlKCcuL2dldF9jbGllbnQnKVxuY29uc3QgZ2V0U3Vic2NyaXB0aW9uUmVmQ291bnQgPSByZXF1aXJlKCcuL2dldF9zdWJfcmVmX2NvdW50JylcbmNvbnN0IGluY3JlbWVudFN1YnNjcmlwdGlvblJlZkNvdW50ID0gcmVxdWlyZSgnLi9pbmNyZW1lbnRfc3ViX3JlZl9jb3VudCcpXG5jb25zdCBjaGFuRGF0YVRvS2V5ID0gcmVxdWlyZSgnLi4vdXRpbC9jaGFuX2RhdGFfdG9fa2V5JylcblxubW9kdWxlLmV4cG9ydHMgPSBhc3luYyAoeyBwb29sLCBleElELCBjaGFubmVsIH0pID0+IHtcbiAgaWYgKCFoYXNDbGllbnQocG9vbCwgZXhJRCkpIHtcbiAgICBhZGRDbGllbnQocG9vbCwgZXhJRClcbiAgfVxuXG4gIGNvbnN0IGV4ID0gZ2V0Q2xpZW50KHBvb2wsIGV4SUQpXG4gIGNvbnN0IGNoYW5LZXkgPSBjaGFuRGF0YVRvS2V5KGNoYW5uZWwpXG4gIGNvbnN0IHJlZiA9IGdldFN1YnNjcmlwdGlvblJlZkNvdW50KHBvb2wsIGV4SUQsIGNoYW5LZXkpXG5cbiAgaWYgKCFleC5pc1N1YnNjcmliZWQoY2hhbm5lbCkgJiYgcmVmID09PSAwKSB7XG4gICAgYXdhaXQgZXguc3Vic2NyaWJlKGNoYW5uZWwpXG4gIH1cblxuICBpbmNyZW1lbnRTdWJzY3JpcHRpb25SZWZDb3VudChwb29sLCBleElELCBjaGFuS2V5KVxuXG4gIHJldHVybiBleC5nZXRDaGFubmVsSUQoY2hhbm5lbClcbn1cbiJdfQ==