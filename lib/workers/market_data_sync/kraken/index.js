'use strict';function ownKeys(object, enumerableOnly) {var keys = Object.keys(object);if (Object.getOwnPropertySymbols) {var symbols = Object.getOwnPropertySymbols(object);if (enumerableOnly) symbols = symbols.filter(function (sym) {return Object.getOwnPropertyDescriptor(object, sym).enumerable;});keys.push.apply(keys, symbols);}return keys;}function _objectSpread(target) {for (var i = 1; i < arguments.length; i++) {var source = arguments[i] != null ? arguments[i] : {};if (i % 2) {ownKeys(Object(source), true).forEach(function (key) {_defineProperty(target, key, source[key]);});} else if (Object.getOwnPropertyDescriptors) {Object.defineProperties(target, Object.getOwnPropertyDescriptors(source));} else {ownKeys(Object(source)).forEach(function (key) {Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key));});}}return target;}function _defineProperty(obj, key, value) {if (key in obj) {Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true });} else {obj[key] = value;}return obj;}

const debug = require('debug')('bfx:hf:server:worker:kraken-candle-sync');
const Kraken = require('node-kraken-api');
const PI = require('p-iteration');
const _last = require('lodash/last');
const { BigNumber: BigN } = require('bignumber.js');

const dbRL = require('../../../db/pg_rate_limited');
const EXA = require('../../../exchange_clients/kraken');
const TIME_FRAMES = require('../../../util/candle_time_frames');
const candleMTS = require('../../../util/candle_mts');

const getFirstTrade = require('./get_first_trade');

module.exports = async db => {
  const { Market } = db;
  const client = Kraken();
  const markets = await Market.find([['exchange', '=', EXA.id]]);

  debug('syncing market data for %d markets', markets.length);

  PI.forEach(markets, async market => {
    const symbol = market.restID;
    const firstTrade = await getFirstTrade(symbol);

    let last = `${firstTrade ? +firstTrade.mts * 1000000 : 0}`;
    let lastTradeMTS = firstTrade ? +firstTrade.mts / 1000 : 0;

    while (true) {
      debug('fetching trades for %s from %s', symbol, last);

      const res = await client.call('Trades', {
        pair: symbol,
        since: last });


      const tradesRes = Object.values(res)[0];

      if (tradesRes === 0) {
        continue;
      }

      const trades = tradesRes.filter(t => +t[2] > lastTradeMTS);

      // Prevent dup key error where trades have same mts
      trades.forEach((t, n) => {
        if (n !== trades.length - 1) {
          if (t[2] === trades[n + 1][2]) {
            trades[n + 1][2] = +trades[n + 1][2] + Math.floor(Math.random() * 10) / 100000;
          }
        }
      });

      if (trades.length === 0) {
        continue;
      }

      lastTradeMTS = +_last(trades)[2];
      last = res.last;

      await dbRL(db => {
        return db.transaction(trx => {
          return db('kraken_trades').
          insert(trades.map(t => ({
            symbol,
            price: t[0],
            amount: `${+t[1] * (t[3] === 's' ? -1 : 1)}`,
            mts: new BigN(t[2]).times(1000).toString(),
            context: t[4] }))).

          transacting(trx).
          then(trx.commit).
          catch(trx.rollback);
        });
      });

      debug('inserted %s trades for %s', trades.length, symbol);

      let insertedCandles = 0;

      await PI.forEach(Object.keys(TIME_FRAMES), async tf => {
        const newCandles = [];

        let trade;
        let tradeCandleMTS;
        let currentMTS = candleMTS(trades[0][2], tf);
        let currentCandle = await dbRL(db => {
          return db('kraken_candles').
          where({ key: `${symbol}-${tf}-${currentMTS}` }).
          first('*');
        });

        let wasExistingCandle = !!currentCandle;

        for (let i = 0; i < trades.length; i += 1) {
          trade = trades[i];
          tradeCandleMTS = candleMTS(trade[2], tf);

          if (currentCandle && currentCandle.mts !== tradeCandleMTS) {
            newCandles.push([_objectSpread({}, currentCandle), wasExistingCandle]);

            const candleDelta = +tradeCandleMTS - +currentCandle.mts;

            // Insert empty candles
            if (candleDelta > TIME_FRAMES[tf]) {
              const emptyCandles = [];

              for (let i = 0; i < candleDelta / TIME_FRAMES[tf] - 1; i += 1) {
                const mts = +currentCandle.mts + TIME_FRAMES[tf] * (i + 1);

                emptyCandles.push({
                  symbol,
                  tf,
                  open: currentCandle.close,
                  high: currentCandle.close,
                  low: currentCandle.close,
                  close: currentCandle.close,
                  volume: '0',
                  mts: `${mts}`,
                  key: `${symbol}-${tf}-${mts}`,
                  count: 0 });

              }

              await dbRL(db => {
                return db.transaction(trx => {
                  return db('kraken_candles').
                  insert(emptyCandles).
                  transacting(trx).
                  then(trx.commit).
                  catch(trx.rollback);
                });
              });
            }

            currentCandle = null;
            currentMTS = tradeCandleMTS;
            wasExistingCandle = false;
          }

          if (!currentCandle) {
            currentCandle = {
              symbol,
              tf,
              open: `${trade[0]}`,
              high: `${trade[0]}`,
              low: `${trade[0]}`,
              close: `${trade[0]}`,
              volume: `${trade[1]}`,
              mts: currentMTS,
              key: `${symbol}-${tf}-${currentMTS}`,
              count: 1 };

          } else {
            currentCandle.close = `${trade[0]}`;
            currentCandle.high = `${Math.max(+currentCandle.high, +trade[0])}`;
            currentCandle.low = `${Math.min(+currentCandle.low, +trade[0])}`;
            currentCandle.volume = `${+currentCandle.volume + +trade[1]}`;
            currentCandle.count += 1;
          }
        }

        newCandles.push([_objectSpread({}, currentCandle), wasExistingCandle]);

        insertedCandles += newCandles.length;

        if (newCandles[0][1]) {
          await dbRL(db => {
            return db('kraken_candles').
            where({ key: newCandles[0][0].key }).
            update(newCandles[0][0]);
          });
        }

        await dbRL(db => {
          return db.transaction(trx => {
            return db('kraken_candles').
            insert(newCandles.filter(c => !c[1]).map(c => c[0])).
            transacting(trx).
            then(trx.commit).
            catch(trx.rollback);
          });
        });
      });

      debug('inserted %d candles for %s', insertedCandles, symbol);
    }
  });
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy93b3JrZXJzL21hcmtldF9kYXRhX3N5bmMva3Jha2VuL2luZGV4LmpzIl0sIm5hbWVzIjpbImRlYnVnIiwicmVxdWlyZSIsIktyYWtlbiIsIlBJIiwiX2xhc3QiLCJCaWdOdW1iZXIiLCJCaWdOIiwiZGJSTCIsIkVYQSIsIlRJTUVfRlJBTUVTIiwiY2FuZGxlTVRTIiwiZ2V0Rmlyc3RUcmFkZSIsIm1vZHVsZSIsImV4cG9ydHMiLCJkYiIsIk1hcmtldCIsImNsaWVudCIsIm1hcmtldHMiLCJmaW5kIiwiaWQiLCJsZW5ndGgiLCJmb3JFYWNoIiwibWFya2V0Iiwic3ltYm9sIiwicmVzdElEIiwiZmlyc3RUcmFkZSIsImxhc3QiLCJtdHMiLCJsYXN0VHJhZGVNVFMiLCJyZXMiLCJjYWxsIiwicGFpciIsInNpbmNlIiwidHJhZGVzUmVzIiwiT2JqZWN0IiwidmFsdWVzIiwidHJhZGVzIiwiZmlsdGVyIiwidCIsIm4iLCJNYXRoIiwiZmxvb3IiLCJyYW5kb20iLCJ0cmFuc2FjdGlvbiIsInRyeCIsImluc2VydCIsIm1hcCIsInByaWNlIiwiYW1vdW50IiwidGltZXMiLCJ0b1N0cmluZyIsImNvbnRleHQiLCJ0cmFuc2FjdGluZyIsInRoZW4iLCJjb21taXQiLCJjYXRjaCIsInJvbGxiYWNrIiwiaW5zZXJ0ZWRDYW5kbGVzIiwia2V5cyIsInRmIiwibmV3Q2FuZGxlcyIsInRyYWRlIiwidHJhZGVDYW5kbGVNVFMiLCJjdXJyZW50TVRTIiwiY3VycmVudENhbmRsZSIsIndoZXJlIiwia2V5IiwiZmlyc3QiLCJ3YXNFeGlzdGluZ0NhbmRsZSIsImkiLCJwdXNoIiwiY2FuZGxlRGVsdGEiLCJlbXB0eUNhbmRsZXMiLCJvcGVuIiwiY2xvc2UiLCJoaWdoIiwibG93Iiwidm9sdW1lIiwiY291bnQiLCJtYXgiLCJtaW4iLCJ1cGRhdGUiLCJjIl0sIm1hcHBpbmdzIjoiQUFBQSxhOztBQUVBLE1BQU1BLEtBQUssR0FBR0MsT0FBTyxDQUFDLE9B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Q0FBQzZCLFdBQUgsQ0FBZUMsR0FBRyxJQUFJO0FBQzNCLG1CQUFPOUIsRUFBRSxDQUFDLGdCQUFELENBQUY7QUFDSitCLFlBQUFBLE1BREksQ0FDR2UsVUFBVSxDQUFDdkIsTUFBWCxDQUFrQjZDLENBQUMsSUFBSSxDQUFDQSxDQUFDLENBQUMsQ0FBRCxDQUF6QixFQUE4QnBDLEdBQTlCLENBQWtDb0MsQ0FBQyxJQUFJQSxDQUFDLENBQUMsQ0FBRCxDQUF4QyxDQURIO0FBRUo5QixZQUFBQSxXQUZJLENBRVFSLEdBRlI7QUFHSlMsWUFBQUEsSUFISSxDQUdDVCxHQUFHLENBQUNVLE1BSEw7QUFJSkMsWUFBQUEsS0FKSSxDQUlFWCxHQUFHLENBQUNZLFFBSk4sQ0FBUDtBQUtELFdBTk0sQ0FBUDtBQU9ELFNBUlMsQ0FBVjtBQVNELE9BdkdLLENBQU47O0FBeUdBeEQsTUFBQUEsS0FBSyxDQUFDLDRCQUFELEVBQStCeUQsZUFBL0IsRUFBZ0RsQyxNQUFoRCxDQUFMO0FBQ0Q7QUFDRixHQXRLRDtBQXVLRCxDQTlLRCIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0J1xuXG5jb25zdCBkZWJ1ZyA9IHJlcXVpcmUoJ2RlYnVnJykoJ2JmeDpoZjpzZXJ2ZXI6d29ya2VyOmtyYWtlbi1jYW5kbGUtc3luYycpXG5jb25zdCBLcmFrZW4gPSByZXF1aXJlKCdub2RlLWtyYWtlbi1hcGknKVxuY29uc3QgUEkgPSByZXF1aXJlKCdwLWl0ZXJhdGlvbicpXG5jb25zdCBfbGFzdCA9IHJlcXVpcmUoJ2xvZGFzaC9sYXN0JylcbmNvbnN0IHsgQmlnTnVtYmVyOiBCaWdOIH0gPSByZXF1aXJlKCdiaWdudW1iZXIuanMnKVxuXG5jb25zdCBkYlJMID0gcmVxdWlyZSgnLi4vLi4vLi4vZGIvcGdfcmF0ZV9saW1pdGVkJylcbmNvbnN0IEVYQSA9IHJlcXVpcmUoJy4uLy4uLy4uL2V4Y2hhbmdlX2NsaWVudHMva3Jha2VuJylcbmNvbnN0IFRJTUVfRlJBTUVTID0gcmVxdWlyZSgnLi4vLi4vLi4vdXRpbC9jYW5kbGVfdGltZV9mcmFtZXMnKVxuY29uc3QgY2FuZGxlTVRTID0gcmVxdWlyZSgnLi4vLi4vLi4vdXRpbC9jYW5kbGVfbXRzJylcblxuY29uc3QgZ2V0Rmlyc3RUcmFkZSA9IHJlcXVpcmUoJy4vZ2V0X2ZpcnN0X3RyYWRlJylcblxubW9kdWxlLmV4cG9ydHMgPSBhc3luYyAoZGIpID0+IHtcbiAgY29uc3QgeyBNYXJrZXQgfSA9IGRiXG4gIGNvbnN0IGNsaWVudCA9IEtyYWtlbigpXG4gIGNvbnN0IG1hcmtldHMgPSBhd2FpdCBNYXJrZXQuZmluZChbWydleGNoYW5nZScsICc9JywgRVhBLmlkXV0pXG5cbiAgZGVidWcoJ3N5bmNpbmcgbWFya2V0IGRhdGEgZm9yICVkIG1hcmtldHMnLCBtYXJrZXRzLmxlbmd0aClcblxuICBQSS5mb3JFYWNoKG1hcmtldHMsIGFzeW5jIChtYXJrZXQpID0+IHtcbiAgICBjb25zdCBzeW1ib2wgPSBtYXJrZXQucmVzdElEXG4gICAgY29uc3QgZmlyc3RUcmFkZSA9IGF3YWl0IGdldEZpcnN0VHJhZGUoc3ltYm9sKVxuXG4gICAgbGV0IGxhc3QgPSBgJHtmaXJzdFRyYWRlID8gK2ZpcnN0VHJhZGUubXRzICogMTAwMDAwMCA6IDB9YFxuICAgIGxldCBsYXN0VHJhZGVNVFMgPSBmaXJzdFRyYWRlID8gK2ZpcnN0VHJhZGUubXRzIC8gMTAwMCA6IDBcblxuICAgIHdoaWxlICh0cnVlKSB7XG4gICAgICBkZWJ1ZygnZmV0Y2hpbmcgdHJhZGVzIGZvciAlcyBmcm9tICVzJywgc3ltYm9sLCBsYXN0KVxuXG4gICAgICBjb25zdCByZXMgPSBhd2FpdCBjbGllbnQuY2FsbCgnVHJhZGVzJywge1xuICAgICAgICBwYWlyOiBzeW1ib2wsXG4gICAgICAgIHNpbmNlOiBsYXN0XG4gICAgICB9KVxuXG4gICAgICBjb25zdCB0cmFkZXNSZXMgPSBPYmplY3QudmFsdWVzKHJlcylbMF1cblxuICAgICAgaWYgKHRyYWRlc1JlcyA9PT0gMCkge1xuICAgICAgICBjb250aW51ZVxuICAgICAgfVxuXG4gICAgICBjb25zdCB0cmFkZXMgPSB0cmFkZXNSZXMuZmlsdGVyKHQgPT4gK3RbMl0gPiBsYXN0VHJhZGVNVFMpXG5cbiAgICAgIC8vIFByZXZlbnQgZHVwIGtleSBlcnJvciB3aGVyZSB0cmFkZXMgaGF2ZSBzYW1lIG10c1xuICAgICAgdHJhZGVzLmZvckVhY2goKHQsIG4pID0+IHtcbiAgICAgICAgaWYgKG4gIT09IHRyYWRlcy5sZW5ndGggLSAxKSB7XG4gICAgICAgICAgaWYgKHRbMl0gPT09IHRyYWRlc1tuICsgMV1bMl0pIHtcbiAgICAgICAgICAgIHRyYWRlc1tuICsgMV1bMl0gPSArdHJhZGVzW24gKyAxXVsyXSArIChNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAxMCkgLyAxMDAwMDApXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KVxuXG4gICAgICBpZiAodHJhZGVzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICBjb250aW51ZVxuICAgICAgfVxuXG4gICAgICBsYXN0VHJhZGVNVFMgPSArX2xhc3QodHJhZGVzKVsyXVxuICAgICAgbGFzdCA9IHJlcy5sYXN0XG5cbiAgICAgIGF3YWl0IGRiUkwoKGRiKSA9PiB7XG4gICAgICAgIHJldHVybiBkYi50cmFuc2FjdGlvbih0cnggPT4ge1xuICAgICAgICAgIHJldHVybiBkYigna3Jha2VuX3RyYWRlcycpXG4gICAgICAgICAgICAuaW5zZXJ0KHRyYWRlcy5tYXAodCA9PiAoe1xuICAgICAgICAgICAgICBzeW1ib2wsXG4gICAgICAgICAgICAgIHByaWNlOiB0WzBdLFxuICAgICAgICAgICAgICBhbW91bnQ6IGAkeyt0WzFdICogKHRbM10gPT09ICdzJyA/IC0xIDogMSl9YCxcbiAgICAgICAgICAgICAgbXRzOiBuZXcgQmlnTih0WzJdKS50aW1lcygxMDAwKS50b1N0cmluZygpLFxuICAgICAgICAgICAgICBjb250ZXh0OiB0WzRdXG4gICAgICAgICAgICB9KSkpXG4gICAgICAgICAgICAudHJhbnNhY3RpbmcodHJ4KVxuICAgICAgICAgICAgLnRoZW4odHJ4LmNvbW1pdClcbiAgICAgICAgICAgIC5jYXRjaCh0cngucm9sbGJhY2spXG4gICAgICAgIH0pXG4gICAgICB9KVxuXG4gICAgICBkZWJ1ZygnaW5zZXJ0ZWQgJXMgdHJhZGVzIGZvciAlcycsIHRyYWRlcy5sZW5ndGgsIHN5bWJvbClcblxuICAgICAgbGV0IGluc2VydGVkQ2FuZGxlcyA9IDBcblxuICAgICAgYXdhaXQgUEkuZm9yRWFjaChPYmplY3Qua2V5cyhUSU1FX0ZSQU1FUyksIGFzeW5jICh0ZikgPT4ge1xuICAgICAgICBjb25zdCBuZXdDYW5kbGVzID0gW11cblxuICAgICAgICBsZXQgdHJhZGVcbiAgICAgICAgbGV0IHRyYWRlQ2FuZGxlTVRTXG4gICAgICAgIGxldCBjdXJyZW50TVRTID0gY2FuZGxlTVRTKHRyYWRlc1swXVsyXSwgdGYpXG4gICAgICAgIGxldCBjdXJyZW50Q2FuZGxlID0gYXdhaXQgZGJSTCgoZGIpID0+IHtcbiAgICAgICAgICByZXR1cm4gZGIoJ2tyYWtlbl9jYW5kbGVzJylcbiAgICAgICAgICAgIC53aGVyZSh7IGtleTogYCR7c3ltYm9sfS0ke3RmfS0ke2N1cnJlbnRNVFN9YCB9KVxuICAgICAgICAgICAgLmZpcnN0KCcqJylcbiAgICAgICAgfSlcblxuICAgICAgICBsZXQgd2FzRXhpc3RpbmdDYW5kbGUgPSAhIWN1cnJlbnRDYW5kbGVcblxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRyYWRlcy5sZW5ndGg7IGkgKz0gMSkge1xuICAgICAgICAgIHRyYWRlID0gdHJhZGVzW2ldXG4gICAgICAgICAgdHJhZGVDYW5kbGVNVFMgPSBjYW5kbGVNVFModHJhZGVbMl0sIHRmKVxuXG4gICAgICAgICAgaWYgKGN1cnJlbnRDYW5kbGUgJiYgY3VycmVudENhbmRsZS5tdHMgIT09IHRyYWRlQ2FuZGxlTVRTKSB7XG4gICAgICAgICAgICBuZXdDYW5kbGVzLnB1c2goW3sgLi4uY3VycmVudENhbmRsZSB9LCB3YXNFeGlzdGluZ0NhbmRsZV0pXG5cbiAgICAgICAgICAgIGNvbnN0IGNhbmRsZURlbHRhID0gK3RyYWRlQ2FuZGxlTVRTIC0gK2N1cnJlbnRDYW5kbGUubXRzXG5cbiAgICAgICAgICAgIC8vIEluc2VydCBlbXB0eSBjYW5kbGVzXG4gICAgICAgICAgICBpZiAoY2FuZGxlRGVsdGEgPiBUSU1FX0ZSQU1FU1t0Zl0pIHtcbiAgICAgICAgICAgICAgY29uc3QgZW1wdHlDYW5kbGVzID0gW11cblxuICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IChjYW5kbGVEZWx0YSAvIFRJTUVfRlJBTUVTW3RmXSkgLSAxOyBpICs9IDEpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBtdHMgPSArY3VycmVudENhbmRsZS5tdHMgKyAoVElNRV9GUkFNRVNbdGZdICogKGkgKyAxKSlcblxuICAgICAgICAgICAgICAgIGVtcHR5Q2FuZGxlcy5wdXNoKHtcbiAgICAgICAgICAgICAgICAgIHN5bWJvbCxcbiAgICAgICAgICAgICAgICAgIHRmLFxuICAgICAgICAgICAgICAgICAgb3BlbjogY3VycmVudENhbmRsZS5jbG9zZSxcbiAgICAgICAgICAgICAgICAgIGhpZ2g6IGN1cnJlbnRDYW5kbGUuY2xvc2UsXG4gICAgICAgICAgICAgICAgICBsb3c6IGN1cnJlbnRDYW5kbGUuY2xvc2UsXG4gICAgICAgICAgICAgICAgICBjbG9zZTogY3VycmVudENhbmRsZS5jbG9zZSxcbiAgICAgICAgICAgICAgICAgIHZvbHVtZTogJzAnLFxuICAgICAgICAgICAgICAgICAgbXRzOiBgJHttdHN9YCxcbiAgICAgICAgICAgICAgICAgIGtleTogYCR7c3ltYm9sfS0ke3RmfS0ke210c31gLFxuICAgICAgICAgICAgICAgICAgY291bnQ6IDBcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgYXdhaXQgZGJSTCgoZGIpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZGIudHJhbnNhY3Rpb24odHJ4ID0+IHtcbiAgICAgICAgICAgICAgICAgIHJldHVybiBkYigna3Jha2VuX2NhbmRsZXMnKVxuICAgICAgICAgICAgICAgICAgICAuaW5zZXJ0KGVtcHR5Q2FuZGxlcylcbiAgICAgICAgICAgICAgICAgICAgLnRyYW5zYWN0aW5nKHRyeClcbiAgICAgICAgICAgICAgICAgICAgLnRoZW4odHJ4LmNvbW1pdClcbiAgICAgICAgICAgICAgICAgICAgLmNhdGNoKHRyeC5yb2xsYmFjaylcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjdXJyZW50Q2FuZGxlID0gbnVsbFxuICAgICAgICAgICAgY3VycmVudE1UUyA9IHRyYWRlQ2FuZGxlTVRTXG4gICAgICAgICAgICB3YXNFeGlzdGluZ0NhbmRsZSA9IGZhbHNlXG4gICAgICAgICAgfVxuXG4gICAgICAgICAgaWYgKCFjdXJyZW50Q2FuZGxlKSB7XG4gICAgICAgICAgICBjdXJyZW50Q2FuZGxlID0ge1xuICAgICAgICAgICAgICBzeW1ib2wsXG4gICAgICAgICAgICAgIHRmLFxuICAgICAgICAgICAgICBvcGVuOiBgJHt0cmFkZVswXX1gLFxuICAgICAgICAgICAgICBoaWdoOiBgJHt0cmFkZVswXX1gLFxuICAgICAgICAgICAgICBsb3c6IGAke3RyYWRlWzBdfWAsXG4gICAgICAgICAgICAgIGNsb3NlOiBgJHt0cmFkZVswXX1gLFxuICAgICAgICAgICAgICB2b2x1bWU6IGAke3RyYWRlWzFdfWAsXG4gICAgICAgICAgICAgIG10czogY3VycmVudE1UUyxcbiAgICAgICAgICAgICAga2V5OiBgJHtzeW1ib2x9LSR7dGZ9LSR7Y3VycmVudE1UU31gLFxuICAgICAgICAgICAgICBjb3VudDogMVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjdXJyZW50Q2FuZGxlLmNsb3NlID0gYCR7dHJhZGVbMF19YFxuICAgICAgICAgICAgY3VycmVudENhbmRsZS5oaWdoID0gYCR7TWF0aC5tYXgoK2N1cnJlbnRDYW5kbGUuaGlnaCwgK3RyYWRlWzBdKX1gXG4gICAgICAgICAgICBjdXJyZW50Q2FuZGxlLmxvdyA9IGAke01hdGgubWluKCtjdXJyZW50Q2FuZGxlLmxvdywgK3RyYWRlWzBdKX1gXG4gICAgICAgICAgICBjdXJyZW50Q2FuZGxlLnZvbHVtZSA9IGAkeytjdXJyZW50Q2FuZGxlLnZvbHVtZSArICt0cmFkZVsxXX1gXG4gICAgICAgICAgICBjdXJyZW50Q2FuZGxlLmNvdW50ICs9IDFcbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBuZXdDYW5kbGVzLnB1c2goW3sgLi4uY3VycmVudENhbmRsZSB9LCB3YXNFeGlzdGluZ0NhbmRsZV0pXG5cbiAgICAgICAgaW5zZXJ0ZWRDYW5kbGVzICs9IG5ld0NhbmRsZXMubGVuZ3RoXG5cbiAgICAgICAgaWYgKG5ld0NhbmRsZXNbMF1bMV0pIHtcbiAgICAgICAgICBhd2FpdCBkYlJMKChkYikgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIGRiKCdrcmFrZW5fY2FuZGxlcycpXG4gICAgICAgICAgICAgIC53aGVyZSh7IGtleTogbmV3Q2FuZGxlc1swXVswXS5rZXkgfSlcbiAgICAgICAgICAgICAgLnVwZGF0ZShuZXdDYW5kbGVzWzBdWzBdKVxuICAgICAgICAgIH0pXG4gICAgICAgIH1cblxuICAgICAgICBhd2FpdCBkYlJMKChkYikgPT4ge1xuICAgICAgICAgIHJldHVybiBkYi50cmFuc2FjdGlvbih0cnggPT4ge1xuICAgICAgICAgICAgcmV0dXJuIGRiKCdrcmFrZW5fY2FuZGxlcycpXG4gICAgICAgICAgICAgIC5pbnNlcnQobmV3Q2FuZGxlcy5maWx0ZXIoYyA9PiAhY1sxXSkubWFwKGMgPT4gY1swXSkpXG4gICAgICAgICAgICAgIC50cmFuc2FjdGluZyh0cngpXG4gICAgICAgICAgICAgIC50aGVuKHRyeC5jb21taXQpXG4gICAgICAgICAgICAgIC5jYXRjaCh0cngucm9sbGJhY2spXG4gICAgICAgICAgfSlcbiAgICAgICAgfSlcbiAgICAgIH0pXG5cbiAgICAgIGRlYnVnKCdpbnNlcnRlZCAlZCBjYW5kbGVzIGZvciAlcycsIGluc2VydGVkQ2FuZGxlcywgc3ltYm9sKVxuICAgIH1cbiAgfSlcbn1cbiJdfQ==