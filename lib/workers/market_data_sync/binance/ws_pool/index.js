'use strict';

require('bfx-hf-util/lib/catch_uncaught_errors');
const childProcess = require('child_process');
const debug = require('debug')('bfx:hf:server:workers:market-data-sync:binance:ws-pool');

const { BINANCE_WORKER_SOCKETS_PER_PROC } = process.env;
const workers = []; // [[process, nSockets]]

const findFreeWorker = () => workers.find((w) =>
w[1] < +BINANCE_WORKER_SOCKETS_PER_PROC);


const spawnWorker = () => {
  const process = childProcess.fork(`${__dirname}/worker`);
  const worker = [process, 0];
  workers.push(worker);

  debug('forked worker');

  return worker;
};

const addSyncTask = (symbol, tf) => {
  const existingWorker = findFreeWorker();
  const worker = existingWorker || spawnWorker();

  // @ts-ignore
  worker[0].send({ symbol, tf });
  // @ts-ignore
  worker[1] += 1;
};

module.exports = { addSyncTask };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy93b3JrZXJzL21hcmtldF9kYXRhX3N5bmMvYmluYW5jZS93c19wb29sL2luZGV4LmpzIl0sIm5hbWVzIjpbInJlcXVpcmUiLCJjaGlsZFByb2Nlc3MiLCJkZWJ1ZyIsIkJJTkFOQ0VfV09SS0VSX1NPQ0tFVFNfUEVSX1BST0MiLCJwcm9jZXNzIiwiZW52Iiwid29ya2VycyIsImZpbmRGcmVlV29ya2VyIiwiZmluZCIsInciLCJzcGF3bldvcmtlciIsImZvcmsiLCJfX2Rpcm5hbWUiLCJ3b3JrZXIiLCJwdXNoIiwiYWRkU3luY1Rhc2siLCJzeW1ib2wiLCJ0ZiIsImV4aXN0aW5nV29ya2VyIiwic2VuZCIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBQSxPQUFPLENBQUMsdUNBQUQsQ0FBUDtBQUNBLE1BQU1DLFlBQVksR0FBR0QsT0FBTyxDQUFDLGVBQUQsQ0FBNUI7QUFDQSxNQUFNRSxLQUFLLEdBQUdGLE9BQU8sQ0FBQyxPQUFELENBQVAsQ0FBaUIsd0RBQWpCLENBQWQ7O0FBRUEsTUFBTSxFQUFFRywrQkFBRixLQUFzQ0MsT0FBTyxDQUFDQyxHQUFwRDtBQUNBLE1BQU1DLE9BQU8sR0FBRyxFQUFoQixDLENBQW1COztBQUVuQixNQUFNQyxjQUFjLEdBQUcsTUFBTUQsT0FBTyxDQUFDRSxJQUFSLENBQWEsQ0FBQUMsQ0FBQztBQUN6Q0EsQ0FBQyxDQUFDLENBQUQsQ0FBRCxHQUFPLENBQUNOLCtCQURtQixDQUE3Qjs7O0FBSUEsTUFBTU8sV0FBVyxHQUFHLE1BQU07QUFDeEIsUUFBTU4sT0FBTyxHQUFHSCxZQUFZLENBQUNVLElBQWIsQ0FBbUIsR0FBRUMsU0FBVSxTQUEvQixDQUFoQjtBQUNBLFFBQU1DLE1BQU0sR0FBRyxDQUFDVCxPQUFELEVBQVUsQ0FBVixDQUFmO0FBQ0FFLEVBQUFBLE9BQU8sQ0FBQ1EsSUFBUixDQUFhRCxNQUFiOztBQUVBWCxFQUFBQSxLQUFLLENBQUMsZUFBRCxDQUFMOztBQUVBLFNBQU9XLE1BQVA7QUFDRCxDQVJEOztBQVVBLE1BQU1FLFdBQVcsR0FBRyxDQUFDQyxNQUFELEVBQVNDLEVBQVQsS0FBZ0I7QUFDbEMsUUFBTUMsY0FBYyxHQUFHWCxjQUFjLEVBQXJDO0FBQ0EsUUFBTU0sTUFBTSxHQUFHSyxjQUFjLElBQUlSLFdBQVcsRUFBNUM7O0FBRUE7QUFDQUcsRUFBQUEsTUFBTSxDQUFDLENBQUQsQ0FBTixDQUFVTSxJQUFWLENBQWUsRUFBRUgsTUFBRixFQUFVQyxFQUFWLEVBQWY7QUFDQTtBQUNBSixFQUFBQSxNQUFNLENBQUMsQ0FBRCxDQUFOLElBQWEsQ0FBYjtBQUNELENBUkQ7O0FBVUFPLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQixFQUFFTixXQUFGLEVBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnXG5cbnJlcXVpcmUoJ2JmeC1oZi11dGlsL2xpYi9jYXRjaF91bmNhdWdodF9lcnJvcnMnKVxuY29uc3QgY2hpbGRQcm9jZXNzID0gcmVxdWlyZSgnY2hpbGRfcHJvY2VzcycpXG5jb25zdCBkZWJ1ZyA9IHJlcXVpcmUoJ2RlYnVnJykoJ2JmeDpoZjpzZXJ2ZXI6d29ya2VyczptYXJrZXQtZGF0YS1zeW5jOmJpbmFuY2U6d3MtcG9vbCcpXG5cbmNvbnN0IHsgQklOQU5DRV9XT1JLRVJfU09DS0VUU19QRVJfUFJPQyB9ID0gcHJvY2Vzcy5lbnZcbmNvbnN0IHdvcmtlcnMgPSBbXSAvLyBbW3Byb2Nlc3MsIG5Tb2NrZXRzXV1cblxuY29uc3QgZmluZEZyZWVXb3JrZXIgPSAoKSA9PiB3b3JrZXJzLmZpbmQodyA9PiAoXG4gIHdbMV0gPCArQklOQU5DRV9XT1JLRVJfU09DS0VUU19QRVJfUFJPQ1xuKSlcblxuY29uc3Qgc3Bhd25Xb3JrZXIgPSAoKSA9PiB7XG4gIGNvbnN0IHByb2Nlc3MgPSBjaGlsZFByb2Nlc3MuZm9yayhgJHtfX2Rpcm5hbWV9L3dvcmtlcmApXG4gIGNvbnN0IHdvcmtlciA9IFtwcm9jZXNzLCAwXVxuICB3b3JrZXJzLnB1c2god29ya2VyKVxuXG4gIGRlYnVnKCdmb3JrZWQgd29ya2VyJylcblxuICByZXR1cm4gd29ya2VyXG59XG5cbmNvbnN0IGFkZFN5bmNUYXNrID0gKHN5bWJvbCwgdGYpID0+IHtcbiAgY29uc3QgZXhpc3RpbmdXb3JrZXIgPSBmaW5kRnJlZVdvcmtlcigpXG4gIGNvbnN0IHdvcmtlciA9IGV4aXN0aW5nV29ya2VyIHx8IHNwYXduV29ya2VyKClcblxuICAvLyBAdHMtaWdub3JlXG4gIHdvcmtlclswXS5zZW5kKHsgc3ltYm9sLCB0ZiB9KVxuICAvLyBAdHMtaWdub3JlXG4gIHdvcmtlclsxXSArPSAxXG59XG5cbm1vZHVsZS5leHBvcnRzID0geyBhZGRTeW5jVGFzayB9XG4iXX0=