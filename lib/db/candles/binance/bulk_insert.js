'use strict';

const _chunk = require('lodash/chunk');
const PI = require('p-iteration');

const dbRL = require('../../pg_rate_limited');
const tfToString = require('../../../exchange_clients/binance/util/tf_to_string');

module.exports = async (symbol, tf, candles, transformed) => {
  return dbRL(async db => {
    return PI.forEachSeries(_chunk(candles, 1000), async chunk => {
      return db.transaction(trx => {
        return db(`binance_candles_${tfToString(tf)}`).
        insert(chunk.map(c => ({
          symbol,
          mts: `${transformed ? c.mts : c[0]}`,
          open: `${transformed ? c.open : c[1]}`,
          close: `${transformed ? c.close : c[2]}`,
          high: `${transformed ? c.high : c[3]}`,
          low: `${transformed ? c.low : c[4]}`,
          volume: `${transformed ? c.volume : c[5]}`,
          key: `${symbol}-${transformed ? c.mts : c[0]}` }))).

        transacting(trx).
        then(trx.commit).
        catch(trx.rollback);
      });
    });
  });
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9kYi9jYW5kbGVzL2JpbmFuY2UvYnVsa19pbnNlcnQuanMiXSwibmFtZXMiOlsiX2NodW5rIiwicmVxdWlyZSIsIlBJIiwiZGJSTCIsInRmVG9TdHJpbmciLCJtb2R1bGUiLCJleHBvcnRzIiwic3ltYm9sIiwidGYiLCJjYW5kbGVzIiwidHJhbnNmb3JtZWQiLCJkYiIsImZvckVhY2hTZXJpZXMiLCJjaHVuayIsInRyYW5zYWN0aW9uIiwidHJ4IiwiaW5zZXJ0IiwibWFwIiwiYyIsIm10cyIsIm9wZW4iLCJjbG9zZSIsImhpZ2giLCJsb3ciLCJ2b2x1bWUiLCJrZXkiLCJ0cmFuc2FjdGluZyIsInRoZW4iLCJjb21taXQiLCJjYXRjaCIsInJvbGxiYWNrIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQSxNQUFNQSxNQUFNLEdBQUdDLE9BQU8sQ0FBQyxjQUFELENBQXRCO0FBQ0EsTUFBTUMsRUFBRSxHQUFHRCxPQUFPLENBQUMsYUFBRCxDQUFsQjs7QUFFQSxNQUFNRSxJQUFJLEdBQUdGLE9BQU8sQ0FBQyx1QkFBRCxDQUFwQjtBQUNBLE1BQU1HLFVBQVUsR0FBR0gsT0FBTyxDQUFDLHFEQUFELENBQTFCOztBQUVBSSxNQUFNLENBQUNDLE9BQVAsR0FBaUIsT0FBT0MsTUFBUCxFQUFlQyxFQUFmLEVBQW1CQyxPQUFuQixFQUE0QkMsV0FBNUIsS0FBNEM7QUFDM0QsU0FBT1AsSUFBSSxDQUFDLE1BQU9RLEVBQVAsSUFBYztBQUN4QixXQUFPVCxFQUFFLENBQUNVLGFBQUgsQ0FBaUJaLE1BQU0sQ0FBQ1MsT0FBRCxFQUFVLElBQVYsQ0FBdkIsRUFBd0MsTUFBT0ksS0FBUCxJQUFpQjtBQUM5RCxhQUFPRixFQUFFLENBQUNHLFdBQUgsQ0FBZUMsR0FBRyxJQUFJO0FBQzNCLGVBQU9KLEVBQUUsQ0FBRSxtQkFBa0JQLFVBQVUsQ0FBQ0ksRUFBRCxDQUFLLEVBQW5DLENBQUY7QUFDSlEsUUFBQUEsTUFESSxDQUNHSCxLQUFLLENBQUNJLEdBQU4sQ0FBVUMsQ0FBQyxLQUFLO0FBQ3RCWCxVQUFBQSxNQURzQjtBQUV0QlksVUFBQUEsR0FBRyxFQUFHLEdBQUVULFdBQVcsR0FBR1EsQ0FBQyxDQUFDQyxHQUFMLEdBQVdELENBQUMsQ0FBQyxDQUFELENBQUksRUFGYjtBQUd0QkUsVUFBQUEsSUFBSSxFQUFHLEdBQUVWLFdBQVcsR0FBR1EsQ0FBQyxDQUFDRSxJQUFMLEdBQVlGLENBQUMsQ0FBQyxDQUFELENBQUksRUFIZjtBQUl0QkcsVUFBQUEsS0FBSyxFQUFHLEdBQUVYLFdBQVcsR0FBR1EsQ0FBQyxDQUFDRyxLQUFMLEdBQWFILENBQUMsQ0FBQyxDQUFELENBQUksRUFKakI7QUFLdEJJLFVBQUFBLElBQUksRUFBRyxHQUFFWixXQUFXLEdBQUdRLENBQUMsQ0FBQ0ksSUFBTCxHQUFZSixDQUFDLENBQUMsQ0FBRCxDQUFJLEVBTGY7QUFNdEJLLFVBQUFBLEdBQUcsRUFBRyxHQUFFYixXQUFXLEdBQUdRLENBQUMsQ0FBQ0ssR0FBTCxHQUFXTCxDQUFDLENBQUMsQ0FBRCxDQUFJLEVBTmI7QUFPdEJNLFVBQUFBLE1BQU0sRUFBRyxHQUFFZCxXQUFXLEdBQUdRLENBQUMsQ0FBQ00sTUFBTCxHQUFjTixDQUFDLENBQUMsQ0FBRCxDQUFJLEVBUG5CO0FBUXRCTyxVQUFBQSxHQUFHLEVBQUcsR0FBRWxCLE1BQU8sSUFBR0csV0FBVyxHQUFHUSxDQUFDLENBQUNDLEdBQUwsR0FBV0QsQ0FBQyxDQUFDLENBQUQsQ0FBSSxFQVJ2QixFQUFMLENBQVgsQ0FESDs7QUFXSlEsUUFBQUEsV0FYSSxDQVdRWCxHQVhSO0FBWUpZLFFBQUFBLElBWkksQ0FZQ1osR0FBRyxDQUFDYSxNQVpMO0FBYUpDLFFBQUFBLEtBYkksQ0FhRWQsR0FBRyxDQUFDZSxRQWJOLENBQVA7QUFjRCxPQWZNLENBQVA7QUFnQkQsS0FqQk0sQ0FBUDtBQWtCRCxHQW5CVSxDQUFYO0FBb0JELENBckJEIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnXG5cbmNvbnN0IF9jaHVuayA9IHJlcXVpcmUoJ2xvZGFzaC9jaHVuaycpXG5jb25zdCBQSSA9IHJlcXVpcmUoJ3AtaXRlcmF0aW9uJylcblxuY29uc3QgZGJSTCA9IHJlcXVpcmUoJy4uLy4uL3BnX3JhdGVfbGltaXRlZCcpXG5jb25zdCB0ZlRvU3RyaW5nID0gcmVxdWlyZSgnLi4vLi4vLi4vZXhjaGFuZ2VfY2xpZW50cy9iaW5hbmNlL3V0aWwvdGZfdG9fc3RyaW5nJylcblxubW9kdWxlLmV4cG9ydHMgPSBhc3luYyAoc3ltYm9sLCB0ZiwgY2FuZGxlcywgdHJhbnNmb3JtZWQpID0+IHtcbiAgcmV0dXJuIGRiUkwoYXN5bmMgKGRiKSA9PiB7XG4gICAgcmV0dXJuIFBJLmZvckVhY2hTZXJpZXMoX2NodW5rKGNhbmRsZXMsIDEwMDApLCBhc3luYyAoY2h1bmspID0+IHtcbiAgICAgIHJldHVybiBkYi50cmFuc2FjdGlvbih0cnggPT4ge1xuICAgICAgICByZXR1cm4gZGIoYGJpbmFuY2VfY2FuZGxlc18ke3RmVG9TdHJpbmcodGYpfWApXG4gICAgICAgICAgLmluc2VydChjaHVuay5tYXAoYyA9PiAoe1xuICAgICAgICAgICAgc3ltYm9sLFxuICAgICAgICAgICAgbXRzOiBgJHt0cmFuc2Zvcm1lZCA/IGMubXRzIDogY1swXX1gLFxuICAgICAgICAgICAgb3BlbjogYCR7dHJhbnNmb3JtZWQgPyBjLm9wZW4gOiBjWzFdfWAsXG4gICAgICAgICAgICBjbG9zZTogYCR7dHJhbnNmb3JtZWQgPyBjLmNsb3NlIDogY1syXX1gLFxuICAgICAgICAgICAgaGlnaDogYCR7dHJhbnNmb3JtZWQgPyBjLmhpZ2ggOiBjWzNdfWAsXG4gICAgICAgICAgICBsb3c6IGAke3RyYW5zZm9ybWVkID8gYy5sb3cgOiBjWzRdfWAsXG4gICAgICAgICAgICB2b2x1bWU6IGAke3RyYW5zZm9ybWVkID8gYy52b2x1bWUgOiBjWzVdfWAsXG4gICAgICAgICAgICBrZXk6IGAke3N5bWJvbH0tJHt0cmFuc2Zvcm1lZCA/IGMubXRzIDogY1swXX1gXG4gICAgICAgICAgfSkpKVxuICAgICAgICAgIC50cmFuc2FjdGluZyh0cngpXG4gICAgICAgICAgLnRoZW4odHJ4LmNvbW1pdClcbiAgICAgICAgICAuY2F0Y2godHJ4LnJvbGxiYWNrKVxuICAgICAgfSlcbiAgICB9KVxuICB9KVxufVxuIl19