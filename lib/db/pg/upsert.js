'use strict';

module.exports = async ({ db, path, index, indexMatches, doc }) => {
  if (!index) {
    throw new Error('can\'t upsert, model missing index');
  }

  const insertSQL = db(path).insert(doc).toString();
  const whereRawSQL = indexMatches.map((fieldName) =>
  `${path}.${fieldName} = '${doc[fieldName]}'`).
  join(' AND ');

  const updateSQL = db.
  update(doc).
  whereRaw(whereRawSQL).
  toString();

  const query = [
  insertSQL,
  `ON CONFLICT (${index}) DO UPDATE SET`,
  updateSQL.replace(/^update\s.*\sset\s/i, '')].
  join(' ');

  await db.raw(query);

  return doc;
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9kYi9wZy91cHNlcnQuanMiXSwibmFtZXMiOlsibW9kdWxlIiwiZXhwb3J0cyIsImRiIiwicGF0aCIsImluZGV4IiwiaW5kZXhNYXRjaGVzIiwiZG9jIiwiRXJyb3IiLCJpbnNlcnRTUUwiLCJpbnNlcnQiLCJ0b1N0cmluZyIsIndoZXJlUmF3U1FMIiwibWFwIiwiZmllbGROYW1lIiwiam9pbiIsInVwZGF0ZVNRTCIsInVwZGF0ZSIsIndoZXJlUmF3IiwicXVlcnkiLCJyZXBsYWNlIiwicmF3Il0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQUEsTUFBTSxDQUFDQyxPQUFQLEdBQWlCLE9BQU8sRUFBRUMsRUFBRixFQUFNQyxJQUFOLEVBQVlDLEtBQVosRUFBbUJDLFlBQW5CLEVBQWlDQyxHQUFqQyxFQUFQLEtBQWtEO0FBQ2pFLE1BQUksQ0FBQ0YsS0FBTCxFQUFZO0FBQ1YsVUFBTSxJQUFJRyxLQUFKLENBQVUsb0NBQVYsQ0FBTjtBQUNEOztBQUVELFFBQU1DLFNBQVMsR0FBR04sRUFBRSxDQUFDQyxJQUFELENBQUYsQ0FBU00sTUFBVCxDQUFnQkgsR0FBaEIsRUFBcUJJLFFBQXJCLEVBQWxCO0FBQ0EsUUFBTUMsV0FBVyxHQUFHTixZQUFZLENBQUNPLEdBQWIsQ0FBaUIsQ0FBQUMsU0FBUztBQUMzQyxLQUFFVixJQUFLLElBQUdVLFNBQVUsT0FBTVAsR0FBRyxDQUFDTyxTQUFELENBQVksR0FEeEI7QUFFakJDLEVBQUFBLElBRmlCLENBRVosT0FGWSxDQUFwQjs7QUFJQSxRQUFNQyxTQUFTLEdBQUdiLEVBQUU7QUFDakJjLEVBQUFBLE1BRGUsQ0FDUlYsR0FEUTtBQUVmVyxFQUFBQSxRQUZlLENBRU5OLFdBRk07QUFHZkQsRUFBQUEsUUFIZSxFQUFsQjs7QUFLQSxRQUFNUSxLQUFLLEdBQUc7QUFDWlYsRUFBQUEsU0FEWTtBQUVYLGtCQUFlSixLQUFNLGlCQUZWO0FBR1pXLEVBQUFBLFNBQVMsQ0FBQ0ksT0FBVixDQUFrQixxQkFBbEIsRUFBeUMsRUFBekMsQ0FIWTtBQUlaTCxFQUFBQSxJQUpZLENBSVAsR0FKTyxDQUFkOztBQU1BLFFBQU1aLEVBQUUsQ0FBQ2tCLEdBQUgsQ0FBT0YsS0FBUCxDQUFOOztBQUVBLFNBQU9aLEdBQVA7QUFDRCxDQXhCRCIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0J1xuXG5tb2R1bGUuZXhwb3J0cyA9IGFzeW5jICh7IGRiLCBwYXRoLCBpbmRleCwgaW5kZXhNYXRjaGVzLCBkb2MgfSkgPT4ge1xuICBpZiAoIWluZGV4KSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdjYW5cXCd0IHVwc2VydCwgbW9kZWwgbWlzc2luZyBpbmRleCcpXG4gIH1cblxuICBjb25zdCBpbnNlcnRTUUwgPSBkYihwYXRoKS5pbnNlcnQoZG9jKS50b1N0cmluZygpXG4gIGNvbnN0IHdoZXJlUmF3U1FMID0gaW5kZXhNYXRjaGVzLm1hcChmaWVsZE5hbWUgPT4gKFxuICAgIGAke3BhdGh9LiR7ZmllbGROYW1lfSA9ICcke2RvY1tmaWVsZE5hbWVdfSdgXG4gICkpLmpvaW4oJyBBTkQgJylcblxuICBjb25zdCB1cGRhdGVTUUwgPSBkYlxuICAgIC51cGRhdGUoZG9jKVxuICAgIC53aGVyZVJhdyh3aGVyZVJhd1NRTClcbiAgICAudG9TdHJpbmcoKVxuXG4gIGNvbnN0IHF1ZXJ5ID0gW1xuICAgIGluc2VydFNRTCxcbiAgICBgT04gQ09ORkxJQ1QgKCR7aW5kZXh9KSBETyBVUERBVEUgU0VUYCxcbiAgICB1cGRhdGVTUUwucmVwbGFjZSgvXnVwZGF0ZVxccy4qXFxzc2V0XFxzL2ksICcnKVxuICBdLmpvaW4oJyAnKVxuXG4gIGF3YWl0IGRiLnJhdyhxdWVyeSlcblxuICByZXR1cm4gZG9jXG59XG4iXX0=