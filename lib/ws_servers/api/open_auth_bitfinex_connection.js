'use strict';

const _isObject = require('lodash/isObject');
const _isString = require('lodash/isString');
const _isEmpty = require('lodash/isEmpty');
const { _default: DEFAULT_SETTINGS } = require('bfx-hf-ui-config').UserSettings;
const BitfinexExchangeConnection = require('../../exchange_clients/bitfinex');
const { notifyInfo, notifyError, notifySuccess } = require('../../util/ws/notify');
const send = require('../../util/ws/send');

/**
                                             * Broadcast notification payload, format varies based on source
                                             *
                                             * @typedef {object} UCMPayload
                                             * @property {string} [level] - notification type
                                             * @property {string} [type] - alias for level
                                             * @property {string} [status] - alias for level
                                             * @property {string} [message] - notification message
                                             * @property {string} [msg] - alias for message
                                             * @property {string} [text] - alias for message
                                             */

module.exports = async (ws, apiKey, apiSecret, db, d) => {
  notifyInfo(ws, 'Connecting to Bitfinex...');

  const { UserSettings } = db;
  const { userSettings: settings } = await UserSettings.getAll();
  const client = new BitfinexExchangeConnection();
  const { dms } = settings || DEFAULT_SETTINGS;

  d('opening auth bfx connection (dms %s)', dms ? 'enabled' : 'disabled');

  client.setAuthArgs({ dms: dms ? 4 : 0 });
  client.openWS({
    apiKey,
    apiSecret });


  client.on('error', err => {
    notifyError(ws, `Bitfinex - ${err.message}`);
  });

  client.on('open', () => {
    notifyInfo(ws, 'Connected to Bitfinex');
  });

  client.on('auth', () => {
    notifySuccess(ws, 'Authenticated with Bitfinex');
    send(ws, ['data.client', 'bitfinex', 2]); // TODO: Extract client state into enum
  });

  client.on('close', () => {
    notifyInfo(ws, 'Disconnected from Bitfinex');
    send(ws, ['data.client', 'bitfinex', 0]);
  });

  client.onData((chanID, payload) => {
    if (chanID !== 0) return;

    const [, msgType, msgData] = payload;

    switch (msgType) {
      case 'ws':{
          send(ws, ['data.balances', 'bitfinex', BitfinexExchangeConnection.transformBalances(msgData)]);
          break;
        }

      case 'wu':{
          send(ws, ['data.balance', 'bitfinex', BitfinexExchangeConnection.transformBalance(msgData)]);
          break;
        }

      case 'ps':{
          send(ws, ['data.positions', 'bitfinex', msgData]);
          break;
        }

      case 'pu':{
          send(ws, ['data.position', 'bitfinex', msgData]);
          break;
        }

      case 'pc':{
          send(ws, ['data.position.close', 'bitfinex', msgData]);
          break;
        }

      case 'os':{
          send(ws, ['data.orders', 'bitfinex', BitfinexExchangeConnection.transformOrders(msgData)]);
          break;
        }

      case 'on':
      case 'ou':{
          send(ws, ['data.order', 'bitfinex', BitfinexExchangeConnection.transformOrder(msgData)]);
          break;
        }

      case 'oc':{
          send(ws, ['data.order.close', 'bitfinex', BitfinexExchangeConnection.transformOrder(msgData)]);
          break;
        }

      case 'n':{
          let [,,,,,, status, text] = msgData;
          const ucmPayload = /** @type {UCMPayload} */msgData[4];

          // The payload is fluid and can have any format; HF uses level & message
          if (_isObject(ucmPayload) && !_isEmpty(ucmPayload)) {
            status = ucmPayload.level || ucmPayload.type || ucmPayload.status;
            text = ucmPayload.message || ucmPayload.msg || ucmPayload.text;
          }

          if (_isString(status) && _isString(text) && !_isEmpty(status) && !_isEmpty(text)) {
            if (status.toLowerCase() === 'success') {
              notifySuccess(ws, text);
            } else if (status.toLowerCase() === 'info') {
              notifyInfo(ws, text);
            } else if (status.toLowerCase() === 'error') {
              notifyError(ws, text);
            }
          }

          break;
        }}

  });

  send(ws, ['data.client', 'bitfinex', 1]);

  client.openSocket();

  return client;
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy93c19zZXJ2ZXJzL2FwaS9vcGVuX2F1dGhfYml0ZmluZXhfY29ubmVjdGlvbi5qcyJdLCJuYW1lcyI6WyJfaXNPYmplY3QiLCJyZXF1aXJlIiwiX2lzU3RyaW5nIiwiX2lzRW1wdHkiLCJfZGVmYXVsdCIsIkRFRkFVTFRfU0VUVElOR1MiLCJVc2VyU2V0dGluZ3MiLCJCaXRmaW5leEV4Y2hhbmdlQ29ubmVjdGlvbiIsIm5vdGlmeUluZm8iLCJub3RpZnlFcnJvciIsIm5vdGlmeVN1Y2Nlc3MiLCJzZW5kIiwibW9kdWxlIiwiZXhwb3J0cyIsIndzIiwiYXBpS2V5IiwiYXBpU2VjcmV0IiwiZGIiLCJkIiwidXNlclNldHRpbmdzIiwic2V0dGluZ3MiLCJnZXRBbGwiLCJjbGllbnQiLCJkbXMiLCJzZXRBdXRoQXJncyIsIm9wZW5XUyIsIm9uIiwiZXJyIiwibWVzc2FnZSIsIm9uRGF0YSIsImNoYW5JRCIsInBheWxvYWQiLCJtc2dUeXBlIiwibXNnRGF0YSIsInRyYW5zZm9ybUJhbGFuY2VzIiwidHJhbnNmb3JtQmFsYW5jZSIsInRyYW5zZm9ybU9yZGVycyIsInRyYW5zZm9ybU9yZGVyIiwic3RhdHVzIiwidGV4dCIsInVjbVBheWxvYWQiLCJsZXZlbCIsInR5cGUiLCJtc2ciLCJ0b0xvd2VyQ2FzZSIsIm9wZW5Tb2NrZXQiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBLE1BQU1BLFNBQVMsR0FBR0MsT0FBTyxDQUFDLGlCQUFELENBQXpCO0FBQ0EsTUFBTUMsU0FBUyxHQUFHRCxPQUFPLENBQUMsaUJBQUQsQ0FBekI7QUFDQSxNQUFNRSxRQUFRLEdBQUdGLE9BQU8sQ0FBQyxnQkFBRCxDQUF4QjtBQUNBLE1BQU0sRUFBRUcsUUFBUSxFQUFFQyxnQkFBWixLQUFpQ0osT0FBTyxDQUFDLGtCQUFELENBQVAsQ0FBNEJLLFlBQW5FO0FBQ0EsTUFBTUMsMEJBQTBCLEdBQUdOLE9BQU8sQ0FBQyxpQ0FBRCxDQUExQztBQUNBLE1BQU0sRUFBRU8s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LENBQXRDLEVBQW9EO0FBQ2xERixZQUFBQSxNQUFNLEdBQUdFLFVBQVUsQ0FBQ0MsS0FBWCxJQUFvQkQsVUFBVSxDQUFDRSxJQUEvQixJQUF1Q0YsVUFBVSxDQUFDRixNQUEzRDtBQUNBQyxZQUFBQSxJQUFJLEdBQUdDLFVBQVUsQ0FBQ1osT0FBWCxJQUFzQlksVUFBVSxDQUFDRyxHQUFqQyxJQUF3Q0gsVUFBVSxDQUFDRCxJQUExRDtBQUNEOztBQUVELGNBQUlyQyxTQUFTLENBQUNvQyxNQUFELENBQVQsSUFBcUJwQyxTQUFTLENBQUNxQyxJQUFELENBQTlCLElBQXdDLENBQUNwQyxRQUFRLENBQUNtQyxNQUFELENBQWpELElBQTZELENBQUNuQyxRQUFRLENBQUNvQyxJQUFELENBQTFFLEVBQWtGO0FBQ2hGLGdCQUFJRCxNQUFNLENBQUNNLFdBQVAsT0FBeUIsU0FBN0IsRUFBd0M7QUFDdENsQyxjQUFBQSxhQUFhLENBQUNJLEVBQUQsRUFBS3lCLElBQUwsQ0FBYjtBQUNELGFBRkQsTUFFTyxJQUFJRCxNQUFNLENBQUNNLFdBQVAsT0FBeUIsTUFBN0IsRUFBcUM7QUFDMUNwQyxjQUFBQSxVQUFVLENBQUNNLEVBQUQsRUFBS3lCLElBQUwsQ0FBVjtBQUNELGFBRk0sTUFFQSxJQUFJRCxNQUFNLENBQUNNLFdBQVAsT0FBeUIsT0FBN0IsRUFBc0M7QUFDM0NuQyxjQUFBQSxXQUFXLENBQUNLLEVBQUQsRUFBS3lCLElBQUwsQ0FBWDtBQUNEO0FBQ0Y7O0FBRUQ7QUFDRCxTQS9ESDs7QUFpRUQsR0F0RUQ7O0FBd0VBNUIsRUFBQUEsSUFBSSxDQUFDRyxFQUFELEVBQUssQ0FBQyxhQUFELEVBQWdCLFVBQWhCLEVBQTRCLENBQTVCLENBQUwsQ0FBSjs7QUFFQVEsRUFBQUEsTUFBTSxDQUFDdUIsVUFBUDs7QUFFQSxTQUFPdkIsTUFBUDtBQUNELENBL0dEIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnXG5cbmNvbnN0IF9pc09iamVjdCA9IHJlcXVpcmUoJ2xvZGFzaC9pc09iamVjdCcpXG5jb25zdCBfaXNTdHJpbmcgPSByZXF1aXJlKCdsb2Rhc2gvaXNTdHJpbmcnKVxuY29uc3QgX2lzRW1wdHkgPSByZXF1aXJlKCdsb2Rhc2gvaXNFbXB0eScpXG5jb25zdCB7IF9kZWZhdWx0OiBERUZBVUxUX1NFVFRJTkdTIH0gPSByZXF1aXJlKCdiZngtaGYtdWktY29uZmlnJykuVXNlclNldHRpbmdzXG5jb25zdCBCaXRmaW5leEV4Y2hhbmdlQ29ubmVjdGlvbiA9IHJlcXVpcmUoJy4uLy4uL2V4Y2hhbmdlX2NsaWVudHMvYml0ZmluZXgnKVxuY29uc3QgeyBub3RpZnlJbmZvLCBub3RpZnlFcnJvciwgbm90aWZ5U3VjY2VzcyB9ID0gcmVxdWlyZSgnLi4vLi4vdXRpbC93cy9ub3RpZnknKVxuY29uc3Qgc2VuZCA9IHJlcXVpcmUoJy4uLy4uL3V0aWwvd3Mvc2VuZCcpXG5cbi8qKlxuICogQnJvYWRjYXN0IG5vdGlmaWNhdGlvbiBwYXlsb2FkLCBmb3JtYXQgdmFyaWVzIGJhc2VkIG9uIHNvdXJjZVxuICpcbiAqIEB0eXBlZGVmIHtvYmplY3R9IFVDTVBheWxvYWRcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbbGV2ZWxdIC0gbm90aWZpY2F0aW9uIHR5cGVcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbdHlwZV0gLSBhbGlhcyBmb3IgbGV2ZWxcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbc3RhdHVzXSAtIGFsaWFzIGZvciBsZXZlbFxuICogQHByb3BlcnR5IHtzdHJpbmd9IFttZXNzYWdlXSAtIG5vdGlmaWNhdGlvbiBtZXNzYWdlXG4gKiBAcHJvcGVydHkge3N0cmluZ30gW21zZ10gLSBhbGlhcyBmb3IgbWVzc2FnZVxuICogQHByb3BlcnR5IHtzdHJpbmd9IFt0ZXh0XSAtIGFsaWFzIGZvciBtZXNzYWdlXG4gKi9cblxubW9kdWxlLmV4cG9ydHMgPSBhc3luYyAod3MsIGFwaUtleSwgYXBpU2VjcmV0LCBkYiwgZCkgPT4ge1xuICBub3RpZnlJbmZvKHdzLCAnQ29ubmVjdGluZyB0byBCaXRmaW5leC4uLicpXG5cbiAgY29uc3QgeyBVc2VyU2V0dGluZ3MgfSA9IGRiXG4gIGNvbnN0IHsgdXNlclNldHRpbmdzOiBzZXR0aW5ncyB9ID0gYXdhaXQgVXNlclNldHRpbmdzLmdldEFsbCgpXG4gIGNvbnN0IGNsaWVudCA9IG5ldyBCaXRmaW5leEV4Y2hhbmdlQ29ubmVjdGlvbigpXG4gIGNvbnN0IHsgZG1zIH0gPSBzZXR0aW5ncyB8fCBERUZBVUxUX1NFVFRJTkdTXG5cbiAgZCgnb3BlbmluZyBhdXRoIGJmeCBjb25uZWN0aW9uIChkbXMgJXMpJywgZG1zID8gJ2VuYWJsZWQnIDogJ2Rpc2FibGVkJylcblxuICBjbGllbnQuc2V0QXV0aEFyZ3MoeyBkbXM6IGRtcyA/IDQgOiAwIH0pXG4gIGNsaWVudC5vcGVuV1Moe1xuICAgIGFwaUtleSxcbiAgICBhcGlTZWNyZXRcbiAgfSlcblxuICBjbGllbnQub24oJ2Vycm9yJywgKGVycikgPT4ge1xuICAgIG5vdGlmeUVycm9yKHdzLCBgQml0ZmluZXggLSAke2Vyci5tZXNzYWdlfWApXG4gIH0pXG5cbiAgY2xpZW50Lm9uKCdvcGVuJywgKCkgPT4ge1xuICAgIG5vdGlmeUluZm8od3MsICdDb25uZWN0ZWQgdG8gQml0ZmluZXgnKVxuICB9KVxuXG4gIGNsaWVudC5vbignYXV0aCcsICgpID0+IHtcbiAgICBub3RpZnlTdWNjZXNzKHdzLCAnQXV0aGVudGljYXRlZCB3aXRoIEJpdGZpbmV4JylcbiAgICBzZW5kKHdzLCBbJ2RhdGEuY2xpZW50JywgJ2JpdGZpbmV4JywgMl0pIC8vIFRPRE86IEV4dHJhY3QgY2xpZW50IHN0YXRlIGludG8gZW51bVxuICB9KVxuXG4gIGNsaWVudC5vbignY2xvc2UnLCAoKSA9PiB7XG4gICAgbm90aWZ5SW5mbyh3cywgJ0Rpc2Nvbm5lY3RlZCBmcm9tIEJpdGZpbmV4JylcbiAgICBzZW5kKHdzLCBbJ2RhdGEuY2xpZW50JywgJ2JpdGZpbmV4JywgMF0pXG4gIH0pXG5cbiAgY2xpZW50Lm9uRGF0YSgoY2hhbklELCBwYXlsb2FkKSA9PiB7XG4gICAgaWYgKGNoYW5JRCAhPT0gMCkgcmV0dXJuXG5cbiAgICBjb25zdCBbLCBtc2dUeXBlLCBtc2dEYXRhXSA9IHBheWxvYWRcblxuICAgIHN3aXRjaCAobXNnVHlwZSkge1xuICAgICAgY2FzZSAnd3MnOiB7XG4gICAgICAgIHNlbmQod3MsIFsnZGF0YS5iYWxhbmNlcycsICdiaXRmaW5leCcsIEJpdGZpbmV4RXhjaGFuZ2VDb25uZWN0aW9uLnRyYW5zZm9ybUJhbGFuY2VzKG1zZ0RhdGEpXSlcbiAgICAgICAgYnJlYWtcbiAgICAgIH1cblxuICAgICAgY2FzZSAnd3UnOiB7XG4gICAgICAgIHNlbmQod3MsIFsnZGF0YS5iYWxhbmNlJywgJ2JpdGZpbmV4JywgQml0ZmluZXhFeGNoYW5nZUNvbm5lY3Rpb24udHJhbnNmb3JtQmFsYW5jZShtc2dEYXRhKV0pXG4gICAgICAgIGJyZWFrXG4gICAgICB9XG5cbiAgICAgIGNhc2UgJ3BzJzoge1xuICAgICAgICBzZW5kKHdzLCBbJ2RhdGEucG9zaXRpb25zJywgJ2JpdGZpbmV4JywgbXNnRGF0YV0pXG4gICAgICAgIGJyZWFrXG4gICAgICB9XG5cbiAgICAgIGNhc2UgJ3B1Jzoge1xuICAgICAgICBzZW5kKHdzLCBbJ2RhdGEucG9zaXRpb24nLCAnYml0ZmluZXgnLCBtc2dEYXRhXSlcbiAgICAgICAgYnJlYWtcbiAgICAgIH1cblxuICAgICAgY2FzZSAncGMnOiB7XG4gICAgICAgIHNlbmQod3MsIFsnZGF0YS5wb3NpdGlvbi5jbG9zZScsICdiaXRmaW5leCcsIG1zZ0RhdGFdKVxuICAgICAgICBicmVha1xuICAgICAgfVxuXG4gICAgICBjYXNlICdvcyc6IHtcbiAgICAgICAgc2VuZCh3cywgWydkYXRhLm9yZGVycycsICdiaXRmaW5leCcsIEJpdGZpbmV4RXhjaGFuZ2VDb25uZWN0aW9uLnRyYW5zZm9ybU9yZGVycyhtc2dEYXRhKV0pXG4gICAgICAgIGJyZWFrXG4gICAgICB9XG5cbiAgICAgIGNhc2UgJ29uJzpcbiAgICAgIGNhc2UgJ291Jzoge1xuICAgICAgICBzZW5kKHdzLCBbJ2RhdGEub3JkZXInLCAnYml0ZmluZXgnLCBCaXRmaW5leEV4Y2hhbmdlQ29ubmVjdGlvbi50cmFuc2Zvcm1PcmRlcihtc2dEYXRhKV0pXG4gICAgICAgIGJyZWFrXG4gICAgICB9XG5cbiAgICAgIGNhc2UgJ29jJzoge1xuICAgICAgICBzZW5kKHdzLCBbJ2RhdGEub3JkZXIuY2xvc2UnLCAnYml0ZmluZXgnLCBCaXRmaW5leEV4Y2hhbmdlQ29ubmVjdGlvbi50cmFuc2Zvcm1PcmRlcihtc2dEYXRhKV0pXG4gICAgICAgIGJyZWFrXG4gICAgICB9XG5cbiAgICAgIGNhc2UgJ24nOiB7XG4gICAgICAgIGxldCBbLCwsLCwsIHN0YXR1cywgdGV4dF0gPSBtc2dEYXRhXG4gICAgICAgIGNvbnN0IHVjbVBheWxvYWQgPSAvKiogQHR5cGUge1VDTVBheWxvYWR9ICovIChtc2dEYXRhWzRdKVxuXG4gICAgICAgIC8vIFRoZSBwYXlsb2FkIGlzIGZsdWlkIGFuZCBjYW4gaGF2ZSBhbnkgZm9ybWF0OyBIRiB1c2VzIGxldmVsICYgbWVzc2FnZVxuICAgICAgICBpZiAoX2lzT2JqZWN0KHVjbVBheWxvYWQpICYmICFfaXNFbXB0eSh1Y21QYXlsb2FkKSkge1xuICAgICAgICAgIHN0YXR1cyA9IHVjbVBheWxvYWQubGV2ZWwgfHwgdWNtUGF5bG9hZC50eXBlIHx8IHVjbVBheWxvYWQuc3RhdHVzXG4gICAgICAgICAgdGV4dCA9IHVjbVBheWxvYWQubWVzc2FnZSB8fCB1Y21QYXlsb2FkLm1zZyB8fCB1Y21QYXlsb2FkLnRleHRcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChfaXNTdHJpbmcoc3RhdHVzKSAmJiBfaXNTdHJpbmcodGV4dCkgJiYgIV9pc0VtcHR5KHN0YXR1cykgJiYgIV9pc0VtcHR5KHRleHQpKSB7XG4gICAgICAgICAgaWYgKHN0YXR1cy50b0xvd2VyQ2FzZSgpID09PSAnc3VjY2VzcycpIHtcbiAgICAgICAgICAgIG5vdGlmeVN1Y2Nlc3Mod3MsIHRleHQpXG4gICAgICAgICAgfSBlbHNlIGlmIChzdGF0dXMudG9Mb3dlckNhc2UoKSA9PT0gJ2luZm8nKSB7XG4gICAgICAgICAgICBub3RpZnlJbmZvKHdzLCB0ZXh0KVxuICAgICAgICAgIH0gZWxzZSBpZiAoc3RhdHVzLnRvTG93ZXJDYXNlKCkgPT09ICdlcnJvcicpIHtcbiAgICAgICAgICAgIG5vdGlmeUVycm9yKHdzLCB0ZXh0KVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGJyZWFrXG4gICAgICB9XG4gICAgfVxuICB9KVxuXG4gIHNlbmQod3MsIFsnZGF0YS5jbGllbnQnLCAnYml0ZmluZXgnLCAxXSlcblxuICBjbGllbnQub3BlblNvY2tldCgpXG5cbiAgcmV0dXJuIGNsaWVudFxufVxuIl19