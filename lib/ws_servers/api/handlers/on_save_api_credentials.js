'use strict';

const _capitalize = require('lodash/capitalize');

const send = require('../../../util/ws/send');
const sendError = require('../../../util/ws/send_error');
const validateParams = require('../../../util/ws/validate_params');
const {
  notifyInternalError, notifySuccess, notifyError } =
require('../../../util/ws/notify');
const validExchange = require('../../../util/valid_exchange');
const verifyPassword = require('../../../util/verify_password');
const encryptAPICredentials = require('../../../util/encrypt_api_credentials');
const isAuthorized = require('../../../util/ws/is_authorized');
const capture = require('../../../capture');
const openAuthBitfinexConnection = require('../open_auth_bitfinex_connection');
const openAuthBinanceConnection = require('../open_auth_binance_connection');

module.exports = async (server, ws, msg) => {
  const { d, db } = server;
  const [, authToken, exID, apiKey, apiSecret] = msg;
  const validRequest = validateParams(ws, {
    exID: { type: 'string', v: exID },
    authToken: { type: 'string', v: authToken },
    apiKey: { type: 'string', v: apiKey },
    apiSecret: { type: 'string', v: apiSecret } });


  if (!validRequest) {
    return;
  } else if (!isAuthorized(ws, authToken)) {
    return sendError(ws, 'Unauthorized');
  } else if (!validExchange(exID)) {
    return sendError(ws, 'Unrecognised exchange, cannot save API credentials');
  }

  // TODO: Move into isAuthorized()
  let authControl;

  try {
    authControl = await verifyPassword(db, ws.authPassword);

    if (!authControl || ws.authControl !== authControl) {
      return notifyError(ws, 'Invalid password');
    }
  } catch (e) {
    capture.exception(e);
    return notifyInternalError(ws);
  }

  const { Credential } = db;
  const credentials = await encryptAPICredentials({
    exID,
    password: ws.authPassword,
    key: apiKey,
    secret: apiSecret });


  await Credential.set(credentials);

  d('saved API credentials for %s', exID);

  ws[`${exID}Credentials`] = {
    key: apiKey,
    secret: apiSecret };


  notifySuccess(ws, `Encrypted API credentials saved for ${_capitalize(exID)}`);
  send(ws, ['data.api_credentials.configured', exID]);

  d('issuing API & Algo reconnect due to credentials change');

  if (ws.clients.bitfinex) {
    ws.clients.bitfinex.setAuthArgs({
      apiKey,
      apiSecret });

  }

  ws.aoc.reconnect();
  Object.values(ws.clients).forEach(ex => ex.reconnect());

  notifySuccess(ws, 'Reconnecting with new credentials...');

  // Open algo host if needed
  const isHostOpen = await ws.aoc.isHostOpen(exID);

  if (isHostOpen) {
    return;
  }

  switch (exID) {
    case 'bitfinex':{
        ws.aoc.openHost('bitfinex', apiKey, apiSecret);
        ws.clients.bitfinex = await openAuthBitfinexConnection(ws, apiKey, apiSecret, db, d);
        break;
      }

    case 'binance':{
        ws.aoc.openHost('binance', apiKey, apiSecret);
        ws.clients.binance = openAuthBinanceConnection(ws, apiKey, apiSecret);
        break;
      }

    default:{
        d('unknown exID broke through: %s', exID);
        notifyInternalError(ws);
        break;
      }}

};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy93c19zZXJ2ZXJzL2FwaS9oYW5kbGVycy9vbl9zYXZlX2FwaV9jcmVkZW50aWFscy5qcyJdLCJuYW1lcyI6WyJfY2FwaXRhbGl6ZSIsInJlcXVpcmUiLCJzZW5kIiwic2VuZEVycm9yIiwidmFsaWRhdGVQYXJhbXMiLCJub3RpZnlJbnRlcm5hbEVycm9yIiwibm90aWZ5U3VjY2VzcyIsIm5vdGlmeUVycm9yIiwidmFsaWRFeGNoYW5nZSIsInZlcmlmeVBhc3N3b3JkIiwiZW5jcnlwdEFQSUNyZWRlbnRpYWxzIiwiaXNBdXRob3JpemVkIiwiY2FwdHVyZSIsIm9wZW5BdXRoQml0ZmluZXhDb25uZWN0aW9uIiwib3BlbkF1dGhCaW5hbmNlQ29ubmVjdGlvbiIsIm1vZHVsZSIsImV4cG9ydHMiLCJzZXJ2ZXIiLCJ3cyIsIm1zZyIsImQiLCJkYiIsImF1dGhUb2tlbiIsImV4SUQiLCJhcGlLZXkiLCJhcGlTZWNyZXQiLCJ2YWxpZFJlcXVlc3QiLCJ0eXBlIiwidiIsImF1dGhDb250cm9sIiwiYXV0aFBhc3N3b3JkIiwiZSIsImV4Y2VwdGlvbiIsIkNyZWRlbnRpYWwiLCJjcmVkZW50aWFscyIsInBhc3N3b3JkIiwia2V5Iiwic2VjcmV0Iiwic2V0IiwiY2xpZW50cyIsImJpdGZpbmV4Iiwic2V0QXV0aEFyZ3MiLCJhb2MiLCJyZWNvbm5lY3QiLCJPYmplY3QiLCJ2YWx1ZXMiLCJmb3JFYWNoIiwiZXgiLCJpc0hvc3RPcGVuIiwib3Blbkhvc3QiLCJiaW5hbmNlIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQSxNQUFNQSxXQUFXLEdBQUdDLE9BQU8sQ0FBQyxtQkFBRCxDQUEzQjs7QUFFQSxNQUFNQyxJQUFJLEdBQUdELE9BQU8sQ0FBQyx1QkFBRCxDQUFwQjtBQUNBLE1BQU1FLFNBQVMsR0FBR0YsT0FBTyxDQUFDLDZCQUFELENBQXpCO0FBQ0EsTUFBTUcsY0FBYyxHQUFHSCxPQUFPLENBQUMsa0NBQUQsQ0FBOUI7QUFDQSxNQUFNO0FB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RUFBRSxDQUFDcUIsT0FBSCxDQUFXQyxRQUFYLEdBQXNCLE1BQU0zQiwwQkFBMEIsQ0FBQ0ssRUFBRCxFQUFLTSxNQUFMLEVBQWFDLFNBQWIsRUFBd0JKLEVBQXhCLEVBQTRCRCxDQUE1QixDQUF0RDtBQUNBO0FBQ0Q7O0FBRUQsU0FBSyxTQUFMLENBQWdCO0FBQ2RGLFFBQUFBLEVBQUUsQ0FBQ3dCLEdBQUgsQ0FBT08sUUFBUCxDQUFnQixTQUFoQixFQUEyQnpCLE1BQTNCLEVBQW1DQyxTQUFuQztBQUNBUCxRQUFBQSxFQUFFLENBQUNxQixPQUFILENBQVdXLE9BQVgsR0FBcUJwQyx5QkFBeUIsQ0FBQ0ksRUFBRCxFQUFLTSxNQUFMLEVBQWFDLFNBQWIsQ0FBOUM7QUFDQTtBQUNEOztBQUVELFlBQVM7QUFDUEwsUUFBQUEsQ0FBQyxDQUFDLGdDQUFELEVBQW1DRyxJQUFuQyxDQUFEO0FBQ0FsQixRQUFBQSxtQkFBbUIsQ0FBQ2EsRUFBRCxDQUFuQjtBQUNBO0FBQ0QsT0FqQkg7O0FBbUJELENBNUZEIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnXG5cbmNvbnN0IF9jYXBpdGFsaXplID0gcmVxdWlyZSgnbG9kYXNoL2NhcGl0YWxpemUnKVxuXG5jb25zdCBzZW5kID0gcmVxdWlyZSgnLi4vLi4vLi4vdXRpbC93cy9zZW5kJylcbmNvbnN0IHNlbmRFcnJvciA9IHJlcXVpcmUoJy4uLy4uLy4uL3V0aWwvd3Mvc2VuZF9lcnJvcicpXG5jb25zdCB2YWxpZGF0ZVBhcmFtcyA9IHJlcXVpcmUoJy4uLy4uLy4uL3V0aWwvd3MvdmFsaWRhdGVfcGFyYW1zJylcbmNvbnN0IHtcbiAgbm90aWZ5SW50ZXJuYWxFcnJvciwgbm90aWZ5U3VjY2Vzcywgbm90aWZ5RXJyb3Jcbn0gPSByZXF1aXJlKCcuLi8uLi8uLi91dGlsL3dzL25vdGlmeScpXG5jb25zdCB2YWxpZEV4Y2hhbmdlID0gcmVxdWlyZSgnLi4vLi4vLi4vdXRpbC92YWxpZF9leGNoYW5nZScpXG5jb25zdCB2ZXJpZnlQYXNzd29yZCA9IHJlcXVpcmUoJy4uLy4uLy4uL3V0aWwvdmVyaWZ5X3Bhc3N3b3JkJylcbmNvbnN0IGVuY3J5cHRBUElDcmVkZW50aWFscyA9IHJlcXVpcmUoJy4uLy4uLy4uL3V0aWwvZW5jcnlwdF9hcGlfY3JlZGVudGlhbHMnKVxuY29uc3QgaXNBdXRob3JpemVkID0gcmVxdWlyZSgnLi4vLi4vLi4vdXRpbC93cy9pc19hdXRob3JpemVkJylcbmNvbnN0IGNhcHR1cmUgPSByZXF1aXJlKCcuLi8uLi8uLi9jYXB0dXJlJylcbmNvbnN0IG9wZW5BdXRoQml0ZmluZXhDb25uZWN0aW9uID0gcmVxdWlyZSgnLi4vb3Blbl9hdXRoX2JpdGZpbmV4X2Nvbm5lY3Rpb24nKVxuY29uc3Qgb3BlbkF1dGhCaW5hbmNlQ29ubmVjdGlvbiA9IHJlcXVpcmUoJy4uL29wZW5fYXV0aF9iaW5hbmNlX2Nvbm5lY3Rpb24nKVxuXG5tb2R1bGUuZXhwb3J0cyA9IGFzeW5jIChzZXJ2ZXIsIHdzLCBtc2cpID0+IHtcbiAgY29uc3QgeyBkLCBkYiB9ID0gc2VydmVyXG4gIGNvbnN0IFssIGF1dGhUb2tlbiwgZXhJRCwgYXBpS2V5LCBhcGlTZWNyZXRdID0gbXNnXG4gIGNvbnN0IHZhbGlkUmVxdWVzdCA9IHZhbGlkYXRlUGFyYW1zKHdzLCB7XG4gICAgZXhJRDogeyB0eXBlOiAnc3RyaW5nJywgdjogZXhJRCB9LFxuICAgIGF1dGhUb2tlbjogeyB0eXBlOiAnc3RyaW5nJywgdjogYXV0aFRva2VuIH0sXG4gICAgYXBpS2V5OiB7IHR5cGU6ICdzdHJpbmcnLCB2OiBhcGlLZXkgfSxcbiAgICBhcGlTZWNyZXQ6IHsgdHlwZTogJ3N0cmluZycsIHY6IGFwaVNlY3JldCB9XG4gIH0pXG5cbiAgaWYgKCF2YWxpZFJlcXVlc3QpIHtcbiAgICByZXR1cm5cbiAgfSBlbHNlIGlmICghaXNBdXRob3JpemVkKHdzLCBhdXRoVG9rZW4pKSB7XG4gICAgcmV0dXJuIHNlbmRFcnJvcih3cywgJ1VuYXV0aG9yaXplZCcpXG4gIH0gZWxzZSBpZiAoIXZhbGlkRXhjaGFuZ2UoZXhJRCkpIHtcbiAgICByZXR1cm4gc2VuZEVycm9yKHdzLCAnVW5yZWNvZ25pc2VkIGV4Y2hhbmdlLCBjYW5ub3Qgc2F2ZSBBUEkgY3JlZGVudGlhbHMnKVxuICB9XG5cbiAgLy8gVE9ETzogTW92ZSBpbnRvIGlzQXV0aG9yaXplZCgpXG4gIGxldCBhdXRoQ29udHJvbFxuXG4gIHRyeSB7XG4gICAgYXV0aENvbnRyb2wgPSBhd2FpdCB2ZXJpZnlQYXNzd29yZChkYiwgd3MuYXV0aFBhc3N3b3JkKVxuXG4gICAgaWYgKCFhdXRoQ29udHJvbCB8fCB3cy5hdXRoQ29udHJvbCAhPT0gYXV0aENvbnRyb2wpIHtcbiAgICAgIHJldHVybiBub3RpZnlFcnJvcih3cywgJ0ludmFsaWQgcGFzc3dvcmQnKVxuICAgIH1cbiAgfSBjYXRjaCAoZSkge1xuICAgIGNhcHR1cmUuZXhjZXB0aW9uKGUpXG4gICAgcmV0dXJuIG5vdGlmeUludGVybmFsRXJyb3Iod3MpXG4gIH1cblxuICBjb25zdCB7IENyZWRlbnRpYWwgfSA9IGRiXG4gIGNvbnN0IGNyZWRlbnRpYWxzID0gYXdhaXQgZW5jcnlwdEFQSUNyZWRlbnRpYWxzKHtcbiAgICBleElELFxuICAgIHBhc3N3b3JkOiB3cy5hdXRoUGFzc3dvcmQsXG4gICAga2V5OiBhcGlLZXksXG4gICAgc2VjcmV0OiBhcGlTZWNyZXRcbiAgfSlcblxuICBhd2FpdCBDcmVkZW50aWFsLnNldChjcmVkZW50aWFscylcblxuICBkKCdzYXZlZCBBUEkgY3JlZGVudGlhbHMgZm9yICVzJywgZXhJRClcblxuICB3c1tgJHtleElEfUNyZWRlbnRpYWxzYF0gPSB7XG4gICAga2V5OiBhcGlLZXksXG4gICAgc2VjcmV0OiBhcGlTZWNyZXRcbiAgfVxuXG4gIG5vdGlmeVN1Y2Nlc3Mod3MsIGBFbmNyeXB0ZWQgQVBJIGNyZWRlbnRpYWxzIHNhdmVkIGZvciAke19jYXBpdGFsaXplKGV4SUQpfWApXG4gIHNlbmQod3MsIFsnZGF0YS5hcGlfY3JlZGVudGlhbHMuY29uZmlndXJlZCcsIGV4SURdKVxuXG4gIGQoJ2lzc3VpbmcgQVBJICYgQWxnbyByZWNvbm5lY3QgZHVlIHRvIGNyZWRlbnRpYWxzIGNoYW5nZScpXG5cbiAgaWYgKHdzLmNsaWVudHMuYml0ZmluZXgpIHtcbiAgICB3cy5jbGllbnRzLmJpdGZpbmV4LnNldEF1dGhBcmdzKHtcbiAgICAgIGFwaUtleSxcbiAgICAgIGFwaVNlY3JldFxuICAgIH0pXG4gIH1cblxuICB3cy5hb2MucmVjb25uZWN0KClcbiAgT2JqZWN0LnZhbHVlcyh3cy5jbGllbnRzKS5mb3JFYWNoKGV4ID0+IGV4LnJlY29ubmVjdCgpKVxuXG4gIG5vdGlmeVN1Y2Nlc3Mod3MsICdSZWNvbm5lY3Rpbmcgd2l0aCBuZXcgY3JlZGVudGlhbHMuLi4nKVxuXG4gIC8vIE9wZW4gYWxnbyBob3N0IGlmIG5lZWRlZFxuICBjb25zdCBpc0hvc3RPcGVuID0gYXdhaXQgd3MuYW9jLmlzSG9zdE9wZW4oZXhJRClcblxuICBpZiAoaXNIb3N0T3Blbikge1xuICAgIHJldHVyblxuICB9XG5cbiAgc3dpdGNoIChleElEKSB7XG4gICAgY2FzZSAnYml0ZmluZXgnOiB7XG4gICAgICB3cy5hb2Mub3Blbkhvc3QoJ2JpdGZpbmV4JywgYXBpS2V5LCBhcGlTZWNyZXQpXG4gICAgICB3cy5jbGllbnRzLmJpdGZpbmV4ID0gYXdhaXQgb3BlbkF1dGhCaXRmaW5leENvbm5lY3Rpb24od3MsIGFwaUtleSwgYXBpU2VjcmV0LCBkYiwgZClcbiAgICAgIGJyZWFrXG4gICAgfVxuXG4gICAgY2FzZSAnYmluYW5jZSc6IHtcbiAgICAgIHdzLmFvYy5vcGVuSG9zdCgnYmluYW5jZScsIGFwaUtleSwgYXBpU2VjcmV0KVxuICAgICAgd3MuY2xpZW50cy5iaW5hbmNlID0gb3BlbkF1dGhCaW5hbmNlQ29ubmVjdGlvbih3cywgYXBpS2V5LCBhcGlTZWNyZXQpXG4gICAgICBicmVha1xuICAgIH1cblxuICAgIGRlZmF1bHQ6IHtcbiAgICAgIGQoJ3Vua25vd24gZXhJRCBicm9rZSB0aHJvdWdoOiAlcycsIGV4SUQpXG4gICAgICBub3RpZnlJbnRlcm5hbEVycm9yKHdzKVxuICAgICAgYnJlYWtcbiAgICB9XG4gIH1cbn1cbiJdfQ==