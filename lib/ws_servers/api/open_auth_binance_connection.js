'use strict';

const _isFinite = require('lodash/isFinite');
const _flatten = require('lodash/flatten');
const BinanceExchangeConnection = require('../../exchange_clients/binance');
const {
  notifyInfo, notifyError, notifyOrderExecuted, notifySuccess } =
require('../../util/ws/notify');
const sendError = require('../../util/ws/send_error');
const send = require('../../util/ws/send');
const capture = require('../../capture');
const { BigNumber: BigN } = require('bignumber.js');

const rejectReasonTransformer = require('../../exchange_clients/binance/transformers/reject_reason');
const wsBalancesTransformer = require('../../exchange_clients/binance/transformers/ws_balances');
const sendBalances = require('./send_balances');
const sendOrders = require('./send_orders');

module.exports = (ws, apiKey, apiSecret) => {
  const client = new BinanceExchangeConnection({
    apiKey,
    apiSecret });


  send(ws, ['data.client', 'binance', 2]);
  notifyInfo(ws, 'Binance connection prepared for orders');

  // TODO: Refactor plm
  // TODO: Use handlebars templates for notifications
  client.userStream(msg => {
    const { eventType } = msg;

    if (eventType === 'account') {
      const { balances = {} } = msg;
      send(ws, ['data.balances', 'binance', wsBalancesTransformer(balances)]);
      return;
    }

    if (eventType !== 'executionReport') {
      console.log(msg);
      return;
    }

    if (msg.orderStatus === 'FILLED') {
      send(ws, [
      'data.order.close',
      'binance',
      BinanceExchangeConnection.transformOrder(msg)]);


      notifyOrderExecuted(ws, 'binance', {
        amount: +msg.quantity * (msg.side === 'SELL' ? -1 : 1),
        price: new BigN(msg.price).toString(10),
        symbol: msg.symbol,
        type: msg.orderType });

    } else if (msg.orderStatus === 'PARTIALLY_FILLED') {
      send(ws, [
      'data.order',
      'binance',
      BinanceExchangeConnection.transformOrder(msg)]);


      notifySuccess(ws, _flatten([
      'Binance order partially filled on', msg.symbol, msg.side,
      _isFinite(+msg.price) && +msg.price > 0 && [
      +msg.quantity, '@', new BigN(msg.price).toString(10)]]).

      filter(t => !!t).join(' '));
    } else if (msg.orderStatus === 'NEW') {
      send(ws, [
      'data.order',
      'binance',
      BinanceExchangeConnection.transformOrder(msg)]);


      notifySuccess(ws, _flatten([
      'Binance order created on', msg.symbol, msg.side,
      _isFinite(+msg.price) && +msg.price > 0 && [
      +msg.quantity, '@', new BigN(msg.price).toString(10)]]).

      filter(t => !!t).join(' '));
    } else if (msg.orderStatus === 'REJECTED') {
      const { orderRejectReason } = msg;
      const humanReason = rejectReasonTransformer(orderRejectReason);

      notifyError(ws, _flatten([
      'Binance order cancelled on', msg.symbol, msg.side,
      _isFinite(+msg.price) && +msg.price > 0 && [
      +msg.quantity, '@', new BigN(msg.price).toString(10)],
      `: ${humanReason}`]).
      filter(t => !!t).join(' '));
    } else if (msg.orderStatus === 'CANCELED') {
      send(ws, [
      'data.order.close',
      'binance',
      BinanceExchangeConnection.transformOrder(msg)]);


      notifyInfo(ws, _flatten([
      'Binance order cancelled on', msg.symbol, msg.side,
      _isFinite(+msg.price) && +msg.price > 0 && [
      +msg.quantity, '@', new BigN(msg.price).toString(10)]]).

      filter(t => !!t).join(' '));
    }
  });

  sendBalances(ws, 'binance', client).catch(e => {
    capture.exception(e);
    sendError(ws, `Failed to update Binance balances: ${e.message}`);
  });

  sendOrders(ws, 'binance', client).catch(e => {
    capture.exception(e);
    sendError(ws, `Failed to update Binance orders: ${e.message}`);
  });

  return client;
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy93c19zZXJ2ZXJzL2FwaS9vcGVuX2F1dGhfYmluYW5jZV9jb25uZWN0aW9uLmpzIl0sIm5hbWVzIjpbIl9pc0Zpbml0ZSIsInJlcXVpcmUiLCJfZmxhdHRlbiIsIkJpbmFuY2VFeGNoYW5nZUNvbm5lY3Rpb24iLCJub3RpZnlJbmZvIiwibm90aWZ5RXJyb3IiLCJub3RpZnlPcmRlckV4ZWN1dGVkIiwibm90aWZ5U3VjY2VzcyIsInNlbmRFcnJvciIsInNlbmQiLCJjYXB0dXJlIiwiQmlnTnVtYmVyIiwiQmlnTiIsInJlamVjdFJlYXNvblRyYW5zZm9ybWVyIiwid3NCYWxhbmNlc1RyYW5zZm9ybWVyIiwic2VuZEJhbGFuY2VzIiwic2VuZE9yZGVycyIsIm1vZHVsZSIsImV4cG9ydHMiLCJ3cyIsImFwaUtleSIsImFwaVNlY3JldCIsImNsaWVudCIsInVzZXJTdHJlYW0iLCJtc2ciLCJldmVudFR5cGUiLCJiYWxhbmNlcyIsImNvbnNvbGUiLCJsb2ciLCJvcmRlclN0YXR1cyIsInRyYW5zZm9ybU9yZGVyIiwiYW1vdW50IiwicXVhbnRpdHkiLCJzaWRlIiwicHJpY2UiLCJ0b1N0cmluZyIsInN5bWJvbCIsInR5cGUiLCJvcmRlclR5cGUiLCJmaWx0ZXIiLCJ0Iiwiam9pbiIsIm9yZGVyUmVqZWN0UmVhc29uIiwiaHVtYW5SZWFzb24iLCJjYXRjaCIsImUiLCJleGNlcHRpb24iLCJtZXNzYWdlIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQSxNQUFNQSxTQUFTLEdBQUdDLE9BQU8sQ0FBQyxpQkFBRCxDQUF6QjtBQUNBLE1BQU1DLFFBQVEsR0FBR0QsT0FBTyxDQUFDLGdCQUFELENBQXhCO0FBQ0EsTUFBTUUseUJBQXlCLEdBQUdGLE9BQU8sQ0FBQyxnQ0FBRCxDQUF6QztBQUNBLE1BQU07QUFDSkcsRUFBQUEsVUFESSxFQUNRQyxXQURSLEVBQ3FCQyxtQkFEckIsRUFDMENDLGFBRDFDO0FBRUZOLE9BQU8sQ0FBQyxzQkFBRCxDQUZYO0FB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Q0FBVCxJQUF5QixDQUFDVixHQUFHLENBQUNVLEtBQUwsR0FBYSxDQUF0QyxJQUEyQztBQUN6QyxPQUFDVixHQUFHLENBQUNRLFFBRG9DLEVBQzFCLEdBRDBCLEVBQ3JCLElBQUlwQixJQUFKLENBQVNZLEdBQUcsQ0FBQ1UsS0FBYixFQUFvQkMsUUFBcEIsQ0FBNkIsRUFBN0IsQ0FEcUIsQ0FGckIsQ0FBRCxDQUFSOztBQUtaSSxNQUFBQSxNQUxZLENBS0xDLENBQUMsSUFBSSxDQUFDLENBQUNBLENBTEYsRUFLS0MsSUFMTCxDQUtVLEdBTFYsQ0FBTCxDQUFWO0FBTUQ7QUFDRixHQTdFRDs7QUErRUExQixFQUFBQSxZQUFZLENBQUNJLEVBQUQsRUFBSyxTQUFMLEVBQWdCRyxNQUFoQixDQUFaLENBQW9Dc0IsS0FBcEMsQ0FBMkNDLENBQUQsSUFBTztBQUMvQ25DLElBQUFBLE9BQU8sQ0FBQ29DLFNBQVIsQ0FBa0JELENBQWxCO0FBQ0FyQyxJQUFBQSxTQUFTLENBQUNXLEVBQUQsRUFBTSxzQ0FBcUMwQixDQUFDLENBQUNFLE9BQVEsRUFBckQsQ0FBVDtBQUNELEdBSEQ7O0FBS0EvQixFQUFBQSxVQUFVLENBQUNHLEVBQUQsRUFBSyxTQUFMLEVBQWdCRyxNQUFoQixDQUFWLENBQWtDc0IsS0FBbEMsQ0FBeUNDLENBQUQsSUFBTztBQUM3Q25DLElBQUFBLE9BQU8sQ0FBQ29DLFNBQVIsQ0FBa0JELENBQWxCO0FBQ0FyQyxJQUFBQSxTQUFTLENBQUNXLEVBQUQsRUFBTSxvQ0FBbUMwQixDQUFDLENBQUNFLE9BQVEsRUFBbkQsQ0FBVDtBQUNELEdBSEQ7O0FBS0EsU0FBT3pCLE1BQVA7QUFDRCxDQXJHRCIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0J1xuXG5jb25zdCBfaXNGaW5pdGUgPSByZXF1aXJlKCdsb2Rhc2gvaXNGaW5pdGUnKVxuY29uc3QgX2ZsYXR0ZW4gPSByZXF1aXJlKCdsb2Rhc2gvZmxhdHRlbicpXG5jb25zdCBCaW5hbmNlRXhjaGFuZ2VDb25uZWN0aW9uID0gcmVxdWlyZSgnLi4vLi4vZXhjaGFuZ2VfY2xpZW50cy9iaW5hbmNlJylcbmNvbnN0IHtcbiAgbm90aWZ5SW5mbywgbm90aWZ5RXJyb3IsIG5vdGlmeU9yZGVyRXhlY3V0ZWQsIG5vdGlmeVN1Y2Nlc3Ncbn0gPSByZXF1aXJlKCcuLi8uLi91dGlsL3dzL25vdGlmeScpXG5jb25zdCBzZW5kRXJyb3IgPSByZXF1aXJlKCcuLi8uLi91dGlsL3dzL3NlbmRfZXJyb3InKVxuY29uc3Qgc2VuZCA9IHJlcXVpcmUoJy4uLy4uL3V0aWwvd3Mvc2VuZCcpXG5jb25zdCBjYXB0dXJlID0gcmVxdWlyZSgnLi4vLi4vY2FwdHVyZScpXG5jb25zdCB7IEJpZ051bWJlcjogQmlnTiB9ID0gcmVxdWlyZSgnYmlnbnVtYmVyLmpzJylcblxuY29uc3QgcmVqZWN0UmVhc29uVHJhbnNmb3JtZXIgPSByZXF1aXJlKCcuLi8uLi9leGNoYW5nZV9jbGllbnRzL2JpbmFuY2UvdHJhbnNmb3JtZXJzL3JlamVjdF9yZWFzb24nKVxuY29uc3Qgd3NCYWxhbmNlc1RyYW5zZm9ybWVyID0gcmVxdWlyZSgnLi4vLi4vZXhjaGFuZ2VfY2xpZW50cy9iaW5hbmNlL3RyYW5zZm9ybWVycy93c19iYWxhbmNlcycpXG5jb25zdCBzZW5kQmFsYW5jZXMgPSByZXF1aXJlKCcuL3NlbmRfYmFsYW5jZXMnKVxuY29uc3Qgc2VuZE9yZGVycyA9IHJlcXVpcmUoJy4vc2VuZF9vcmRlcnMnKVxuXG5tb2R1bGUuZXhwb3J0cyA9ICh3cywgYXBpS2V5LCBhcGlTZWNyZXQpID0+IHtcbiAgY29uc3QgY2xpZW50ID0gbmV3IEJpbmFuY2VFeGNoYW5nZUNvbm5lY3Rpb24oe1xuICAgIGFwaUtleSxcbiAgICBhcGlTZWNyZXRcbiAgfSlcblxuICBzZW5kKHdzLCBbJ2RhdGEuY2xpZW50JywgJ2JpbmFuY2UnLCAyXSlcbiAgbm90aWZ5SW5mbyh3cywgJ0JpbmFuY2UgY29ubmVjdGlvbiBwcmVwYXJlZCBmb3Igb3JkZXJzJylcblxuICAvLyBUT0RPOiBSZWZhY3RvciBwbG1cbiAgLy8gVE9ETzogVXNlIGhhbmRsZWJhcnMgdGVtcGxhdGVzIGZvciBub3RpZmljYXRpb25zXG4gIGNsaWVudC51c2VyU3RyZWFtKChtc2cpID0+IHtcbiAgICBjb25zdCB7IGV2ZW50VHlwZSB9ID0gbXNnXG5cbiAgICBpZiAoZXZlbnRUeXBlID09PSAnYWNjb3VudCcpIHtcbiAgICAgIGNvbnN0IHsgYmFsYW5jZXMgPSB7fSB9ID0gbXNnXG4gICAgICBzZW5kKHdzLCBbJ2RhdGEuYmFsYW5jZXMnLCAnYmluYW5jZScsIHdzQmFsYW5jZXNUcmFuc2Zvcm1lcihiYWxhbmNlcyldKVxuICAgICAgcmV0dXJuXG4gICAgfVxuXG4gICAgaWYgKGV2ZW50VHlwZSAhPT0gJ2V4ZWN1dGlvblJlcG9ydCcpIHtcbiAgICAgIGNvbnNvbGUubG9nKG1zZylcbiAgICAgIHJldHVyblxuICAgIH1cblxuICAgIGlmIChtc2cub3JkZXJTdGF0dXMgPT09ICdGSUxMRUQnKSB7XG4gICAgICBzZW5kKHdzLCBbXG4gICAgICAgICdkYXRhLm9yZGVyLmNsb3NlJyxcbiAgICAgICAgJ2JpbmFuY2UnLFxuICAgICAgICBCaW5hbmNlRXhjaGFuZ2VDb25uZWN0aW9uLnRyYW5zZm9ybU9yZGVyKG1zZylcbiAgICAgIF0pXG5cbiAgICAgIG5vdGlmeU9yZGVyRXhlY3V0ZWQod3MsICdiaW5hbmNlJywge1xuICAgICAgICBhbW91bnQ6ICttc2cucXVhbnRpdHkgKiAobXNnLnNpZGUgPT09ICdTRUxMJyA/IC0xIDogMSksXG4gICAgICAgIHByaWNlOiBuZXcgQmlnTihtc2cucHJpY2UpLnRvU3RyaW5nKDEwKSxcbiAgICAgICAgc3ltYm9sOiBtc2cuc3ltYm9sLFxuICAgICAgICB0eXBlOiBtc2cub3JkZXJUeXBlXG4gICAgICB9KVxuICAgIH0gZWxzZSBpZiAobXNnLm9yZGVyU3RhdHVzID09PSAnUEFSVElBTExZX0ZJTExFRCcpIHtcbiAgICAgIHNlbmQod3MsIFtcbiAgICAgICAgJ2RhdGEub3JkZXInLFxuICAgICAgICAnYmluYW5jZScsXG4gICAgICAgIEJpbmFuY2VFeGNoYW5nZUNvbm5lY3Rpb24udHJhbnNmb3JtT3JkZXIobXNnKVxuICAgICAgXSlcblxuICAgICAgbm90aWZ5U3VjY2Vzcyh3cywgX2ZsYXR0ZW4oW1xuICAgICAgICAnQmluYW5jZSBvcmRlciBwYXJ0aWFsbHkgZmlsbGVkIG9uJywgbXNnLnN5bWJvbCwgbXNnLnNpZGUsXG4gICAgICAgIF9pc0Zpbml0ZSgrbXNnLnByaWNlKSAmJiArbXNnLnByaWNlID4gMCAmJiBbXG4gICAgICAgICAgK21zZy5xdWFudGl0eSwgJ0AnLCBuZXcgQmlnTihtc2cucHJpY2UpLnRvU3RyaW5nKDEwKVxuICAgICAgICBdXG4gICAgICBdKS5maWx0ZXIodCA9PiAhIXQpLmpvaW4oJyAnKSlcbiAgICB9IGVsc2UgaWYgKG1zZy5vcmRlclN0YXR1cyA9PT0gJ05FVycpIHtcbiAgICAgIHNlbmQod3MsIFtcbiAgICAgICAgJ2RhdGEub3JkZXInLFxuICAgICAgICAnYmluYW5jZScsXG4gICAgICAgIEJpbmFuY2VFeGNoYW5nZUNvbm5lY3Rpb24udHJhbnNmb3JtT3JkZXIobXNnKVxuICAgICAgXSlcblxuICAgICAgbm90aWZ5U3VjY2Vzcyh3cywgX2ZsYXR0ZW4oW1xuICAgICAgICAnQmluYW5jZSBvcmRlciBjcmVhdGVkIG9uJywgbXNnLnN5bWJvbCwgbXNnLnNpZGUsXG4gICAgICAgIF9pc0Zpbml0ZSgrbXNnLnByaWNlKSAmJiArbXNnLnByaWNlID4gMCAmJiBbXG4gICAgICAgICAgK21zZy5xdWFudGl0eSwgJ0AnLCBuZXcgQmlnTihtc2cucHJpY2UpLnRvU3RyaW5nKDEwKVxuICAgICAgICBdXG4gICAgICBdKS5maWx0ZXIodCA9PiAhIXQpLmpvaW4oJyAnKSlcbiAgICB9IGVsc2UgaWYgKG1zZy5vcmRlclN0YXR1cyA9PT0gJ1JFSkVDVEVEJykge1xuICAgICAgY29uc3QgeyBvcmRlclJlamVjdFJlYXNvbiB9ID0gbXNnXG4gICAgICBjb25zdCBodW1hblJlYXNvbiA9IHJlamVjdFJlYXNvblRyYW5zZm9ybWVyKG9yZGVyUmVqZWN0UmVhc29uKVxuXG4gICAgICBub3RpZnlFcnJvcih3cywgX2ZsYXR0ZW4oW1xuICAgICAgICAnQmluYW5jZSBvcmRlciBjYW5jZWxsZWQgb24nLCBtc2cuc3ltYm9sLCBtc2cuc2lkZSxcbiAgICAgICAgX2lzRmluaXRlKCttc2cucHJpY2UpICYmICttc2cucHJpY2UgPiAwICYmIFtcbiAgICAgICAgICArbXNnLnF1YW50aXR5LCAnQCcsIG5ldyBCaWdOKG1zZy5wcmljZSkudG9TdHJpbmcoMTApXG4gICAgICAgIF0sIGA6ICR7aHVtYW5SZWFzb259YFxuICAgICAgXSkuZmlsdGVyKHQgPT4gISF0KS5qb2luKCcgJykpXG4gICAgfSBlbHNlIGlmIChtc2cub3JkZXJTdGF0dXMgPT09ICdDQU5DRUxFRCcpIHtcbiAgICAgIHNlbmQod3MsIFtcbiAgICAgICAgJ2RhdGEub3JkZXIuY2xvc2UnLFxuICAgICAgICAnYmluYW5jZScsXG4gICAgICAgIEJpbmFuY2VFeGNoYW5nZUNvbm5lY3Rpb24udHJhbnNmb3JtT3JkZXIobXNnKVxuICAgICAgXSlcblxuICAgICAgbm90aWZ5SW5mbyh3cywgX2ZsYXR0ZW4oW1xuICAgICAgICAnQmluYW5jZSBvcmRlciBjYW5jZWxsZWQgb24nLCBtc2cuc3ltYm9sLCBtc2cuc2lkZSxcbiAgICAgICAgX2lzRmluaXRlKCttc2cucHJpY2UpICYmICttc2cucHJpY2UgPiAwICYmIFtcbiAgICAgICAgICArbXNnLnF1YW50aXR5LCAnQCcsIG5ldyBCaWdOKG1zZy5wcmljZSkudG9TdHJpbmcoMTApXG4gICAgICAgIF1cbiAgICAgIF0pLmZpbHRlcih0ID0+ICEhdCkuam9pbignICcpKVxuICAgIH1cbiAgfSlcblxuICBzZW5kQmFsYW5jZXMod3MsICdiaW5hbmNlJywgY2xpZW50KS5jYXRjaCgoZSkgPT4ge1xuICAgIGNhcHR1cmUuZXhjZXB0aW9uKGUpXG4gICAgc2VuZEVycm9yKHdzLCBgRmFpbGVkIHRvIHVwZGF0ZSBCaW5hbmNlIGJhbGFuY2VzOiAke2UubWVzc2FnZX1gKVxuICB9KVxuXG4gIHNlbmRPcmRlcnMod3MsICdiaW5hbmNlJywgY2xpZW50KS5jYXRjaCgoZSkgPT4ge1xuICAgIGNhcHR1cmUuZXhjZXB0aW9uKGUpXG4gICAgc2VuZEVycm9yKHdzLCBgRmFpbGVkIHRvIHVwZGF0ZSBCaW5hbmNlIG9yZGVyczogJHtlLm1lc3NhZ2V9YClcbiAgfSlcblxuICByZXR1cm4gY2xpZW50XG59XG4iXX0=