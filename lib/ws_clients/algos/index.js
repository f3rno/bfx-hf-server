'use strict';

const Bluebird = require('bluebird');
const { nonce } = require('bfx-api-node-util');
const WSClient = require('../../ws_client');

const onUnknownMessage = require('./handlers/on_unknown_message');
const onError = require('./handlers/on_error');
const onStartedAO = require('./handlers/on_started_ao');
const onStoppedAO = require('./handlers/on_stopped_ao');
const onRefusingHostClose = require('./handlers/on_refusing_host_close');
const onHostClosed = require('./handlers/on_host_closed');
const onHostOpened = require('./handlers/on_host_opened');
const onIdentified = require('./handlers/on_identified');
const onStatus = require('./handlers/on_status');
const onDataAOs = require('./handlers/on_data_aos');
const onIsOpenResponse = require('./handlers/on_is_open_res');

const RECONNECT_INTERVAL_MS = 5 * 1000;

module.exports = class AlgosServerClient extends WSClient {
  constructor({ url }) {
    super({
      url,
      debugName: 'algos',
      reconnectIntervalMS: RECONNECT_INTERVAL_MS,
      msgHandlers: {
        _: onUnknownMessage,

        error: onError,
        started: onStartedAO,
        stopped: onStoppedAO,
        persisting: onRefusingHostClose,
        closed: onHostClosed,
        opened: onHostOpened,
        identified: onIdentified,
        status: onStatus,
        'data.aos': onDataAOs,
        'is.open.res': onIsOpenResponse } });



    this.isOpenCallbacks = {}; // see isHostOpen()
  }

  identify(ws, userID) {
    this.userID = userID;
    this.userWS = ws;

    this.d('identifying...');
    this.send(['identify', userID]);
  }

  reconnect() {
    this.send(['reconnect']);
  }

  closeHost(exID) {
    if (!this.userID) {
      return this.d('refusing to close host %s, not identified', exID);
    }

    this.send(['close', this.userID, exID]);
  }

  openHost(exID, apiKey, apiSecret) {
    if (!this.userID) {
      return this.d('refusing to open host %s, not identified', exID);
    }

    this.send(['open', this.userID, exID, apiKey, apiSecret]);
  }

  async isHostOpen(exID) {
    return new Bluebird(resolve => {
      const reqID = `${nonce()}`;
      this.isOpenCallbacks[reqID] = resolve;

      this.send(['is.open', this.userID, exID, reqID]);
    });
  }

  startAO(exID, aoID, packet) {
    if (!this.userID) {
      return this.d('refusing to open host %s, not identified', exID);
    }

    this.send(['submit', this.userID, exID, aoID, packet]);
  }

  stopAO(exID, gid) {
    if (!this.userID) {
      return this.d('refusing to open host %s, not identified', exID);
    }

    this.send(['cancel', this.userID, exID, gid]);
  }};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy93c19jbGllbnRzL2FsZ29zL2luZGV4LmpzIl0sIm5hbWVzIjpbIkJsdWViaXJkIiwicmVxdWlyZSIsIm5vbmNlIiwiV1NDbGllbnQiLCJvblVua25vd25NZXNzYWdlIiwib25FcnJvciIsIm9uU3RhcnRlZEFPIiwib25TdG9wcGVkQU8iLCJvblJlZnVzaW5nSG9zdENsb3NlIiwib25Ib3N0Q2xvc2VkIiwib25Ib3N0T3BlbmVkIiwib25JZGVudGlmaWVkIiwib25TdGF0dXMiLCJvbkRhdGFBT3MiLCJvbklzT3BlblJlc3BvbnNlIiwiUkVDT05ORUNUX0lOVEVSVkFMX01TIiwibW9kdWxlIiwiZXhwb3J0cyIsIkFsZ29zU2VydmVyQ2xpZW50IiwiY29uc3RydWN0b3IiLCJ1cmwiLCJkZWJ1Z05hbWUiLCJyZWNvbm5lY3RJbnRlcnZhbE1TIiwibXNnSGFuZGxlcnMiLCJfIiwiZXJyb3IiLCJzdGFydGVkIiwic3RvcHBlZCIsInBlcnNpc3RpbmciLCJjbG9zZWQiLCJvcGVuZWQiLCJpZGVudGlmaWVkIiwic3RhdHVzIiwiaXNPcGVuQ2FsbGJhY2tzIiwiaWRlbnRpZnkiLCJ3cyIsInVzZXJJRCIsInVzZXJXUyIsImQiLCJzZW5kIiwicmVjb25uZWN0IiwiY2xvc2VIb3N0IiwiZXhJRCIsIm9wZW5Ib3N0IiwiYXBpS2V5IiwiYXBpU2VjcmV0IiwiaXNIb3N0T3BlbiIsInJlc29sdmUiLCJyZXFJRCIsInN0YXJ0QU8iLCJhb0lEIiwicGFja2V0Iiwic3RvcEFPIiwiZ2lkIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQSxNQUFNQSxRQUFRLEdBQUdDLE9BQU8sQ0FBQyxVQUFELENBQXhCO0FBQ0EsTUFBTSxFQUFFQyxLQUFGLEtBQVlELE9BQU8sQ0FBQyxtQkFBRCxDQUF6QjtBQUNBLE1BQU1FLFFBQVEsR0FBR0YsT0FBTyxDQUFDLGlCQUFELENBQXhCOztBQUVBLE1BQU1HLGdCQUFnQixHQUFHSCxPQUFPLENBQUMsK0JBQUQsQ0FBaEM7QUFD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Q0FBYytDLE9BQUQsSUFBYTtBQUMvQixZQUFNQyxLQUFLLEdBQUksR0FBRTlDLEtBQUssRUFBRyxFQUF6QjtBQUNBLFdBQUsrQixlQUFMLENBQXFCZSxLQUFyQixJQUE4QkQsT0FBOUI7O0FBRUEsV0FBS1IsSUFBTCxDQUFVLENBQUMsU0FBRCxFQUFZLEtBQUtILE1BQWpCLEVBQXlCTSxJQUF6QixFQUErQk0sS0FBL0IsQ0FBVjtBQUNELEtBTE0sQ0FBUDtBQU1EOztBQUVEQyxFQUFBQSxPQUFPLENBQUVQLElBQUYsRUFBUVEsSUFBUixFQUFjQyxNQUFkLEVBQXNCO0FBQzNCLFFBQUksQ0FBQyxLQUFLZixNQUFWLEVBQWtCO0FBQ2hCLGFBQU8sS0FBS0UsQ0FBTCxDQUFPLDBDQUFQLEVBQW1ESSxJQUFuRCxDQUFQO0FBQ0Q7O0FBRUQsU0FBS0gsSUFBTCxDQUFVLENBQUMsUUFBRCxFQUFXLEtBQUtILE1BQWhCLEVBQXdCTSxJQUF4QixFQUE4QlEsSUFBOUIsRUFBb0NDLE1BQXBDLENBQVY7QUFDRDs7QUFFREMsRUFBQUEsTUFBTSxDQUFFVixJQUFGLEVBQVFXLEdBQVIsRUFBYTtBQUNqQixRQUFJLENBQUMsS0FBS2pCLE1BQVYsRUFBa0I7QUFDaEIsYUFBTyxLQUFLRSxDQUFMLENBQU8sMENBQVAsRUFBbURJLElBQW5ELENBQVA7QUFDRDs7QUFFRCxTQUFLSCxJQUFMLENBQVUsQ0FBQyxRQUFELEVBQVcsS0FBS0gsTUFBaEIsRUFBd0JNLElBQXhCLEVBQThCVyxHQUE5QixDQUFWO0FBQ0QsR0E1RXVELENBQTFEIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnXG5cbmNvbnN0IEJsdWViaXJkID0gcmVxdWlyZSgnYmx1ZWJpcmQnKVxuY29uc3QgeyBub25jZSB9ID0gcmVxdWlyZSgnYmZ4LWFwaS1ub2RlLXV0aWwnKVxuY29uc3QgV1NDbGllbnQgPSByZXF1aXJlKCcuLi8uLi93c19jbGllbnQnKVxuXG5jb25zdCBvblVua25vd25NZXNzYWdlID0gcmVxdWlyZSgnLi9oYW5kbGVycy9vbl91bmtub3duX21lc3NhZ2UnKVxuY29uc3Qgb25FcnJvciA9IHJlcXVpcmUoJy4vaGFuZGxlcnMvb25fZXJyb3InKVxuY29uc3Qgb25TdGFydGVkQU8gPSByZXF1aXJlKCcuL2hhbmRsZXJzL29uX3N0YXJ0ZWRfYW8nKVxuY29uc3Qgb25TdG9wcGVkQU8gPSByZXF1aXJlKCcuL2hhbmRsZXJzL29uX3N0b3BwZWRfYW8nKVxuY29uc3Qgb25SZWZ1c2luZ0hvc3RDbG9zZSA9IHJlcXVpcmUoJy4vaGFuZGxlcnMvb25fcmVmdXNpbmdfaG9zdF9jbG9zZScpXG5jb25zdCBvbkhvc3RDbG9zZWQgPSByZXF1aXJlKCcuL2hhbmRsZXJzL29uX2hvc3RfY2xvc2VkJylcbmNvbnN0IG9uSG9zdE9wZW5lZCA9IHJlcXVpcmUoJy4vaGFuZGxlcnMvb25faG9zdF9vcGVuZWQnKVxuY29uc3Qgb25JZGVudGlmaWVkID0gcmVxdWlyZSgnLi9oYW5kbGVycy9vbl9pZGVudGlmaWVkJylcbmNvbnN0IG9uU3RhdHVzID0gcmVxdWlyZSgnLi9oYW5kbGVycy9vbl9zdGF0dXMnKVxuY29uc3Qgb25EYXRhQU9zID0gcmVxdWlyZSgnLi9oYW5kbGVycy9vbl9kYXRhX2FvcycpXG5jb25zdCBvbklzT3BlblJlc3BvbnNlID0gcmVxdWlyZSgnLi9oYW5kbGVycy9vbl9pc19vcGVuX3JlcycpXG5cbmNvbnN0IFJFQ09OTkVDVF9JTlRFUlZBTF9NUyA9IDUgKiAxMDAwXG5cbm1vZHVsZS5leHBvcnRzID0gY2xhc3MgQWxnb3NTZXJ2ZXJDbGllbnQgZXh0ZW5kcyBXU0NsaWVudCB7XG4gIGNvbnN0cnVjdG9yICh7IHVybCB9KSB7XG4gICAgc3VwZXIoe1xuICAgICAgdXJsLFxuICAgICAgZGVidWdOYW1lOiAnYWxnb3MnLFxuICAgICAgcmVjb25uZWN0SW50ZXJ2YWxNUzogUkVDT05ORUNUX0lOVEVSVkFMX01TLFxuICAgICAgbXNnSGFuZGxlcnM6IHtcbiAgICAgICAgXzogb25Vbmtub3duTWVzc2FnZSxcblxuICAgICAgICBlcnJvcjogb25FcnJvcixcbiAgICAgICAgc3RhcnRlZDogb25TdGFydGVkQU8sXG4gICAgICAgIHN0b3BwZWQ6IG9uU3RvcHBlZEFPLFxuICAgICAgICBwZXJzaXN0aW5nOiBvblJlZnVzaW5nSG9zdENsb3NlLFxuICAgICAgICBjbG9zZWQ6IG9uSG9zdENsb3NlZCxcbiAgICAgICAgb3BlbmVkOiBvbkhvc3RPcGVuZWQsXG4gICAgICAgIGlkZW50aWZpZWQ6IG9uSWRlbnRpZmllZCxcbiAgICAgICAgc3RhdHVzOiBvblN0YXR1cyxcbiAgICAgICAgJ2RhdGEuYW9zJzogb25EYXRhQU9zLFxuICAgICAgICAnaXMub3Blbi5yZXMnOiBvbklzT3BlblJlc3BvbnNlXG4gICAgICB9XG4gICAgfSlcblxuICAgIHRoaXMuaXNPcGVuQ2FsbGJhY2tzID0ge30gLy8gc2VlIGlzSG9zdE9wZW4oKVxuICB9XG5cbiAgaWRlbnRpZnkgKHdzLCB1c2VySUQpIHtcbiAgICB0aGlzLnVzZXJJRCA9IHVzZXJJRFxuICAgIHRoaXMudXNlcldTID0gd3NcblxuICAgIHRoaXMuZCgnaWRlbnRpZnlpbmcuLi4nKVxuICAgIHRoaXMuc2VuZChbJ2lkZW50aWZ5JywgdXNlcklEXSlcbiAgfVxuXG4gIHJlY29ubmVjdCAoKSB7XG4gICAgdGhpcy5zZW5kKFsncmVjb25uZWN0J10pXG4gIH1cblxuICBjbG9zZUhvc3QgKGV4SUQpIHtcbiAgICBpZiAoIXRoaXMudXNlcklEKSB7XG4gICAgICByZXR1cm4gdGhpcy5kKCdyZWZ1c2luZyB0byBjbG9zZSBob3N0ICVzLCBub3QgaWRlbnRpZmllZCcsIGV4SUQpXG4gICAgfVxuXG4gICAgdGhpcy5zZW5kKFsnY2xvc2UnLCB0aGlzLnVzZXJJRCwgZXhJRF0pXG4gIH1cblxuICBvcGVuSG9zdCAoZXhJRCwgYXBpS2V5LCBhcGlTZWNyZXQpIHtcbiAgICBpZiAoIXRoaXMudXNlcklEKSB7XG4gICAgICByZXR1cm4gdGhpcy5kKCdyZWZ1c2luZyB0byBvcGVuIGhvc3QgJXMsIG5vdCBpZGVudGlmaWVkJywgZXhJRClcbiAgICB9XG5cbiAgICB0aGlzLnNlbmQoWydvcGVuJywgdGhpcy51c2VySUQsIGV4SUQsIGFwaUtleSwgYXBpU2VjcmV0XSlcbiAgfVxuXG4gIGFzeW5jIGlzSG9zdE9wZW4gKGV4SUQpIHtcbiAgICByZXR1cm4gbmV3IEJsdWViaXJkKChyZXNvbHZlKSA9PiB7XG4gICAgICBjb25zdCByZXFJRCA9IGAke25vbmNlKCl9YFxuICAgICAgdGhpcy5pc09wZW5DYWxsYmFja3NbcmVxSURdID0gcmVzb2x2ZVxuXG4gICAgICB0aGlzLnNlbmQoWydpcy5vcGVuJywgdGhpcy51c2VySUQsIGV4SUQsIHJlcUlEXSlcbiAgICB9KVxuICB9XG5cbiAgc3RhcnRBTyAoZXhJRCwgYW9JRCwgcGFja2V0KSB7XG4gICAgaWYgKCF0aGlzLnVzZXJJRCkge1xuICAgICAgcmV0dXJuIHRoaXMuZCgncmVmdXNpbmcgdG8gb3BlbiBob3N0ICVzLCBub3QgaWRlbnRpZmllZCcsIGV4SUQpXG4gICAgfVxuXG4gICAgdGhpcy5zZW5kKFsnc3VibWl0JywgdGhpcy51c2VySUQsIGV4SUQsIGFvSUQsIHBhY2tldF0pXG4gIH1cblxuICBzdG9wQU8gKGV4SUQsIGdpZCkge1xuICAgIGlmICghdGhpcy51c2VySUQpIHtcbiAgICAgIHJldHVybiB0aGlzLmQoJ3JlZnVzaW5nIHRvIG9wZW4gaG9zdCAlcywgbm90IGlkZW50aWZpZWQnLCBleElEKVxuICAgIH1cblxuICAgIHRoaXMuc2VuZChbJ2NhbmNlbCcsIHRoaXMudXNlcklELCBleElELCBnaWRdKVxuICB9XG59XG4iXX0=